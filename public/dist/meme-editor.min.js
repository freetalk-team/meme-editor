!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.MemeEditor=e():t.MemeEditor=e()}(self,(()=>(()=>{var t={546:()=>{Object.isClass=function(t){return t&&"object"==typeof t&&!Array.isArray(t)&&t.constructor!==Object},Object.clone=function(t){var e=t instanceof Array?[]:{};for(let s in t)t[s]&&"object"==typeof t[s]?e[s]=ArrayBuffer.isView(t[s])?new t[s].constructor(t[s]):Object.clone(t[s]):e[s]=t[s];return e},Object.getGetters=function(t,e){let s={},i=Object.getPrototypeOf(t);for(;i&&i!==Object.prototype;){const t=Object.getOwnPropertyDescriptors(i);for(const[e,i]of Object.entries(t))"function"!=typeof i.get||e in s||(s[e]=i.get);i=Object.getPrototypeOf(i)}return s},Object.getSetters=function(t){let e={},s=Object.getPrototypeOf(t);for(;s&&s!==Object.prototype;){const t=Object.getOwnPropertyDescriptors(s);for(const[s,i]of Object.entries(t))"function"!=typeof i.set||s in e||(e[s]=i.set);s=Object.getPrototypeOf(s)}return e},Object.getProperties=function(t){const e={},s={};let i=Object.getPrototypeOf(t);for(;i&&i!==Object.prototype;)Object.getOwnProperties(i,e,s),i=Object.getPrototypeOf(i);return{setters:e,getters:s}},Object.getOwnProperties=function(t,e={},s={}){const i=Object.getOwnPropertyDescriptors(t);for(const[t,r]of Object.entries(i))"function"!=typeof r.get||t in s||(s[t]=r.get),"function"!=typeof r.set||t in e||(e[t]=r.set);return{setters:e,getters:s}},Object.getGetter=function(t,e){return Object.getGetters(t)[e]},Object.getSetter=function(t,e){return Object.getSetters(t)[e]},Object.getProperty=function(t,e){const{setters:s,getters:i}=Object.getProperties(t);return{setter:s[e],getter:i[e]}},Object.fromInstance=function(t,e,s={}){const i=Object.getGetters(t,e);let r;for(const[o,n]of Object.entries(i))r=n.call(t),null!=r&&(Array.isArray(r)?r=r.map((t=>Object.isClass(t)?Object.fromInstance(t):t)):"object"==typeof r&&r instanceof e&&(r=Object.fromInstance(r))),s[o]=r;return s},Object.instanceFrom=function(t,e){const s=Object.getSetters(t);for(const[i,r]of Object.entries(s))i in e&&r.call(t,e[i]);return t},Object.hashHex=function(t){return Object.hash(t).toString(16)},Array.repeat=function(t,e=0){return new Array(t).fill(0)},Array.prototype.last=function(){return this[this.length-1]},String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.toArrayBuffer=function(){return(new TextEncoder).encode(this)},dom.disable=function(t,e){t.disabled=!0,isPromise(e)&&e.finally((()=>t.disabled=!1))}}},s={};function i(e){var r=s[e];if(void 0!==r)return r.exports;var o=s[e]={exports:{}};return t[e](o,o.exports,i),o.exports}i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var r={};return(()=>{"use strict";i.d(r,{default:()=>Kt}),i(546);class t{static ID=1;#t;#e;#s=0;#i=0;#r=50;#o=50;#n=0;#h="#000000";#a=1;#l="#eeeeee";#c="ff";#d;#u="#444444";#g=2;#p=!1;#f=!0;constructor(e){e?"object"==typeof e&&(e=e.id):e=Date.now().toString(16),this.#t=e,this.#e=this.type+" "+t.ID++}get id(){return this.#t}get name(){return this.#e}get x(){return this.#r}get y(){return this.#o}get width(){return this.#s}get height(){return this.#i}get angle(){return this.#n}get stroke(){return this.#h}get strokeWidth(){return this.#a}get fill(){return this.#l}get alpha(){return parseInt(this.#c,16)/255}get shadow(){return this.#d}get shadowWidth(){return this.#g}get shadowColor(){return this.#u}get visible(){return this.#f}set id(t){this.#t=t}set name(t){this.#e=t}set x(t){"string"==typeof t&&(t=parseInt(t)),this.#r=t}set y(t){"string"==typeof t&&(t=parseInt(t)),this.#o=t}set width(t){"string"==typeof t&&(t=parseInt(t))<10&&(t=10),this.#s=t}set height(t){"string"==typeof t&&(t=parseInt(t))<10&&(t=10),this.#i=t}set stroke(t){this.#h=t}set strokeWidth(t){"string"==typeof t&&(t=parseInt(t)),this.#a=t}set fill(t){this.#l=t}set alpha(t){"string"==typeof t&&(t=parseFloat(t));const e=Math.round(255*t);this.#c=(e<16?"0":"")+e.toString(16)}set shadow(t){this.#d=t}set shadowWidth(t){"string"==typeof t&&(t=parseInt(t)),this.#g=t}set shadowColor(t){this.#u=t}set selected(t){this.#p=t}set visible(t){"toggle"==t?this.toggleVisible():this.#f=t}set angle(t){"string"==typeof t&&(t=parseFloat(t));const e=Math.PI,s=[0,e/4,e/2,3*e/4,e,5*e/4,3*e/2,7*e/4];for(const e of s)if(t>e-.1&&t<e+.1){t=e;break}this.#n=t}set properties(e){const s=Object.fromInstance(this,t);e.assign(s)}fillColor(){return this.#l+this.#c}fillShadowColor(){return this.#u+this.#c}alphaHex(){return this.#c}isSelected(){return this.#p}toggleVisible(){this.#f=!this.#f}center(t={x:0,y:0}){return this.box(0,t).center()}box(t=0,e={x:0,y:0}){return{x:this.#r+t-e.x,y:this.#o+t-e.y,width:this.#s-2*t,height:this.#i-2*t,angle:this.angle*(180/Math.PI),center(){return[this.x+this.width/2,this.y+this.height/2]}}}rotate(t,e,s=this.box()){const[i,r]=s.center(),o=Math.cos(this.#n),n=Math.sin(this.#n),h=t-i,a=e-r;return[h*o-a*n+i,h*n+a*o+r]}getFill(){return this.#l?{color:this.#l,alpha:this.alpha}:null}getStroke(t={}){return this.#h?Object.assign({color:this.#h,width:this.#a},t):null}getShadow(){return this.#d?{color:this.#u,width:this.#g}:null}boundingBox(t=0){const e=this.box();if(0==this.#n)return e;const s=[this.rotate(this.#r,this.#o,e),this.rotate(this.#r+this.#s,this.#o,e),this.rotate(this.#r,this.#o+this.#i,e),this.rotate(this.#r+this.#s,this.#o+this.#i,e)],i=Math.min(s[0][0],s[1][0],s[2][0],s[3][0]),r=Math.max(s[0][0],s[1][0],s[2][0],s[3][0]),o=Math.min(s[0][1],s[1][1],s[2][1],s[3][1]),n=Math.max(s[0][1],s[1][1],s[2][1],s[3][1]);return e.x=i+t,e.y=o+t,e.width=r-i-2*t,e.height=n-o-2*t,e}save(){return Object.fromInstance(this,t)}load(t){Object.instanceFrom(this,t)}clone(){const t=this.save(),e=new this.__proto__.constructor(this),s=Date.now().toString(16),i=this.name+" copy";return e.load(t),e.id=s,e.name=i,e}draw(){}drawSVG(){}drawSelection(t,e){t.save();const{x:s,y:i}=this.setGeometry(t);t.lineWidth=1,this.drawNode(t,0,0),this.drawNode(t,-s,-i),t.restore()}drawLine(e,s,i,r=this.#r,o=this.#o,n=this.#d){n&&this.#g>0&&(e.save(),this.addShadow(e),e.beginPath(),e.moveTo(r,o),e.lineTo(s,i),e.stroke(),e.restore()),t.drawLine(e,r,o,s,i,this.#h,this.#a)}drawLineShadow(t,e,s,i=this.#r,r=this.#o){this.#d&&(t.save(),t.strokeStyle=this.#h,t.lineWidth=this.#a,this.addShadow(t),t.beginPath(),t.moveTo(i,r),t.lineTo(e,s),t.stroke(),t.restore())}drawPath(t,e,s=!0,i=this.#n){t.save(),s&&this.setGeometry(t,i),t.fillStyle=this.fillColor(),this.#g>0&&(t.save(),this.addShadow(t),"fill"==this.#d?t.fill(e):"stroke"==this.#d&&t.stroke(e),t.restore()),this.#l&&t.fill(e),this.strokePath(t,e),t.restore()}fillPath(t,e,s=!0,i=this.#n){t.save(),s&&this.setGeometry(t,i),t.fillStyle=this.fillColor(),this.#d&&this.#g>0&&(t.save(),this.addShadow(t),t.fill(e),t.restore()),t.fill(e),t.restore()}strokePath(t,e,s=!1,i=this.#n){this.#h&&this.#a>0&&(t.save(),s&&this.setGeometry(t,i),t.strokeStyle=this.#h,t.lineWidth=this.#a,t.lineCap="round",t.lineJoin="round",t.stroke(e),t.restore())}drawRectangle(t){t.save();const{x:e,y:s}=this.setGeometry(t);this.#d&&(t.save(),this.addShadow(t),t.fillStyle=this.fillColor(),t.strokeStyle=this.#h,"fill"==this.#d?t.fillRect(e,s,this.#s,this.#i):"stroke"==this.#d&&t.strokeRect(e,s,this.#s,this.#i),t.restore()),this.#l&&(t.save(),t.fillStyle=this.fillColor(),t.fillRect(e,s,this.#s,this.#i),t.restore()),this.#h&&this.#a>0&&(t.save(),t.strokeStyle=this.#h,t.lineWidth=this.#a,t.strokeRect(e,s,this.#s,this.#i),t.restore()),t.restore()}drawRoundRectangle(t,e=5){t.save();const{x:s,y:i}=this.setGeometry(t);this.#d&&(t.save(),this.addShadow(t),t.fillStyle=this.fillColor(),t.strokeStyle=this.#h,t.beginPath(),t.roundRect(s,i,this.#s,this.#i,e),"fill"==this.#d?t.fill():"stroke"==this.#d&&t.stroke(),t.restore()),this.#l&&(t.save(),t.fillStyle=this.fillColor(),t.beginPath(),t.roundRect(s,i,this.#s,this.#i,e),t.fill(),t.restore()),this.#h&&this.#a>0&&(t.save(),t.strokeStyle=this.#h,t.lineWidth=this.#a,t.beginPath(),t.roundRect(s,i,this.#s,this.#i,e),t.stroke(),t.restore()),t.restore()}drawEllipse(t){t.save();const{w:e,h:s}=this.setGeometry(t),i=e,r=s;this.#d&&(t.save(),this.addShadow(t),t.fillStyle=this.fillColor(),t.strokeStyle=this.#h,t.beginPath(),t.ellipse(0,0,i,r,0,0,2*Math.PI),"fill"==this.#d?t.fill():"stroke"==this.#d&&t.stroke(),t.restore()),this.#l&&(t.save(),t.fillStyle=this.fillColor(),t.beginPath(),t.ellipse(0,0,i,r,0,0,2*Math.PI),t.fill(),t.restore()),this.#h&&this.#a>0&&(t.save(),t.strokeStyle=this.#h,t.lineWidth=this.#a,t.beginPath(),t.ellipse(0,0,i,r,0,0,2*Math.PI),t.stroke(),t.restore()),t.restore()}drawText(t,e,s={size:30,font:"Airal"}){e=e.split("\n").map((t=>t.trim())),t.save();let{x:i,y:r}=this.setGeometry(t);t.textBaseline=s.baseline||"top",t.textAlign=s.align||"left",t.font=(s.bold?"bold ":"")+(s.italic?"italic ":"")+`${s.size}px `+s.font,t.fillStyle=this.fillColor(),t.strokeStyle=this.#h,t.lineWidth=this.#a;const o=1.2*t.measureText("M").width;for(const s of e)this.#d&&this.#g>0&&(t.save(),this.addShadow(t),"fill"==this.shadow?t.fillText(s,i,r):"stroke"==this.shadow&&this.strokeWidth>0&&t.strokeText(s,i,r),t.restore()),this.#l&&t.fillText(s,i,r),this.strokeWidth>0&&t.strokeText(s,i,r),r+=o;t.restore()}setGeometry(t,e=this.#n){const[s,i]=this.center();t.translate(s,i),e&&t.rotate(e);const r=this.#s/2,o=this.#i/2;return{x:-r,y:-o,w:r,h:o}}getGeometry(t,e){const[s,i]=this.center(),r=this.#n;let o=t-s,n=e-i;if(r){const t=Math.cos(-r),e=Math.sin(-r),s=o*e+n*t;o=o*t-n*e,n=s}return{X:s,Y:i,ox:o,oy:n,angle:r}}addShadow(t){t.shadowColor=this.#u+this.#c,t.shadowBlur=5,t.shadowOffsetX=this.#g,t.shadowOffsetY=this.#g}drawBorder(t,e=1,s="#000",i=0,r=!1){"number"==typeof i&&(i=[i,i]),t.save();let{x:o,y:n}=this.setGeometry(t);const h=this.#s-2*i[0],a=this.#i-2*i[1];o+=i[0],n+=i[1],r&&t.setLineDash([10,5]),t.strokeStyle=s,t.lineWidth=e,t.strokeRect(o,n,h,a),t.restore()}drawNode(...e){t.drawNode(...e)}release(){}getNodes(){return[]}handleClick(t,e){const{X:s,Y:i,ox:r,oy:o,angle:n}=this.getGeometry(t,e);return this.inNode(t,e,s,i)?{move:(t,e)=>this.updatePos(t,e)}:this.inNode(r,o,this.width/2,this.height/2)?{move:(t,e)=>{if(t-=s,e-=i,n){const s=Math.cos(-n),i=Math.sin(-n),r=t*i+e*s;t=t*s-e*i,e=r}this.updateSize(t+s,e+i)}}:null}handleSelect(t,e,s){const i=this.x,r=i+this.width,o=this.y,n=o+this.height;return t>i&&t<r&&e>o&&e<n?(this.#p=!0,this):(s||(this.#p=!1),null)}inNode(...e){return t.inNode(...e)}updatePos(t,e){this.x=Math.round(t-this.width/2),this.y=Math.round(e-this.height/2)}updateSize(t,e){this.width=Math.round(t-this.#r),this.height=Math.round(e-this.#o)}snap(t,e){const[s,i]=this.center(),r=this.#r+this.#s,o=this.#o+this.#i,n=[[s,i],[s,e],[t,i],[this.#r,this.#o],[this.#r,i],[this.#r,o],[s,this.#o],[s,o],[r,this.#o],[r,i],[r,o],[t,this.#o],[this.#r,e],[t,o],[r,e]];for(const s of n)if(this.inNode(t,e,s[0],s[1]))return[s[0],s[1]]}static drawLine(t,e,s,i,r,o="#111111",n=1){t.save(),t.strokeStyle=o,t.lineWidth=n,t.beginPath(),t.moveTo(e,s),t.lineTo(i,r),t.stroke(),t.restore()}static drawNode(t,e,s,i="#00f",r=!1,o=5){t.save(),t.strokeStyle=i,t.lineWidth=1,t.beginPath(),t.arc(e,s,o,0,2*Math.PI),t.closePath(),r&&(t.fillStyle="boolean"==typeof r?i:r,t.fill()),t.stroke(),t.restore()}static inNode(t,e,s,i){return t>s-5&&t<s+5&&e>i-5&&e<i+5}}class s extends t{get type(){return"canvas"}constructor(){super("canvas"),this.x=0,this.y=0,this.width=0,this.height=0,this.stroke=null,this.fill="#fafafa"}handleClick(){}handleSelect(){}draw(t){this.drawRectangle(t)}}class o{x;y;constructor(t,e){this.x=t,this.y=e}isLine(){return!0}controlPoint(){return this}toCurve(){return new n(this.x,this.y)}clone(){return new o(this.x,this.y)}draw(t){t.lineTo(this.x,this.y)}move(t,e){this.x+=t,this.y+=e}set(t,e){this.x=t,this.y=e}invert(t,e){const s=2*t-this.x,i=2*e-this.y;this.set(s,i)}tangent(t,e){}split(t,e=.5){const s=a(t,this),i=new o(this.x,this.y);return this.set(s.x,s.y),i}moveTangent(){}moveNode(t,e){this.x+=t,this.y+=e}toArray(){return[this.x,this.y]}toSVG(t=0,e=0){return`L${this.x+t},${this.y+e}`}scale(t,e,s=0,i=0){const r=this.clone();return o.scale(r,t,e,s,i),r}static create(t,e){const s=new o;return s.x=t,s.y=e,s}static scale(t,e,s,i=0,r=0){const o=(t.x-i)*e,n=(t.y-r)*s;t.set(o,n)}}class n extends o{cp=new o;constructor(t,e){super(t,e),this.cp.set(t,e)}isLine(){return!1}toArray(){return[this.cp.x,this.cp.y,this.x,this.y]}toSVG(t=0,e=0){return`Q${this.cp.x+t},${this.cp.y+e},${this.x+t},${this.y+e}`}clone(){const t=new n(this.x,this.y);return t.cp.set(this.cp.x,this.cp.y),t}controlPoint(){return this.cp}setControlPoint(t,e){this.cp.set(t,e)}toCurve(t,e){const s=new h(this.x,this.y);return s.cp.set(t+2/3*(this.cp.x-t),e+2/3*(this.cp.y-e)),s.cp2.set(this.x+2/3*(this.cp.x-this.x),this.y+2/3*(this.cp.y-this.y)),s}draw(t){t.quadraticCurveTo(this.cp.x,this.cp.y,this.x,this.y)}move(t,e){super.move(t,e),this.cp.x+=t,this.cp.y+=e}moveTangent(t,e){this.cp.x+=t,this.cp.y+=e}tangent(t,e){const s=2*this.x-t,i=2*this.y-e;this.cp.set(s,i)}extrema(t){const e=this.cp,s=this;function i(t,e){return 0===t?[]:[-e/t].filter((t=>t>=0&&t<=1))}const r=[];for(const[o,n,h]of[[t.x,e.x,s.x],[t.y,e.y,s.y]]){const t=o-2*n+h,e=-2*(o-n);r.push(...i(t,e))}return r}evaluate(t,e){const s=this.cp,i=1-e;return new o(i**2*t.x+2*i*e*s.x+e**2*this.x,i**2*t.y+2*i*e*s.y+e**2*this.y)}scale(t,e,s=0,i=0){const r=this.clone();return o.scale(r,t,e,s,i),o.scale(r.cp,t,e,s,i),r}}class h extends n{cp2=new o;toArray(){return[this.cp.x,this.cp.y,this.cp2.x,this.cp2.y,this.x,this.y]}toSVG(t=0,e=0){return`C${this.cp.x+t},${this.cp.y+e},${this.cp2.x+t},${this.cp2.y+e},${this.x+t},${this.y+e}`}clone(){const t=new h(this.x,this.y);return t.cp.set(this.cp.x,this.cp.y),t.cp2.set(this.cp2.x,this.cp2.y),t}controlPoint(){return this.cp2}toCurve(){return this}draw(t){t.bezierCurveTo(this.cp.x,this.cp.y,this.cp2.x,this.cp2.y,this.x,this.y)}tangent(t,e){const s=2*this.x-t,i=2*this.y-e;this.cp2.set(s,i)}move(t,e){super.move(t,e),this.cp2.x+=t,this.cp2.y+=e}moveNode(t,e){super.moveNode(t,e),this.cp2.x+=t,this.cp2.y+=e}split(t,e=.5){const s=a(t,this.cp,e),i=a(this.cp,this.cp2,e),r=a(this.cp2,this,e),o=a(s,i,e),n=a(i,r,e),l=a(o,n,e),c=new h(this.x,this.y);return c.cp=n,c.cp2=r,this.cp.set(s.x,s.y),this.cp2.set(o.x,o.y),this.set(l.x,l.y),c}extrema(t){const e=this.cp,s=this.cp2,i=this;function r(t,e,s){const i=e*e-4*t*s;if(i<0)return[];if(0===i)return[-e/(2*t)];const r=Math.sqrt(i);return[(-e+r)/(2*t),(-e-r)/(2*t)]}const o=[];for(const[n,h,a,l]of[[t.x,e.x,s.x,i.x],[t.y,e.y,s.y,i.y]]){const t=-3*n+9*h-9*a+3*l,e=6*n-12*h+6*a,s=-3*n+3*h;o.push(...r(t,e,s).filter((t=>t>=0&&t<=1)))}return o}evaluate(t,e){const s=this.cp,i=this.cp2,r=1-e;return new o(r**3*t.x+3*r**2*e*s.x+3*r*e**2*i.x+e**3*this.x,r**3*t.y+3*r**2*e*s.y+3*r*e**2*i.y+e**3*this.y)}scale(t,e,s=0,i=0){const r=this.clone();return o.scale(r,t,e,s,i),o.scale(r.cp,t,e,s,i),o.scale(r.cp2,t,e,s,i),r}}function a(t,e,s){return new o((1-s)*t.x+s*e.x,(1-s)*t.y+s*e.y)}class l extends t{get type(){return"path"}#m=[];#x=!1;#w=!1;#y;#b;#v;#k;get closed(){return this.#w}set closed(t){this.#w=!!t}get segments(){return this.#m.map((t=>t.toArray()))}set segments(t){let e,s=[];for(const i of t)6==i.length?(e=new h,e.cp.set(i[0],i[1]),e.cp2.set(i[2],i[3]),e.set(i[4],i[5])):4==i.length?(e=new n,e.cp.set(i[0],i[1]),e.set(i[2],i[3])):e=new o(i[0],i[1]),s.push(e);this.#m=s,this.updatePath()}getNodes(t={x:0,y:0}){const e=Object.assign({},t,{x:-t.x,y:-t.y}),s=this.#m.map((t=>new c(this,t,e)));for(let t=1;t<s.length;++t)s[t].prev=s[t-1],s[t-1].next=s[t];if(this.#w){const t=s[0],e=s.last();e.next=t,t.prev=e}return s}draw(t,e="select"){if(0==this.#m.length)return;const s="draw"==e,i="edit"==e?0:this.angle,r=this.#w||!this.#y;if(this.#m.length>1){const e=this.#k;!s&&this.#w?this.drawPath(t,e,!0,i):this.strokePath(t,e,r,i)}const n=this.#m.last();if(s&&!r){const e=this.#m[0];this.drawNode(t,e.x,e.y),t.save(),t.strokeStyle="#f33",t.lineWidth=1;const s=new Path2D,i=this.#y.controlPoint();let r=n;s.moveTo(n.x,n.y),this.#y.draw(s),t.stroke(s),t.strokeStyle="#33f",this.#x&&(r=new o(i.x,i.y),r.invert(n.x,n.y)),t.moveTo(r.x,r.y),t.lineTo(i.x,i.y),t.stroke(),this.drawNode(t,i.x,i.y),this.#x&&this.drawNode(t,r.x,r.y),this.#m.length>1&&this.inNode(this.#y.x,this.#y.y,e.x,e.y)?this.drawNode(t,this.#y.x,this.#y.y,"#f33","#f33"):this.drawNode(t,this.#y.x,this.#y.y),t.restore()}else super.draw(t)}drawSelection(t,e){"edit"==e||(this.drawBorder(t,1,"#888",-2,!0),super.drawSelection(t,e))}drawSVG(t,e){const s=this.getFill(),i=this.getStroke(),r=this.getShadow(),o={segments:this.#m,closed:this.#w},n=this.box(0,e);t.path(n,o,s,i,r)}addPoint(t,e){this.#m.push(new o(t,e))}addCurve2(t,e,s,i){const r=new n(t,e);r.cp.set(s,i),this.#m.push(r)}addCurve3(t,e,s,i,r,o){const n=new h(t,e);n.cp.set(s,i),n.cp2.set(r,o),this.#m.push(n)}mouseMove(t,e,s){this.#b&&!this.inNode(t,e,this.#b.x,this.#b.y)&&(this.#b=null,this.#x=!0,s.Control?(this.#y=new n,this.#y.cp.set(t,e)):this.#S()),this.#x&&this.#m.last().tangent(t,e),this.#y.set(t,e),this.#k=this.getPath()}mouseDown(t,e,s){this.#y||(this.#y=new o(t,e)),this.#b=new o(t,e),this.#x=!1,this.#C()}mouseUp(t,e,s){this.#x&&(this.#m.last(),this.#y=new n(t,e),this.#x=!1),this.#v=this.#m.length-1,this.#b=null}getPath(t,e,s=1,i=1){let r=this.#m;return 1==s&&1==i||(r=r.map((t=>t.scale(s,i)))),l.getPath(r,this.#w)}updatePath(){this.#k=this.getPath()}close(t=!0){let e=this.#m[0],s=this.#m.last();e.isLine()&&(this.#m.shift(),e=this.#m[0]),s.isLine()||e.isLine()||(e=e.toCurve(s.x,s.y),s=s.toCurve(s.x,s.y),e.cp.set(2*s.x-s.cp2.x,2*s.y-s.cp2.y),e.cp.set(s.cp2.x,s.cp2.y),e.cp.invert(s.x,s.y),this.#m[0]=e,this.#m[this.#m.length-1]=s),this.#w=!0,this.end(t)}end(t=!0){t&&this.#T(),this.#y=null,this.move(0,0)}remove(t){if(this.#m.length<3)return!1;let e;t instanceof c?(t.prev.next=t.next,t.next.prev=t.prev,e=t.segment,t=this.#m.findIndex((t=>t==e))):e=this.#m[t];const s=t<this.#m.length-1?this.#m[t+1]:this.#m[0],i=t>0?this.#m[t-1]:this.#m.last();if(e.isLine());else if(s.isLine());else if(i.isLine());else{const t=i.x+1.75*(i.x-i.cp2.x),r=i.y+1.75*(i.y-i.cp2.y);s.cp.set(t,r),s.cp2.set(e.cp2.x,e.cp2.y),i.tangent(t,r)}return this.#m.splice(t,1),this.updatePath(),!0}split(t){let e,s;t instanceof c?(s=t,e=t.segment,t=this.#m.findIndex((t=>t==e))):e=this.#m[t];const i=t>0?this.#m[t-1]:this.#m.last(),r=e.split(i);this.#m.splice(t+1,0,r),this.updatePath();const o=new c(this,r);return s&&(o.next=s.next,o.prev=s,s.next=o),o}undo(){this.#y=this.#m.pop(),this.#v--}move(t,e){const[s,i]=this.center(),r=t-s,o=e-i;for(const t of this.#m)t.move(r,o);this.#k=this.getPath()}#S(){if(this.#m.length<2)return;const t=this.#m[this.#m.length-2],e=this.#m.last().toCurve(t.x,t.y);this.#m[this.#m.length-1]=e}#C(){const t=this.#m[0];if(t&&this.inNode(this.#y.x,this.#y.y,t.x,t.y))return this.#y.set(t.x,t.y),this.#m.push(this.#y),void this.close();this.#m.push(this.#y),this.#y=new o(this.#y.x,this.#y.y),this.#k=this.getPath()}#T(t=0,e=0){const s=function(t){let e,s=1/0,i=1/0,r=-1/0,o=-1/0,n=t.last();for(let h=0;h<t.length;h++,n=e)e=t[h],t[h].isLine()?(s=Math.min(s,e.x),i=Math.min(i,e.y),r=Math.max(r,e.x),o=Math.max(o,e.y)):[0,1,...e.extrema(n)].forEach((t=>{const h=e.evaluate(n,t);s=Math.min(s,h.x),i=Math.min(i,h.y),r=Math.max(r,h.x),o=Math.max(o,h.y)}));return{x:s,y:i,width:r-s,height:o-i}}(this.#m);this.x=s.x,this.y=s.y,this.width=s.width,this.height=s.height}}l.detectBody=async function(t,e=.7){await async function(){u||(u=await bodyPix.load({architecture:"ResNet50",outputStride:16,multiplier:1,quantBytes:2}))}();const s=t.image(),i=await u.segmentPerson(s,{flipHorizontal:!1,internalResolution:.75,segmentationThreshold:e}),r=function(t){const{width:e,height:s,data:i}=t,r=[];for(let t=1;t<s-1;t++)for(let s=1;s<e-1;s++)i[4*(t*e+s)+3]>0&&(0!==i[4*((t-1)*e+s)+3]&&0!==i[4*((t+1)*e+s)+3]&&0!==i[4*(t*e+(s-1))+3]&&0!==i[4*(t*e+(s+1))+3]||r.push([s,t]));const o=function(t){if(0===t.length)return[];const e=[t.shift()];for(;t.length>0;){const s=e[e.length-1];let i=0,r=1/0;for(let e=0;e<t.length;e++){const[o,n]=s,[h,a]=t[e],l=Math.hypot(h-o,a-n);l<r&&(r=l,i=e)}e.push(t.splice(i,1)[0])}return e}(r);return function(t,e){if(t.length<3)return t;const s=function(t,e=10,s=.5){const i=[];for(let s=0;s<t.length-1;s++){const r=t[Math.max(s-1,0)],o=t[s],n=t[s+1],h=t[Math.min(s+2,t.length-1)];for(let t=0;t<=1;t+=1/e){const e=t*t,s=e*t,a=.5*(2*o[0]+(-r[0]+n[0])*t+(2*r[0]-5*o[0]+4*n[0]-h[0])*e+(-r[0]+3*o[0]-3*n[0]+h[0])*s),l=.5*(2*o[1]+(-r[1]+n[1])*t+(2*r[1]-5*o[1]+4*n[1]-h[1])*e+(-r[1]+3*o[1]-3*n[1]+h[1])*s);i.push([a,l])}}return i.push(t[t.length-1]),i}(t),i=function(t,e){const s=[0];for(let e=1;e<t.length;e++){const[i,r]=t[e-1],[o,n]=t[e];s.push(s[e-1]+Math.hypot(o-i,n-r))}const i=s[s.length-1]/(e-1),r=[t[0]];let o=i;for(let e=1;e<s.length;e++)for(;o<=s[e];){const n=(o-s[e-1])/(s[e]-s[e-1]),[h,a]=t[e-1],[l,c]=t[e];r.push([h+n*(l-h),a+n*(c-a)]),o+=i}return r.push(t[t.length-1]),r}(s,91);return function(t){if(t.length<=2)return t;const e=[t[0]];for(let s=1;s<t.length-1;s++){const[i,r]=e[e.length-1],[o,n]=t[s],[h,a]=t[s+1];(o-i)*(a-r)!=(n-r)*(h-i)&&e.push(t[s])}return e.push(t[t.length-1]),e}(i)}(o)}(bodyPix.toMask(i));if(0==r.length)return null;const o=new l;o.x=0,o.y=0,o.width=t.width,o.height=t.height,o.addPoint(r[0][0],r[0][1]);for(let t=1;t<r.length-2;t+=3)o.addCurve3(r[t+2][0],r[t+2][1],r[t][0],r[t][1],r[t+2][0],r[t+2][1]);return o.close(!1),o.x=t.x,o.y=t.y,o.alpha=.5,t.setMask(o),o},l.toSpline=function(t,e=.5){if(t.length<2)return"";const s=[t[0].clone()],i=t.length;for(let r=0;r<i-1;r++){const o=r>0?t[r-1]:t[0],n=t[r],a=t[r+1],l=r<i-2?t[r+2]:t[i-1],c=new h(a.x,a.y);c.cp.set(n.x+(a.x-o.x)*e/6,n.y+(a.y-o.y)*e/6),c.cp2.set(a.x-(l.x-n.x)*e/6,a.y-(l.y-n.y)*e/6),s.push(c)}return s},l.getPath=function(t,e){const s=new Path2D;let i;e?i=t.last():(i=t[0],t=t.slice(1)),s.moveTo(i.x,i.y);for(const e of t)e.draw(s);return e&&s.closePath(),s};class c{#P;#k;#p=!1;#B;#j;#I=new o;prev;get x(){return this.#P.x+this.#I.x}get y(){return this.#P.y+this.#I.y}get selected(){return this.#p}get next(){return this.#j}get segment(){return this.#P}get control(){return!0}constructor(t,e,s){const[i,r]=t.center(s);this.#I.set(i,r),this.#P=e,this.#k=t,e.isLine()||(this.#B=new d(e,t,s))}set next(t){this.#B&&this.#B.add(t.segment),this.#j=t}move(t,e){const s=t-this.x,i=e-this.y;this.#P.moveNode(s,i),this.#j&&this.#j.segment.moveTangent(s,i),this.#p=!0,this.#k.updatePath()}draw(t){this.#p?(l.drawNode(t,this.x,this.y,"#33f","#55e"),this.#B&&this.#B.draw(t)):l.drawNode(t,this.x,this.y)}handleSelect(t,e){if(this.#p){const s=this.#B?.handleSelect(t,e);if(s)return s}if(l.inNode(t,e,this.x,this.y))return this.#p=!this.#p,this}}class d{#E;#D;#P;#A;#k;constructor(t,e,s){this.#E=t.cp2||t,this.#P=this.#D=t;const[i,r]=e.center(s);this.#A=new o(i,r),this.#k=e}add(t){this.#D=t.cp||t}draw(t){t.save(),t.lineWidth=2,t.strokeStyle="#55e",t.setLineDash([6,2]),t.translate(this.#A.x,this.#A.y),t.moveTo(this.#E.x,this.#E.y),t.lineTo(this.#D.x,this.#D.y),t.stroke(),this.#D.isLine()&&this.#_(t,this.#D),this.#E.isLine()&&this.#_(t,this.#E),t.restore()}handleSelect(t,e){t-=this.#A.x,e-=this.#A.y;class s{constructor(t,e,s,i,r){this.p=t,this.p0=e,this.p1=s,this.o=i,this.path=r}move(t,e){t-=this.o.x,e-=this.o.y,this.p0.set(t,e),this.p1.isLine()&&(this.p1.set(t,e),this.p1.invert(this.p.x,this.p.y)),this.path.updatePath()}}return l.inNode(t,e,this.#E.x,this.#E.y)?new s(this.#P,this.#E,this.#D,this.#A,this.#k):this.#D.isLine()&&l.inNode(t,e,this.#D.x,this.#D.y)?new s(this.#P,this.#D,this.#E,this.#A,this.#k):void 0}#_(t,e){l.drawNode(t,e.x,e.y,"#f44336","#f44336")}}let u,g;class p extends t{#M="";#z=30;#R=!1;#W=!1;#F="Arial";#O="left";get type(){return"text"}constructor(){super(),this.fill="#111111",this.strokeWidth=0,this.stroke=null,this.shadow=null}get size(){return this.#z}get bold(){return this.#R}get italic(){return this.#W}get font(){return this.#F}get align(){return this.#O}get value(){return this.#M}set size(t){"string"==typeof t&&(t=parseInt(t)),t<8&&(t=8),this.#z=t,this.calculateBorderSize()}set bold(t){this.#R=t}set italic(t){this.#W=t}set align(t){this.#O=t}set font(t){this.#F=t}set value(t){this.#M=t}set text(t){this.value=t}setText(t){this.text=t,this.calculateBorderSize()}draw(t){this.#M&&this.drawText(t,this.#M,{size:this.#z,font:this.#F,bold:this.#R,italic:this.#W,align:this.#O})}drawSelection(t){this.drawBorder(t,1,"#888",-5,!0),super.drawSelection(t)}drawSVG(t,e){const s=this.getFill(),i=this.getStroke(),r=this.getShadow(),o=this.box(0,e),n={value:this.#M,font:this.#F,size:this.#z,bold:this.#R,italic:this.#W,align:this.#O};t.text(o,n,s,i,r)}calculateBorderSize(){if(this.#M){const t=this.#M.trim().split("\n");t.sort(((t,e)=>e.length-t.length)),this.width=t[0].length*this.#z*.6,this.height=t.length*this.#z*1.1}else this.width=this.width,this.height=this.height}}class f extends t{#N=0;get type(){return"rect"}get radius(){return this.#N}set radius(t){"string"==typeof t&&(t=parseInt(t)),this.#N=t}draw(t){this.drawRoundRectangle(t,this.#N)}strokeBorder(t){this.strokeWidth>0&&super.drawBorder(t,this.strokeWidth,this.stroke,-this.strokeWidth/2)}drawSVG(t,e={x:0,y:0},s=!1){const i=this.getFill(),r=this.getStroke(),o=this.getShadow(),n=this.box(0,e);s&&(n.angle=0),t.rect(n,this.#N,i,r,o)}getPath(t=this.x,e=this.y,s=1,i=1){const r=new Path2D,o=this.width*s,n=this.height*i,h=this.#N*Math.min(s,i);return r.roundRect(t,e,o,n,h),r}}class m extends f{#M;get type(){return"label"}constructor(){super();const t=new p(this);t.x=10,t.y=10,t.shadowColor="#555555",this.#M=t}get width(){return super.width}get height(){return super.height}get text(){return this.#M.value}get textOffsetX(){return this.#M.x}get textOffsetY(){return this.#M.y}get textSize(){return this.#M.size}get textBold(){return this.#M.bold}get textItalic(){return this.#M.italic}get textFill(){return this.#M.fill}get textStroke(){return this.#M.stroke}get textStrokeWidth(){return this.#M.strokeWidth}get textFont(){return this.#M.font}get textAlign(){return this.#M.align}get textShadow(){return this.#M.shadow}get textShadowWidth(){return this.#M.shadowWidth}get textShadowColor(){return this.#M.shadowColor}set width(t){"string"==typeof t&&(t=parseInt(t)),super.width=t,this.#M.width=t-2*this.#M.x}set height(t){"string"==typeof t&&(t=parseInt(t)),super.height=t,this.#M.height=t-2*this.#M.y}set textOffsetX(t){"string"==typeof t&&(t=parseInt(t)),this.#M.x=t,this.#M.width=this.width-2*t}set textOffsetY(t){"string"==typeof t&&(t=parseInt(t)),this.#M.y=t,this.#M.height=this.height-2*t}set textSize(t){"string"==typeof t&&(t=parseInt(t)),this.#M.size=t}set textBold(t){this.#M.bold=t}set textAlign(t){this.#M.align=t}set textItalic(t){this.#M.italic=t}set textFont(t){this.#M.font=t}set textFill(t){this.#M.fill=t}set textStroke(t){this.#M.stroke=t}set textStrokeWidth(t){"string"==typeof t&&(t=parseInt(t)),this.#M.strokeWidth=t}set textShadow(t){this.#M.shadow=t}set textShadowWidth(t){"string"==typeof t&&(t=parseInt(t)),this.#M.shadowWidth=t}set textShadowColor(t){this.#M.shadowColor=t}set text(t){this.#M.value=t}getText(){return this.#M}centerText(){const t=Math.floor(this.width/2),e="center";return this.textOffsetX=t,this.textAlign=e,{textOffsetX:t,textAlign:e}}draw(t){super.draw(t),t.save();const{x:e,y:s}=this.setGeometry(t);t.translate(e,s),this.#M.draw(t),t.restore()}drawText(t){this.#M.draw(t)}drawSVG(t,e){const s=this.box(0,e),i=-(this.x-e.x),r=-(this.y-e.y);t.group(null,s),super.drawSVG(t,e,!0),this.#M.drawSVG(t,{x:i,y:r}),t.groupEnd()}}class x{#$;#U;constructor(t){this.#$=t}get name(){return"none"}glfx(){return this.#$.glfx()}image(){return this.#$.image()}getBitmap(){return this.#U}setBitmap(t=this.apply()){this.release(),this.#U=t}release(){this.#U&&(this.#U.close(),this.#U=null)}apply(){}}class w extends x{#N=5;get radius(){return this.#N}set radius(t){this.#N=t,t>0&&this.setBitmap()}}class y extends x{#X=.5;get amount(){return this.#X}set amount(t){this.#X=t,t>0&&this.setBitmap()}}class b extends w{#r;#o;get x(){return this.#r}get y(){return this.#o}constructor(t){super(t),this.#r=t.width/2,this.#o=t.height/2}apply(){}}class v extends x{#G=.3;get name(){return"zoomBlur"}get strength(){return this.#G}set strength(t){this.#G=t,t>0&&this.setBitmap()}}class k extends w{#G=.3;get strength(){return this.#G}set strength(t){this.#G=t,t>0&&this.setBitmap()}}class S extends w{get name(){return"triangleBlur"}apply(){return this.glfx().triangleBlur(this.image(),this.radius)}}class C extends w{#L=.75;#n=0;get name(){return"lensBlur"}get brightness(){return this.#L}get angle(){return this.#n}set brightness(t){this.#L=t,t>0&&this.setBitmap()}set angle(t){this.#n=t,t>0&&this.setBitmap()}apply(){return this.glfx().lensBlur(this.image(),this.radius,this.#L,this.#n)}}class T extends v{get name(){return"zoomBlur"}apply(){return this.glfx().zoomBlur(this.image(),this.strength)}}class P extends v{get name(){return"ink"}apply(){return this.glfx().ink(this.image(),this.strength)}}class B extends x{#L=0;#Y=0;get name(){return"contrast"}get brightness(){return this.#L}get contrast(){return this.#Y}set brightness(t){t>0&&this.setBitmap(this.glfx().brightnessContrast(this.image(),t,this.#Y)),this.#L=t}set contrast(t){t>0&&this.setBitmap(this.glfx().brightnessContrast(this.image(),this.#L,t)),this.#Y=t}}class j extends x{#H=0;#V=0;get name(){return"hueSaturation"}get brightness(){return this.#H}get contrast(){return this.#V}set hue(t){t>0&&this.setBitmap(this.glfx().hueSaturation(this.image(),t,this.#V)),this.#H=t}set saturation(t){t>0&&this.setBitmap(this.glfx().hueSaturation(this.image(),this.#H,t)),this.#V=t}}class I extends b{#n=0;get name(){return"swirl"}get angle(){return this.#n}set angle(t){this.#n=t,t>0&&this.setBitmap()}apply(){return this.glfx().swirl(this.image(),this.radius,this.#n,this.x,this.y)}}class E extends b{#G=.25;get name(){return"bulgePinch"}get strength(){return this.#G}set strength(t){this.#G=t,t>0&&this.setBitmap()}apply(){return this.glfx().bulgePinch(this.image(),this.radius,this.#G,this.x,this.y)}}class D extends x{#q=20;get name(){return"denoise"}get exponent(){return this.#q}set exponent(t){this.#q=t,this.setBitmap(this.glfx().denoise(this.image(),this.#q))}}class A extends k{get name(){return"unsharpMask"}apply(){return this.glfx().unsharpMask(this.image(),this.radius,this.strength)}}class _ extends y{get name(){return"noise"}apply(){return this.glfx().noise(this.image(),this.amount)}}class M extends y{get name(){return"sepia"}apply(){return this.glfx().sepia(this.image(),this.amount)}}class z extends y{#z=.5;get name(){return"vignette"}get size(){return this.#z}set size(t){this.#z=t,this.setBitmap()}apply(){return this.glfx().vignette(this.image(),this.#z,this.amount)}}class R extends y{get name(){return"vibrance"}apply(){return this.glfx().vibrance(this.image(),this.amount)}}const W=new OffscreenCanvas(512,512),F=W.getContext("2d");class O extends f{#K;#$;#U;#J;#Z;#Q=0;#tt=0;#et;#st=0;#it=0;#rt=0;#ot=0;#nt=!0;#ht=!1;#at=0;#lt=0;#ct=0;#dt=0;#ut;#gt=0;get type(){return"image"}constructor(t){super(),t instanceof O&&(this.#$=t.image(),this.#$,this.#K=t.file)}set file(t){this.#K=t}set selected(t){super.selected=t}set imgX(t){"string"==typeof t&&(t=parseInt(t)),this.#st=t}set imgY(t){"string"==typeof t&&(t=parseInt(t)),this.#it=t}set imgWidth(t){if("string"==typeof t&&(t=parseInt(t)),0==t)return;let e=this.#dt/(this.#ct||1);this.#rt=t,this.#rt>=this.width&&(this.#st=0,this.width=this.#rt),this.#nt&&(this.#ot=Math.round(this.#rt*e),this.#ot>=this.height&&(this.#it=0,this.height=this.#ot))}set imgHeight(t){if("string"==typeof t&&(t=parseInt(t)),0==t)return;let e=this.#rt/(this.#ot||1);this.#ot=t,this.#ot>=this.height&&(this.#it=0,this.height=this.#ot),this.#nt&&(this.#rt=Math.round(this.#ot*e),this.#rt>=this.width&&(this.#st=0,this.width=this.#rt))}set imgMirror(t){this.#ht=t}set imgScale(t){if("string"==typeof t&&(t=parseFloat(t)),isNaN(t)||0==t)return;const e=this.width==this.#rt&&this.height==this.#ot;this.#rt=Math.round(this.#$.width*t),this.#ot=Math.round(this.#$.height*t),e&&(this.width=this.#rt,this.height=this.#ot)}set imgKeepProportion(t){this.#nt=t}set cropX(t){"string"==typeof t&&(t=parseInt(t));const e=this.#at-t,s=this.imgScale;this.#at=t,this.#ct+=e,this.#rt+=Math.round(e/s)}set cropY(t){"string"==typeof t&&(t=parseInt(t));const e=this.#lt-t,s=this.imgScale;this.#lt=t,this.#ot+=Math.round(e/s)}set cropWidth(t){"string"==typeof t&&(t=parseInt(t));const e=this.#ct-t,s=this.imgScale;this.#ct=t,this.#rt-=Math.round(e/s)}set cropHeight(t){"string"==typeof t&&(t=parseInt(t));const e=this.#dt-t,s=this.imgScale;this.#dt=t,this.#ot-=Math.round(e/s)}set cropMirror(t){this.#ht=t}set mask(t){this.#J=t}set maskPath(t){this.#Z=t}set maskX(t){"string"==typeof t&&(t=parseInt(t)),this.#Q=t??0}set maskY(t){"string"==typeof t&&(t=parseInt(t)),this.#tt=t??0}set blur(t){"string"==typeof t&&(t=parseInt(t)),this.#U&&this.#U.close(),this.#U=t>0?glfx.blur(this.#$,t):null}set filter(t){switch(this.#et&&(this.#et.release(),this.#et=null),t){case"triangleBlur":this.#et=new S(this);break;case"zoomBlur":this.#et=new T(this);break;case"lensBlur":this.#et=new C(this);break;case"ink":this.#et=new P(this);break;case"contrast":this.#et=new B(this);break;case"hue":this.#et=new j(this);break;case"swirl":this.#et=new I(this);break;case"bulge":this.#et=new E(this);break;case"denoise":this.#et=new D(this);break;case"unsharp":this.#et=new A(this);break;case"noise":this.#et=new _(this);break;case"sepia":this.#et=new M(this);break;case"vignette":this.#et=new z(this);break;case"vibrance":this.#et=new R(this)}}set filterRadius(t){this.#et&&("string"==typeof t&&(t=parseInt(t)),this.#et.radius=t)}set filterStrength(t){this.#et&&("string"==typeof t&&(t=parseFloat(t)),this.#et.strength=t)}set filterBrightness(t){this.#et&&("string"==typeof t&&(t=parseFloat(t)),this.#et.brightness=t)}set filterAngle(t){this.#et&&("string"==typeof t&&(t=parseFloat(t)),this.#et.angle=t)}set filterContrast(t){this.#et&&("string"==typeof t&&(t=parseFloat(t)),this.#et.contrast=t)}set filterHue(t){this.#et&&("string"==typeof t&&(t=parseFloat(t)),this.#et.hue=t)}set filterSaturation(t){this.#et&&("string"==typeof t&&(t=parseFloat(t)),this.#et.saturation=t)}set filterExponent(t){this.#et&&("string"==typeof t&&(t=parseInt(t)),this.#et.exponent=t)}set filterAmount(t){this.#et&&("string"==typeof t&&(t=parseFloat(t)),this.#et.amount=t)}set filterSize(t){this.#et&&("string"==typeof t&&(t=parseFloat(t)),this.#et.size=t)}get file(){return this.#K}get imgX(){return this.#st}get imgY(){return this.#it}get imgWidth(){return Math.round(this.#rt)}get imgHeight(){return Math.round(this.#ot)}get imgMirror(){return this.#ht}get imgScale(){return this.#rt/this.#ct}get imgKeepProportion(){return this.#nt}get cropX(){return this.#at}get cropY(){return this.#lt}get cropWidth(){return this.#ct}get cropHeight(){return this.#dt}get mask(){return this.#J}get maskPath(){return"string"==typeof this.#Z?this.#Z:this.#Z?.id}get maskX(){return this.#Q}get maskY(){return this.#tt}get blur(){return this.#gt}get filter(){return this.#et?.name}get filterRadius(){return this.#et?.radius??0}get filterStrength(){return this.#et?.strength??0}get filterBrightness(){return this.#et?.brightness??0}get filterAngle(){return this.#et?.angle??0}get filterContrast(){return this.#et?.contrast??0}get filterHue(){return this.#et?.hue??0}get filterSaturation(){return this.#et?.saturation??0}get filterExponent(){return this.#et?.exponent??0}get filterAmount(){return this.#et?.amount??0}get filterSize(){return this.#et?.size??0}image(){return this.#$||W}setImage(t){this.#$=t,this.#K=this.#K||t._file,this.#rt=this.#rt||t.width,this.#ot=this.#ot||t.height,this.#ct=this.#ct||this.#rt,this.#dt=this.#dt||this.#ot,this.width=this.width||this.#rt,this.height=this.height||this.#ot,t._refs++,this.#et&&this.#et.setBitmap()}glfx(){return glfx}setMask(t,e=!0){this.#J=t.name,this.#Z=t,this.#at=t.x-this.x,this.#lt=t.y-this.y,this.#ct=t.width,this.#dt=t.height,this.#rt=this.#ct,this.#ot=this.#dt,this.x=t.x,this.y=t.y,this.fitSize()}clone(){this.#$._refs++;const t=super.clone();return t.#$=this.#$,t}release(){this.#$&&0==--this.#$._refs&&URL.revokeObjectURL(this.#$.src),this.#U&&this.#U.close()}load(t){const{filter:e,...s}=t;e&&(this.filter=e),super.load(s)}save(){const t=super.save();return delete t.imgScale,delete t.imgKeepProportion,t}draw(t){let e=Math.min(this.width,this.#rt),s=Math.min(this.height,this.#ot),i=this.#et?.getBitmap()||this.#$;this.#J||this.drawRectangle(t),t.save();let r,{x:o,y:n}=this.setGeometry(t);if(o+=this.#st,n+=this.#it,this.#ht&&t.scale(-1,1),this.#J){const e=o+this.#Q,s=n+this.#tt,i=this.#rt/this.#ct,h=this.#ot/this.#dt;r=this.#Z.getPath(e,s,i,h),this.#Z.fillPath(t,r,!1,0),t.save(),t.clip(r)}t.drawImage(i,this.#at,this.#lt,this.#ct,this.#dt,o,n,e,s),r&&(t.restore(),this.#Z.strokePath(t,r,!1,0)),this.#ut&&(t.fillStyle="#222",t.fill(this.#ut)),t.restore(),this.strokeBorder(t)}drawSelection(t){0==this.strokeWidth&&this.drawBorder(t,1,"#333",0,!0),super.drawSelection(t)}updateSize(t,e){super.updateSize(t,e),Math.abs(this.width-this.#rt)<4&&(this.width=this.#rt),Math.abs(this.height-this.#ot)<4&&(this.height=this.#ot)}centerInBox(){const t=this.width,e=this.height,s=this.#rt,i=this.#ot;return s<t&&(this.#st=Math.round((t-s)/2)),i<e&&(this.#it=Math.round((e-i)/2)),{imgX:this.#st,imgY:this.#it}}fitSize(){return this.width=this.#rt,this.height=this.imgHeight,this.#st=0,this.#it=0,{width:this.width,height:this.height,imgX:0,imgY:0}}blurSlow(t,e=this.#gt){if(0==e)return;const s=this.x+this.#st,i=this.y+this.#it,r=this.#rt,o=this.#ot,n=t.getImageData(s,i,r,o),h=n.data,a=new Uint8ClampedArray(h);for(let t=0;t<o;t++)for(let s=0;s<r;s++){let i=0,n=0,l=0,c=0;for(let h=-e;h<=e;h++)for(let d=-e;d<=e;d++){const e=s+d,u=t+h;if(e>=0&&e<r&&u>=0&&u<o){const t=4*(u*r+e);i+=a[t],n+=a[t+1],l+=a[t+2],c++}}const d=4*(t*r+s);h[d]=i/c,h[d+1]=n/c,h[d+2]=l/c}t.putImageData(n,s,i)}async loadImage(t=this.#K,e=1200,s=900){this.#K=t.name;let i=await O.load(t);i._refs=0,console.debug("Image imported:",i.width,i.height);const r=e-i.width,o=s-i.height;if(r<0||o<0){const t=r<o?e/i.width:s/i.height,n=i.width*t,h=i.height*t;W.width=n,W.height=h,F.drawImage(i,0,0,i.width,i.height,0,0,n,h),URL.revokeObjectURL(i.src),i=await async function(t){return N(await U(t))}(W),i._refs=0}return this.setImage(i),i}async detectBodySelfie(t=.7){await async function(){g||(g=await bodyPix.load({architecture:"ResNet50",outputStride:16,multiplier:1,quantBytes:2}))}();const e=this.#U||this.#$,s=await bodySegmentation.createSegmenter(bodySegmentation.SupportedModels.MediaPipeSelfieSegmentation,{runtime:"mediapipe",modelType:"general"}),i=await s.segmentPeople(e),r=await bodySegmentation.toBinaryMask(i);this.#J=function(t){const e=new Path2D;return console.log(t),e}(r)}static load=N;static thumb=$}function N(t){return new Promise(((e,s)=>{const i=new Image;i.src=URL.createObjectURL(t),i.onload=()=>e(i),i.onerror=s}))}async function $(t,e=100,s=100){const i=t.width/t.height;let r=e,o=s;t.width>t.height?o=Math.min(s,e/i):r=Math.min(e,s*i),W.width=r,W.height=o,F.drawImage(t,0,0,r,o);const n=await U(W,"image/jpg");return URL.createObjectURL(n)}function U(t,e="image/png"){return t.convertToBlob({type:e})}const X=Object.values({blue:"#2196F3",red:"#f44336",green:"#4CAF50",orange:"#ff9800",teal:"#009688"});class G extends t{#z=16;#F="Arial";#pt="bar";#ft=!0;#mt=!0;#xt=!0;#K;#wt={labels:[],sets:[]};#yt={min:0,max:100,step:20};#bt={top:10,bottom:10,left:10,right:10};#vt={x:0,y:0};get type(){return"chart"}get file(){return this.#K}set file(t){this.#K=t}get height(){return super.height}set height(t){super.height=t,this.#wt.sets&&this.#kt()}get size(){return this.#z}set size(t){"string"==typeof t&&(t=parseInt(t)),t<8&&(t=8),this.#z=t}get font(){return this.#F}set font(t){this.#F=t}get kind(){return this.#pt}set kind(t){this.#pt=t}get labels(){return this.#ft}set labels(t){this.#ft=t}get legend(){return this.#mt}set legend(t){this.#mt=t}get axis(){return this.#xt}set axis(t){this.#xt=t}clone(){const t=super.clone();return t.#yt=this.#yt,t.#bt=this.#bt,t.#wt=this.#wt,t.#wt.refs++,t}release(){this.#wt.refs--}setData(t){t.refs++,this.#pt=t.type,this.#wt=t,this.#kt()}getData(){return this.#wt}draw(t){const e=this.#wt.sets,s=this.#wt.labels,i=this.#wt.labelColumn?this.#wt.inferredTypes[this.#wt.labelColumn]:"categorical",r=this.#yt,n=this.stroke,h=this.strokeWidth,a=!!this.shadow,c=this.fillShadowColor(),d=this.shadowWidth,u=this.alphaHex(),g=this.#z,p=this.#F,f=this.#vt,m=5+h/2;t.save();let{x,y:w}=this.setGeometry(t);const y={x:x+10,y:w+10,width:this.width-20,height:this.height-20};t.font=`${this.#z}px ${this.#F}`,t.fillStyle=this.stroke,t.textBaseline="top";let b=y;if(this.#mt&&function(s){const i=e.filter((t=>!!t.label)).map((e=>(e.width=t.measureText(e.label).width+30,e)));if(i.length>0){t.save();const e=i.map((t=>t.width)).sum(),r=s.width;w=s.y,i.length;let o=s.x+(r>e?(r-e)/2:0);for(let e=0;e<i.length;++e)t.fillStyle=X[e%X.length],t.fillRect(o,w,20,g-4),o+=25,t.fillText(i[e].label,o,w),o+=i[e].width+5;t.restore();const n=g+10;s.y+=n,s.height-=n}}(y),this.#ft&&(b=function(e){const o=g+20,n=e.height-o,h=Math.ceil(r.max/r.step),a=n/h;t.save(),t.font=`${g-2}px ${p}`,t.textAlign="right",t.textBaseline="middle";const l=t.measureText(r.max.toString()).width;f.y=l,e.x+=l,e.width-=l;for(let s=0,i=0,o=e.x,l=e.y+n;s<h+1;++s,l-=a,i+=r.step)t.fillText(i.toString(),o,l);if(t.restore(),e.x+=20,e.width-=20,s.length>0){t.save(),t.textBaseline="bottom",t.textAlign="center";let r=s;if("categorical"!=i){const i=t.measureText(s.last()).width+60,o=Math.ceil(e.width/i);if(f.x=i,s.length>o){const t=Math.floor(s.length/o);r=s.filter(((e,s)=>s%t==0))}}const n=e.width/r.length,h=e.y+e.height,a=Object.assign({},e);a.x+=n/2,a.width-=n;const l=new Path2D;for(let e=0,s=a.x;e<r.length;++e,s+=n)l.moveTo(s,h-o),l.lineTo(s,h-o+m),t.fillText(r[e].toString(),s,h);return t.stroke(l),t.restore(),e.height-=o,a.height-=o,a}return e}(y)),this.#xt&&function(e){let s=e.x,i=e.y;const o=Math.ceil(r.max/r.step),a=e.height/o;t.save(),t.lineWidth=h,t.strokeStyle=n,t.lineCap="round",t.lineJoin="round",t.beginPath(),t.moveTo(s,i),i+=e.height,t.lineTo(s,i),t.lineTo(s+e.width,i),t.stroke(),t.lineWidth=1,t.strokeStyle=n+"55",i-=a;for(let r=0;r<o;++r,i-=a)t.moveTo(s-m,i),t.lineTo(s+e.width,i);t.stroke(),t.restore()}(y),s.length>0)switch(this.#pt){case"bar":s.length<10?function(s){const i=e[0].data.length,o=.02*s.width,n=(s.width/i-o)/e.length,h=s.y,l=s.height;let g,p,f,m=s.x+o/2;t.save();for(let s=0;s<i;++s){for(let i=0;i<e.length;++i)f=X[i%X.length],p=(r.max-e[i].data[s])/r.max,g=l*p,t.strokeStyle=f,t.fillStyle=f+u,a&&(t.save(),t.shadowColor=c,t.shadowBlur=5,t.shadowOffsetX=d,t.shadowOffsetY=d,t.fillRect(m,h+g,n,l-g),t.restore()),t.fillRect(m,h+g,n,l-g),t.strokeRect(m,h+g,n,l-g),m+=n;m+=o}t.restore()}(y):v(b,"scatter");break;case"line":case"spline":case"scatter":v(b,this.#pt)}function v(s,i="spline"){const a=e[0].data.length-1,c=s.width/a,d=s.height,u=s.y,g=s.x;let p,f,m,x=.8*h;x<3&&(x=3),t.save(),t.strokeStyle=n,t.lineWidth=h,t.lineCap="round",t.lineJoin="round";for(let s,n,h,a,w,y=0;y<e.length;++y){a=e[y].data,s=g,n=a.map((t=>(w=(r.max-t)/r.max,u+d*w))),h=X[y%X.length],t.strokeStyle=h,p=[],m=null;for(let t=0;t<a.length;++t,s+=c)p.push(new o(s,n[t]));switch(i){case"spline":f=l.toSpline(p,1),m=l.getPath(f);break;case"line":m=l.getPath(p)}m&&t.stroke(m);for(const e of p)G.drawNode(t,e.x,e.y,h,!0,x)}t.restore()}t.restore()}drawSVG(t,e){const s=this.box(20,e),i=this.#z,r=this.getStroke({linecap:"round"}),n=this.getShadow(),h=Math.ceil(this.#yt.max/this.#yt.step),a=(this.strokeWidth,this.#wt.sets),c=this.#wt.labels,d=this.#wt.labelColumn?this.#wt.inferredTypes[this.#wt.labelColumn]:"categorical",u=(this.#bt,this.alpha),g=this.#yt,p=this.#vt,f={},m={font:this.font,size:i};t.group({name:this.name},s),s.angle=0;let x=s;switch(this.#mt&&function(e){console.debug("SVG legned:",e),t.group({name:"legend"},e);const s=a.filter((t=>!!t.label)),o=i+10,n=e.width;if(s.length>0){const h=s.map((t=>t.width)).sum(),a={x:e.x+(n>h?(n-h)/2:0),y:e.y+4,width:20,height:i-2},l={x:a.x+25,y:e.y};for(let e,i=0;i<s.length;++i)f.color=X[i%X.length],m.value=s[i].label,t.rect(a,0,f,r),t.text(l,m,f),e=s[i].width+25,l.x+=e,a.x+=e;e.y+=o,e.height-=o}t.groupEnd()}(s),this.#ft&&(function(e){console.debug("SVG y axis:",e);const s=Object.assign({alpha:.5},r,{width:1}),o=i+20;m.align="right",m.baseline="middle",m.size=i-2,e.x+=p.y,e.width-=p.y,t.group({name:"Y"},e);const n=e.x-10,a=e.height-o;let l=a/h,c=e.y+a;for(let i=0,o=0;i<h+1;++i,c-=l,o+=g.step)i>0&&t.line(e.x-5,c,e.x+e.width+5,c,s),m.value=o.toString(),t.text({x:n,y:c},m,r);delete m.baseline,m.size=i,t.groupEnd()}(s),x=function(e){console.debug("SVG y axis:",e);const s=e.width;let o=e;if(c.length>0){o=Object.assign({},e);let n=c;if("categorical"!=d){const t=Math.ceil(e.width/p.x);if(c.length>t){const e=Math.floor(c.length/t);n=c.filter(((t,s)=>s%e==0))}}t.group({name:"X"},e);const h=s/n.length,a=e.y+e.height,l=i+20;m.align="middle",m.baseline="text-after-edge",o.x+=h/2,o.width-=h;for(let e=0,s=o.x;e<n.length;++e,s+=h)m.value=n[e],r.alpha=.5,t.line(s,a-l,s,a-l+5,r),r.alpha=1,t.text({x:s,y:a},m,r);t.groupEnd(),e.height-=l,o.height-=l}return o}(s)),this.#xt&&function(e){console.debug("SVG axis:",e),t.group({name:"axis"},e,null,r);const s=e.y+e.height;t.line(e.x,e.y,e.x,s),t.line(e.x,s,e.x+e.width,s),t.groupEnd()}(s),this.#pt){case"bar":c.length<10?function(e){const s=a[0].data.length,i=e.width,o=e.y,h=.02*i,l=(i/s-h)/a.length,c=e.height,d=Object.assign({},r),p=Object.assign({alpha:u},f),m={x:e.x+h/2+2,width:l-4};t.group({name:"bar"},e);for(let e,i,r=0;r<s;++r){for(let s=0;s<a.length;++s)d.color=p.color=X[s%X.length],e=(g.max-a[s].data[r])/g.max,i=c*e,m.y=o+i,m.height=c-i,t.rect(m,0,p,d,n),m.x+=l;m.x+=h}t.groupEnd(),delete r.alpha}(s):w(x,"scatter");break;case"line":case"spline":case"scatter":w(x,this.#pt)}function w(e,s){t.group({name:s},e);const i=a[0].data.length-1,n=e.width/i,h=e.x,c=e.height,d=Object.assign({},r),u={center:()=>[0,0]};let p;for(let i,r,f,m,x,w=0;w<a.length;++w){if(i=h,m=a[w].data,r=m.map((t=>(x=(g.max-t)/g.max,e.y+c*x))),f=X[w%X.length],d.color=f,t.group(null,e,d,d),"scatter"!=s){p=[];for(let t=0;t<r.length;++t,i+=n)p.push(new o(i,r[t]));"spline"==s&&(p=l.toSpline(p)),t.path(u,{segments:p})}t.group(null,e);for(let e=0,s=h;e<r.length;++e,s+=n)t.circle(s,r[e],3);t.groupEnd(),t.groupEnd()}t.groupEnd()}t.groupEnd()}#kt(){const t=this.#wt.sets.map((t=>t.data));this.#yt=function(t,e,s=.1){const i=t.flat();if(0===i.length)return{min:0,max:100,step:10};let r=Math.min(...i),o=Math.max(...i),n=o;r===n&&(n+=1,r-=1);const h=n-r;r-=s*h,n+=s*h,r=0,n=function(t,e){if(0===t)return 0;const s=Math.floor(Math.log10(Math.abs(t))),i=t/Math.pow(10,s),r=[1,2,5,10];let o;for(let t=0;t<r.length;t++)if(i<=r[t]){o=r[t];break}return o=r.filter((t=>t>i))[0]||r[r.length-1],o*Math.pow(10,s)}(n);const a=function(t,e,s){const i=[.1,.2,.5,1,2,5,10,20,25,50,100,200,250,500,1e3,2e3,2500,5e3,1e4,2e4,25e3,5e4,1e5,2e5,25e4,5e5,1e6,2e6,5e6,1e7];let r=(e-t)/Math.floor(s/40);0===r&&(r=i[0]);for(let t=0;t<i.length;t++)if(r<=i[t]){r=i[t];break}return Math.round(r)}(r,n,e);for(;n-a>o;)n-=a;return{min:r,max:n,step:a}}(t,super.height)}static processData=L}function L(t){let e=t.filter((t=>t.some((t=>""!==t.trim()))));if(e.length<2)return void console.error("Not enough data to visualize.");let s=function(t){const e=t[0],s=t[1];let i=s.filter((t=>!isNaN(parseFloat(t)))).length;return e.filter((t=>isNaN(parseFloat(t)))).length>e.length/2&&i>s.length/2}(e);const i=s?e[0]:Array.from({length:e[0].length},((t,e)=>`Column ${e+1}`)),r=s?e.slice(1):e,o=function(t,e){let s={};return e.forEach(((e,i)=>{let r=t.map((t=>t[i])).filter((t=>""!==t)),o=r.slice(0,10),n=o.every((t=>{return e=t,[/^\d{4}-\d{2}-\d{2}$/,/^\d{2}\/\d{2}\/\d{4}$/,/^\d{4}\/\d{2}\/\d{2}$/,/^\d{2}-\d{2}-\d{4}$/].some((t=>t.test(e)));var e})),h=o.every((t=>{let e=parseFloat(t);return!isNaN(e)&&isFinite(e)}));n?s[e]="datetime":h?s[e]="numerical":new Set(r).size<20?s[e]="categorical":s[e]="text"})),console.log("Inferred Types:",s),s}(r,i),n=i[0],h="categorical"===o[n]||"datetime"===o[n]?n:null,a=i.filter((t=>"numerical"===o[t]));t.map((t=>a.map((e=>parseFloat(t[i.indexOf(e)])||0))));let l=[],c="bar",d=[];if(a.length>0)if(l=a.map((t=>({label:t,data:r.map((e=>parseFloat(e[i.indexOf(t)])||0))}))),h){if(c="bar",d=r.map((t=>t[i.indexOf(h)])),"datetime"==o[h]){c="line";const t={month:"short",day:"numeric"},e=d.map((t=>new Date(t)));e[0].getYear()!=e.last().getYear()&&(t.year="2-digit"),d=e.map((e=>e.toLocaleDateString("en-GB",t)))}}else c="line",d=r.map(((t,e)=>e+1));return{type:c,labels:d,sets:l,inferredTypes:o,labelColumn:h}}class Y{#St="";#Ct="";#s=400;#i=300;#Tt=new Set;set width(t){this.#s=t}set height(t){this.#i=t}constructor(t,e){this.#s=t||this.#s,this.#i=e||this.#i}rect(t,e,s,i,r){let o="";if(o+=`<rect x="${t.x}" y="${t.y}" width="${t.width}" height="${t.height}"`,e>0&&(o+=` rx="${e}" ry="${e}"`),s&&(o+=` fill="${s.color}"`,s.alpha<1&&(o+=` fill-opacity="${s.alpha}"`)),i&&(o+=` stroke="${i.color}" stroke-width="${i.width}"`),r&&(o+=` filter="url(#${this.#Pt(r)})"`),t.angle){const[e,s]=t.center();o+=` transform="rotate(${t.angle},${e},${s})"`}o+="/>",this.#Ct+=o}path(t,{segments:e,closed:s},i,r,o){const n=s?e.last():e[0],[h,a]=t.center();let l='<path d="';l+=`M${n.x+h},${n.y+a}`;for(const t of e)l+=t.toSVG(h,a);s&&(l+="Z"),l+='"',s&&i?(l+=` fill="${i.color}"`,i.alpha<1&&(l+=` fill-opacity="${i.alpha}"`)):l+=' fill="none"',r&&(l+=` stroke="${r.color}" stroke-width="${r.width}"`,r.linecap&&(l+=` stroke-linecap="${r.linecap}"`)),o&&(l+=` filter="url(#${this.#Pt(o)})"`),t.angle&&(l+=` transform="rotate(${t.angle},${h},${a})"`),l+="/>",this.#Ct+=l}circle(t,e,s,i,r,o){let n=`<circle cx="${t}" cy="${e}" r="${s}"`;i&&(n+=` fill="${i.color}"`),r&&(n+=` stroke="${r.color}" stroke-width="${r.width}"`),o&&(n+=` filter="url(#${this.#Pt(o)})"`),n+="/>",this.#Ct+=n}line(t,e,s,i,r){let o=`<line x1="${t}" y1="${e}" x2="${s}" y2="${i}"`;r&&(o+=` stroke="${r.color}" stroke-width="${r.width}"`,r.alpha<1&&(o+=` stroke-opacity="${r.alpha}"`),r.linecap&&(o+=` stroke-linecap="${r.linecap}"`)),o+="/>",this.#Ct+=o}text(t,e,s,i,r){let o="";switch(o+=`<text x="${t.x}" y="${t.y}" font-size="${e.size}" font-family="${e.font||"Arial"}"`,e.bold&&(o+=' font-weight="bold"'),e.italic&&(o+=' font-style="italic"'),e.align){case"right":o+=' text-anchor="end"';break;case"center":o+=' dominant-baseline="hanging"';case"middle":o+=' text-anchor="middle"'}if(e.baseline?o+=` dominant-baseline="${e.baseline}"`:o+=` dy="${e.size}"`,s&&(o+=` fill="${s.color}"`,s.alpha<1&&(o+=` fill-opacity="${s.alpha}"`)),i&&(o+=` stroke="${i.color}" stroke-width="${i.width}"`),r&&(o+=` filter="url(#${this.#Pt(r)})"`),t.angle){const[e,s]=H(t);o+=` transform="rotate(${t.angle},${e},${s})"`}o+=`>${e.value}</text>`,this.#Ct+=o}group(t,e,s,i){let r="<g";if(t&&t.name&&(r+=` id="${t.name}"`),s&&(r+=` fill="${s.color}"`),i&&(r+=` stroke="${i.color}" stroke-width="${i.width}"`),e.angle){const[t,s]=H(e);r+=` transform="rotate(${e.angle},${t},${s})"`}r+=">",this.#Ct+=r}groupEnd(){this.#Ct+="</g>"}toString(){let t=`<svg width="${this.#s}" height="${this.#i}" xmlns="http://www.w3.org/2000/svg">`;return this.#St&&(t+=`<defs>${this.#St}</defs>`),t+=this.#Ct,t+="</svg>",t}#Pt(t){const e=Object.hashHex(t);return this.#Tt.has(e)||(this.#Tt.add(e),this.#St+=function(t,e){const s=e.width;return`<filter id="${t}" x="-50%" y="-50%" width="200%" height="200%"><feFlood flood-color="${e.color}" result="flood"/><feComposite in2="SourceAlpha" operator="in" result="shadow"/><feGaussianBlur in="shadow" stdDeviation="3"/><feOffset dx="${s}" dy="${s}" result="offsetblur"/><feMerge><feMergeNode in="offsetblur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>`}(e,t)),e}}function H(t){return[t.x+t.width/2,t.y+t.height/2]}const V={rect:m,circle:class extends t{get type(){return"circle"}draw(t){this.drawEllipse(t)}getPath(t=this.x,e=this.y,s=1,i=1){const r=this.width/2*s,o=this.height/2*i,n=t+r,h=e+o,a=r,l=o,c=new Path2D;return c.ellipse(n,h,a,l,0,0,2*Math.PI),c}},label:m,bubble:class extends m{#Bt="left";#jt=.2;#It=0;#Et;#Dt;#k;get type(){return"bubble"}set radius(t){"string"==typeof t&&(t=parseInt(t)),super.radius=t,this.updatePath()}get radius(){return super.radius}get width(){return super.width}set width(t){super.width=t,this.updatePath()}get height(){return super.height}set height(t){super.height=t,this.updatePath()}get px(){return this.#Et}get py(){return this.#Dt}set px(t){this.#Et=t,this.#Bt=this.#Et<0?"left":"right"}set py(t){this.#Dt=t}get beak(){return this.#Bt}set beak(t){if(this.#Bt!=t){switch(t){case"left":case"right":this.#Et=-this.#Et+this.width;break;case"top":case"bottom":this.#Dt=-this.#Dt+this.height}this.#Bt=t,this.updatePath()}}get beakWidth(){return this.#jt}set beakWidth(t){"string"==typeof t&&(t=parseFloat(t)),this.#jt=t,this.updatePath()}get beakPosition(){return this.#It}set beakPosition(t){"string"==typeof t&&(t=parseFloat(t)),this.#It=t,this.updatePath()}constructor(){super(),this.#Et=-30,this.#Dt=50,this.radius=10}draw(t){this.drawPath(t,this.#k),t.save(),t.translate(this.x,this.y),this.drawText(t),t.restore()}handleClick(t,e){if(!this.isSelected())return;let s=this.x+this.#Et,i=this.y+this.#Dt;return this.inNode(t,e,s,i)?{move:(t,e)=>{this.#Et=t-this.x,this.#Dt=e-this.y,this.updatePath()}}:super.handleClick(t,e)}updatePath(){this.#k=this.getPath()}getPath(){const t=this.width,e=this.height,s=-t/2,i=-e/2,r=s+this.#Et,o=i+this.#Dt;let n=this.radius;const h=("top"==this.#Bt||"bottom"==this.#Bt?t:e)-2*n,a=h*this.#jt,l=(h-a)*this.#It;n={tl:n,tr:n,br:n,bl:n};const c=new Path2D;return c.moveTo(s+n.tl,i),"top"==this.#Bt&&(c.lineTo(s+n.tl+l,i),c.lineTo(r,o),c.lineTo(s+n.tl+l+a,i)),c.lineTo(s+t-n.tr,i),c.quadraticCurveTo(s+t,i,s+t,i+n.tr),"right"==this.#Bt&&(c.lineTo(s+t,i+n.tl+l),c.lineTo(r,o),c.lineTo(s+t,i+n.tl+a+l)),c.lineTo(s+t,i+e-n.br),c.quadraticCurveTo(s+t,i+e,s+t-n.br,i+e),"bottom"==this.#Bt&&(c.lineTo(s+n.tl+l+a,i+e),c.lineTo(r,o),c.lineTo(s+n.tl+l,i+e)),c.lineTo(s+n.bl,i+e),c.quadraticCurveTo(s,i+e,s,i+e-n.bl),"left"==this.#Bt&&(c.lineTo(s,i+n.tl+a+l),c.lineTo(r,o),c.lineTo(s,i+n.tl+l)),c.lineTo(s,i+n.tl),c.quadraticCurveTo(s,i,s+n.tl,i),c.closePath(),c}drawSelection(t,e){this.drawNode(t,this.x+this.#Et,this.y+this.#Dt),super.drawSelection(t)}},text:p,emoji:class extends p{get type(){return"emoji"}constructor(t){super(),this.value=t,this.font="Win32"==window.navigator.platform?"Noto Color Emoji":"emoji",this.size=50}},icon:class extends p{get type(){return"icon"}constructor(t){super(),this.value=t,this.font="FontAwesome",this.size=70}calculateBorderSize(){this.width=this.size,this.height=this.size}},image:O,path:l,arrow:class extends t{#At=[200,0];#_t="end";get type(){return"arrow"}constructor(){super(),this.width=200,this.height=20}get y(){return super.y+this.height/2}set y(t){"string"==typeof t&&(t=parseInt(t)),super.y=t-this.height/2}set fill(t){}get fill(){return this.stroke}get stroke(){return super.stroke}set stroke(t){super.stroke=t,super.fill=t}get arrow(){return this.#_t}set arrow(t){this.#_t=t}draw(t){let[e,s,i,r]=this.#Mt();const o=8+1.3*this.strokeWidth;t.save(),t.translate(e,s),t.rotate(this.angle);let n,h,a=i-e,l=r-s;if(e=0,"begin"==this.#_t||"both"==this.#_t){e+=o;const t=new Path2D;t.moveTo(o,o/2),t.lineTo(0,0),t.lineTo(o,-o/2),t.closePath(),n=t}else this.#zt(t,0,0);if("end"==this.#_t||"both"==this.#_t){a-=o;const t=new Path2D;t.moveTo(a,o/2),t.lineTo(a+o,0),t.lineTo(a,-o/2),t.closePath(),h=t}else this.#zt(t,a,l);this.drawLine(t,a+1,l,e,0),n&&this.fillPath(t,n,!1,0),h&&this.fillPath(t,h,!1,0),this.drawLine(t,a+1,0,e-1,0,!1),t.restore(),super.draw(t)}drawSelection(t){const[e,s,i,r]=this.#Mt();t.save(),t.translate(e,s),t.rotate(this.angle),this.drawNode(t,0,0),this.drawNode(t,i-e,r-s),t.restore()}drawSVG(t){const e=this.stroke,s=this.x,i=this.y,r=this.box();let n,h=s,a=this.x+this.width,l=.7*this.strokeWidth;l<2&&(l=2),r.x=0,r.y=0,r.width=0,r.height=0,t.group(r,{color:e,alpha:1},{color:e,width:this.strokeWidth}),r.angle=0,"both"==this.#_t?(a-=8,h+=8,n=[new o(h,i),new o(h,i+4),new o(h-8,i),new o(h,i-4),new o(h,i),new o(a,i),new o(a,i+4),new o(a+8,i),new o(a,i-4),new o(a,i)]):"end"==this.#_t?(a-=8,n=[new o(h,i),new o(a,i),new o(a,i+4),new o(a+8,i),new o(a,i-4),new o(a,i)],t.circle(h,i,l)):"begin"==this.#_t?(h+=8,n=[new o(a,i),new o(h,i),new o(h,i+4),new o(h-8,i),new o(h,i-4),new o(h,i)],t.circle(a,i,l)):(n=[new o(h,i),new o(a,i)],t.circle(h,i,l),t.circle(a,i,l)),t.path(r,{segments:n,closed:!0}),t.groupEnd()}handleClick(t,e){const[s,i,r,o]=this.#Mt(!0);return this.inNode(t,e,s,i)?{move:(t,e)=>{this.x=Math.round(t),this.y=Math.round(e-this.height/2)}}:this.inNode(t,e,r,o)?{move:(t,e)=>{const[s,i]=this.#Mt();let r=Math.asin((e-i)/this.width);isNaN(r)?r=e>i?Math.PI/2:3*Math.PI/2:t<s?r=Math.PI-r:r<0&&(r=2*Math.PI+r),this.width=e==i?Math.abs(t-s):t==s?Math.abs(e-i):Math.hypot(t-s,e-i),this.angle=r}}:null}handleSelect(t,e){const s=this.x,i=this.y,r=this.angle,o=t-s,n=e-i,h=Math.cos(-r),a=Math.sin(-r),l=o*h-n*a+s,c=o*a+n*h+i,d=this.x,u=super.y,g=d+this.width,p=u+this.height;return l>=d&&l<=g&&c>=u&&c<=p?this:null}#zt(t,e,s){let i=.7*this.strokeWidth;i<2&&(i=2),this.drawNode(t,e,s,this.stroke,!0,i)}#Mt(t=!1){let e=this.x,s=this.y,i=this.width,r=0;return t&&(r=i*Math.sin(this.angle),i*=Math.cos(this.angle)),[e,s,e+i,s+r]}},chart:G,group:class extends t{#Rt=[];get type(){return"group"}get objects(){return this.#Rt}load(t,e){const s=[],i=t.objects;let r;delete t.objects,super.load(t);for(let t of i)r=e.create(t.type,this.id,t.id),r.load(t,e),s.push(r);this.#Rt=s}draw(t){t.save();const{x:e,y:s}=this.setGeometry(t);t.translate(e,s);for(const e of this.#Rt)e.visible&&e.draw(t);t.restore()}drawSelection(t){let e=!1;t.save();const{x:s,y:i}=this.setGeometry(t);t.translate(s,i);for(const s of this.#Rt)if(e=s.isSelected()){s.drawSelection(t);break}t.restore(),e||(this.drawBorder(t,1,"#888",-1,!0),super.drawSelection(t))}drawSVG(t,e){const s=this.box(0,e);t.group(null,s);for(const e of this.#Rt)e.drawSVG(t,{x:-s.x,y:-s.y});t.groupEnd()}isSelected(){for(const t of this.#Rt)if(t.isSelected())return!0;return super.isSelected()}handleClick(t,e){let s,{X:i,Y:r,ox:o,oy:n,angle:h}=this.getGeometry(t,e),a=this.width/2,l=this.height/2,c=this.#Wt();o+=a,n+=l;for(const t of c)if(s=t.handleClick(o,n))return{move(t,e){if(t-=i,e-=r,h){const s=Math.cos(-h),i=Math.sin(-h),r=t*i+e*s;t=t*s-e*i,e=r}s.move(t+a,e+l)}};return super.handleClick(t,e)}handleSelect(t,e,s){const i=this.#Wt();let{ox:r,oy:o}=this.getGeometry(t,e);r+=this.width/2,o+=this.height/2;for(const t of i)if(t.handleSelect(r,o))return this.selected=!1,t;return super.handleSelect(t,e,s)}addObjects(t){if(0==this.#Rt.length){const e=5,s=function(t){let e=1/0,s=1/0,i=-1/0,r=-1/0;for(const o of t)e=Math.min(e,o.x),s=Math.min(s,o.y),i=Math.max(i,o.x+o.width),r=Math.max(r,o.y+o.height);return{x:e,y:s,width:i-e,height:r-s}}(t);this.x=s.x-e,this.y=s.y-e,this.width=s.width+2*e,this.height=s.height+2*e}const e=this.angle,s=2*Math.PI;let i;for(const r of t)r.x=r.x-this.x,r.y=r.y-this.y,i=e+r.angle,i>=s&&(i-=s),r.angle=i,this.#Rt.push(r)}#Wt(){return[...this.#Rt].reverse()}},canvas:s};class q extends EventTarget{#Ft=[];#Rt=new Map;get objects(){return this.#Ft}get all(){return Array.from(this.#Rt.values())}on(t,e){this.addEventListener(t,e)}emit(t,e){this.dispatchEvent(new CustomEvent(t,{detail:e}))}find(t){return this.#Rt.get(t)}findGroup(t,e=!1,s=e){const i="string"==typeof t?t:t.id,r=t=>{const s=t.objects,r=s.findIndex((t=>t.id==i));if(r>=0){if(e){const[t]=s.splice(r,1);"purge"==e&&(t.release(),this.#Rt.delete(i))}return t}};let o;for(let t of this.#Rt.values())if("group"===t.type&&(o=r(t),o))return o;return r(this)}reset(){const t=this.all;this.#Ft=[],this.#Rt.clear();for(const e of t)e.release();return t}save(){return 0==this.#Ft.length?(console.warn("Nothing to save"),!1):this.#Ft.map((t=>t.save()))}open(t){let e;for(let s of t)e=this.create(s.type,null,s.id),e.load(s,this);return this.all}create(t,e,s){const i="string"==typeof t?q.create(t):t;return s&&(i.id=s),this.#Rt.set(i.id,i),e?("string"==typeof e?this.#Rt.get(e):e).objects.push(i):this.#Ft.push(i),i}remove(t){return this.findGroup(t,"purge")}copy(t){const e="string"==typeof t?t:t.id,s=this.findGroup(e),i=s.objects,r=i.findIndex((t=>t.id==e)),o=i[r].clone();return this.create(o,s),o}reorderObject(t,e){const s=this.findGroup(t).objects,i=s.findIndex((e=>e.id==t)),r=Math.max(0,Math.min(s.length-1,i+e)),o=s[i];return s.splice(i,1),s.splice(r,0,o),s[i].id}static create(e,...s){return new(V[e]||t)(...s)}}class K extends q{#Ot={x:1,y:1};#Nt;#$t=1;#r=0;#o=0;get canvas(){return this.#Nt.canvas}get context(){return this.#Nt}get width(){return this.canvas.width}get height(){return this.canvas.height}constructor(t){super(),this.#Nt=t.getContext("2d");const e=t.getBoundingClientRect();this.setSize(e.width,e.height)}get zoom(){return this.#$t}set zoom(t){this.#$t=t,this.updateView(),this.draw()}reset(){const t=super.reset();return this.#$t=1,this.#r=0,this.#o=0,this.draw(),t}setSize(t,e){const s=t,i=e,r=this.canvas,o=4/3;let n=s,h=s/o;h>i&&(h=i,n=i*o),r.style.width=`${n}px`,r.style.height=`${h}px`,this.#Ot.x=r.width/n,this.#Ot.y=r.height/h}add(t,e=null){const s=this.create(t,e);return s&&(this.draw(),this.emit("newobject",s.id)),s}remove(t){super.remove(t),this.draw()}draw(t=!1,...e){const s=this.#Nt;s.save(),s.clearRect(0,0,this.canvas.width,this.canvas.height),s.translate(this.#r,this.#o),s.scale(this.#$t,this.#$t),this.drawBefore(s);for(const i of this.objects)i.visible&&(i.draw(s,...e),t&&i.isSelected()&&i.drawSelection(s,...e));this.drawAfter(s,...e),s.restore()}drawBefore(){}drawAfter(){}toSVG(t){const e=Math.ceil(t.width),s=Math.ceil(t.height),i=new Y(e,s);for(const e of this.objects)e.visible&&e.drawSVG(i,t);return i.toString()}getCordinates(t,e){return[t*this.#Ot.x/this.#$t-this.#r,e*this.#Ot.y/this.#$t-this.#o]}updateZoom(t){this.#$t+=t,this.updateView()}updatePosition(t,e){this.#r+=t,this.#o+=e}updateView(t=!1){const e=this.canvas.width,s=this.canvas.height,i=e*this.#$t,r=s*this.#$t;(this.#$t<=1||t)&&(this.#r=(e-i)/2,this.#o=(s-r)/2)}}const J=function(){function t(t,e,s,i,r){this.gl=t,this.id=t.createTexture(),this.width=e,this.height=s,this.format=i,this.type=r,t.bindTexture(t.TEXTURE_2D,this.id),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e&&s&&t.texImage2D(t.TEXTURE_2D,0,this.format,e,s,0,this.format,this.type,null)}t.fromElement=function(e,s){var i=new t(e,0,0,e.RGBA,e.UNSIGNED_BYTE);return i.loadContentsOf(s),i},t.prototype.loadContentsOf=function(t){this.width=t.width||t.videoWidth,this.height=t.height||t.videoHeight,this.gl.bindTexture(this.gl.TEXTURE_2D,this.id),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.format,this.format,this.type,t)},t.prototype.initFromBytes=function(t,e,s){this.width=t,this.height=e,this.format=this.gl.RGBA,this.type=this.gl.UNSIGNED_BYTE,this.gl.bindTexture(this.gl.TEXTURE_2D,this.id),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,e,0,this.gl.RGBA,this.type,new Uint8Array(s))},t.prototype.destroy=function(){this.gl.deleteTexture(this.id),this.id=null},t.prototype.use=function(t){this.gl.activeTexture(this.gl.TEXTURE0+(t||0)),this.gl.bindTexture(this.gl.TEXTURE_2D,this.id)},t.prototype.unuse=function(t){this.gl.activeTexture(this.gl.TEXTURE0+(t||0)),this.gl.bindTexture(this.gl.TEXTURE_2D,null)},t.prototype.ensureFormat=function(t,e,s,i){if(1==arguments.length){var r=arguments[0];t=r.width,e=r.height,s=r.format,i=r.type}t==this.width&&e==this.height&&s==this.format&&i==this.type||(this.width=t,this.height=e,this.format=s,this.type=i,this.gl.bindTexture(this.gl.TEXTURE_2D,this.id),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.format,t,e,0,this.format,this.type,null))},t.prototype.drawTo=function(t){if(this.gl.framebuffer=this.gl.framebuffer||this.gl.createFramebuffer(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.gl.framebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.id,0),this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!==this.gl.FRAMEBUFFER_COMPLETE)throw new Error("incomplete framebuffer");this.gl.viewport(0,0,this.width,this.height),t(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};var e=null;function s(t){null==e&&(e=document.createElement("canvas")),e.width=t.width,e.height=t.height;var s=e.getContext("2d");return s.clearRect(0,0,e.width,e.height),s}return t.prototype.fillUsingCanvas=function(t){return t(s(this)),this.format=this.gl.RGBA,this.type=this.gl.UNSIGNED_BYTE,this.gl.bindTexture(this.gl.TEXTURE_2D,this.id),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this},t.prototype.toImage=function(t){this.use(),Shader.getDefaultShader().drawRect();var i=this.width*this.height*4,r=new Uint8Array(i),o=s(this),n=o.createImageData(this.width,this.height);this.gl.readPixels(0,0,this.width,this.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,r);for(var h=0;h<i;h++)n.data[h]=r[h];o.putImageData(n,0,0),t.src=e.toDataURL()},t.prototype.swapWith=function(t){var e;e=t.id,t.id=this.id,this.id=e,e=t.width,t.width=this.width,this.width=e,e=t.height,t.height=this.height,this.height=e,e=t.format,t.format=this.format,this.format=e},t}(),Z=function(){function t(t){return"[object Number]"==Object.prototype.toString.call(t)}function e(t,e,s){var i=t.createShader(e);if(t.shaderSource(i,s),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw"compile error: "+t.getShaderInfoLog(i);return i}function s(t,s,i){if(this.vertexAttribute=null,this.texCoordAttribute=null,this.program=t.createProgram(),s=s||"\tattribute vec2 vertex;\tattribute vec2 _texCoord;\tvarying vec2 texCoord;\tvoid main() {\t\ttexCoord = _texCoord;\t\tgl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);\t}",i="precision highp float;"+(i=i||"\tuniform sampler2D texture;\tvarying vec2 texCoord;\tvoid main() {\t\tgl_FragColor = texture2D(texture, texCoord);\t}"),t.attachShader(this.program,e(t,t.VERTEX_SHADER,s)),t.attachShader(this.program,e(t,t.FRAGMENT_SHADER,i)),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))throw"link error: "+t.getProgramInfoLog(this.program);this.gl=t}return s.prototype.destroy=function(){this.gl.deleteProgram(this.program),this.program=null},s.prototype.uniforms=function(e){for(var s in this.gl.useProgram(this.program),e)if(e.hasOwnProperty(s)){var i=this.gl.getUniformLocation(this.program,s);if(null!==i){var r=e[s];if(o=r,"[object Array]"==Object.prototype.toString.call(o))switch(r.length){case 1:this.gl.uniform1fv(i,new Float32Array(r));break;case 2:this.gl.uniform2fv(i,new Float32Array(r));break;case 3:this.gl.uniform3fv(i,new Float32Array(r));break;case 4:this.gl.uniform4fv(i,new Float32Array(r));break;case 9:this.gl.uniformMatrix3fv(i,!1,new Float32Array(r));break;case 16:this.gl.uniformMatrix4fv(i,!1,new Float32Array(r));break;default:throw"dont't know how to load uniform \""+s+'" of length '+r.length}else{if(!t(r))throw'attempted to set uniform "'+s+'" to invalid value '+(r||"undefined").toString();this.gl.uniform1f(i,r)}}}var o;return this},s.prototype.textures=function(t){for(var e in this.gl.useProgram(this.program),t)t.hasOwnProperty(e)&&this.gl.uniform1i(this.gl.getUniformLocation(this.program,e),t[e]);return this},s.prototype.drawRect=function(t,e,s,i){var r,o=this.gl.getParameter(this.gl.VIEWPORT);e=e!==r?(e-o[1])/o[3]:0,t=t!==r?(t-o[0])/o[2]:0,s=s!==r?(s-o[0])/o[2]:1,i=i!==r?(i-o[1])/o[3]:1,null==this.gl.vertexBuffer&&(this.gl.vertexBuffer=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([t,e,t,i,s,e,s,i]),this.gl.STATIC_DRAW),null==this.gl.texCoordBuffer&&(this.gl.texCoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl.texCoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),this.gl.STATIC_DRAW)),null==this.vertexAttribute&&(this.vertexAttribute=this.gl.getAttribLocation(this.program,"vertex"),this.gl.enableVertexAttribArray(this.vertexAttribute)),null==this.texCoordAttribute&&(this.texCoordAttribute=this.gl.getAttribLocation(this.program,"_texCoord"),this.gl.enableVertexAttribArray(this.texCoordAttribute)),this.gl.useProgram(this.program),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl.vertexBuffer),this.gl.vertexAttribPointer(this.vertexAttribute,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl.texCoordBuffer),this.gl.vertexAttribPointer(this.texCoordAttribute,2,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)},s.getDefaultShader=function(t){return t.defaultShader=t.defaultShader||new s(t),t.defaultShader},s}();function Q(t,e,s){return new Z(t,null,e+"\tuniform sampler2D texture;\tuniform vec2 texSize;\tvarying vec2 texCoord;\tvoid main() {\t\tvec2 coord = texCoord * texSize;\t\t"+s+"\t\tgl_FragColor = texture2D(texture, coord / texSize);\t\tvec2 clampedCoord = clamp(coord, vec2(0.0), texSize);\t\tif (coord != clampedCoord) {\t\t\t/* fade to transparent if we are outside the image */\t\t\tgl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));\t\t}\t}")}const tt="\tfloat random(vec3 scale, float seed) {\t\t/* use the fragment position for a different seed per-pixel */\t\treturn fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);\t}";function et(t,e,s){return Math.max(t,Math.min(e,s))}function st(t,e){const s=this._.gl,i=this.simpleShader;return s.brightnessContrast=s.brightnessContrast||new Z(s,null,"\t\tuniform sampler2D texture;\t\tuniform float brightness;\t\tuniform float contrast;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tcolor.rgb += brightness;\t\t\tif (contrast > 0.0) {\t\t\t\tcolor.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;\t\t\t} else {\t\t\t\tcolor.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;\t\t\t}\t\t\tgl_FragColor = color;\t\t}\t"),i.call(this,s.brightnessContrast,{brightness:et(-1,t,1),contrast:et(-1,e,1)}),this}function it(t,e,s){return gl.hexagonalPixelate=gl.hexagonalPixelate||new Z(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 center;\t\tuniform float scale;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec2 tex = (texCoord * texSize - center) / scale;\t\t\ttex.y /= 0.866025404;\t\t\ttex.x -= tex.y * 0.5;\t\t\t\t\t\tvec2 a;\t\t\tif (tex.x + tex.y - floor(tex.x) - floor(tex.y) < 1.0) a = vec2(floor(tex.x), floor(tex.y));\t\t\telse a = vec2(ceil(tex.x), ceil(tex.y));\t\t\tvec2 b = vec2(ceil(tex.x), floor(tex.y));\t\t\tvec2 c = vec2(floor(tex.x), ceil(tex.y));\t\t\t\t\t\tvec3 TEX = vec3(tex.x, tex.y, 1.0 - tex.x - tex.y);\t\t\tvec3 A = vec3(a.x, a.y, 1.0 - a.x - a.y);\t\t\tvec3 B = vec3(b.x, b.y, 1.0 - b.x - b.y);\t\t\tvec3 C = vec3(c.x, c.y, 1.0 - c.x - c.y);\t\t\t\t\t\tfloat alen = length(TEX - A);\t\t\tfloat blen = length(TEX - B);\t\t\tfloat clen = length(TEX - C);\t\t\t\t\t\tvec2 choice;\t\t\tif (alen < blen) {\t\t\t\tif (alen < clen) choice = a;\t\t\t\telse choice = c;\t\t\t} else {\t\t\t\tif (blen < clen) choice = b;\t\t\t\telse choice = c;\t\t\t}\t\t\t\t\t\tchoice.x += choice.y * 0.5;\t\t\tchoice.y *= 0.866025404;\t\t\tchoice *= scale / texSize;\t\t\tgl_FragColor = texture2D(texture, choice + center / texSize);\t\t}\t"),simpleShader.call(this,gl.hexagonalPixelate,{center:[t,e],scale:s,texSize:[this.width,this.height]}),this}function rt(t,e){const s=this._.gl,i=this.simpleShader;return s.hueSaturation=s.hueSaturation||new Z(s,null,"\t\tuniform sampler2D texture;\t\tuniform float hue;\t\tuniform float saturation;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\t\t\t\t/* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */\t\t\tfloat angle = hue * 3.14159265;\t\t\tfloat s = sin(angle), c = cos(angle);\t\t\tvec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;\t\t\tfloat len = length(color.rgb);\t\t\tcolor.rgb = vec3(\t\t\t\tdot(color.rgb, weights.xyz),\t\t\t\tdot(color.rgb, weights.zxy),\t\t\t\tdot(color.rgb, weights.yzx)\t\t\t);\t\t\t\t\t\t/* saturation adjustment */\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\t\t\tif (saturation > 0.0) {\t\t\t\tcolor.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));\t\t\t} else {\t\t\t\tcolor.rgb += (average - color.rgb) * (-saturation);\t\t\t}\t\t\t\t\t\tgl_FragColor = color;\t\t}\t"),i.call(this,s.hueSaturation,{hue:et(-1,t,1),saturation:et(-1,e,1)}),this}function ot(t,e,s,i){return gl.colorHalftone=gl.colorHalftone||new Z(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 center;\t\tuniform float angle;\t\tuniform float scale;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\t\t\tfloat pattern(float angle) {\t\t\tfloat s = sin(angle), c = cos(angle);\t\t\tvec2 tex = texCoord * texSize - center;\t\t\tvec2 point = vec2(\t\t\t\tc * tex.x - s * tex.y,\t\t\t\ts * tex.x + c * tex.y\t\t\t) * scale;\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\t\t}\t\t\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tvec3 cmy = 1.0 - color.rgb;\t\t\tfloat k = min(cmy.x, min(cmy.y, cmy.z));\t\t\tcmy = (cmy - k) / (1.0 - k);\t\t\tcmy = clamp(cmy * 10.0 - 3.0 + vec3(pattern(angle + 0.26179), pattern(angle + 1.30899), pattern(angle)), 0.0, 1.0);\t\t\tk = clamp(k * 10.0 - 5.0 + pattern(angle + 0.78539), 0.0, 1.0);\t\t\tgl_FragColor = vec4(1.0 - cmy - k, color.a);\t\t}\t"),simpleShader.call(this,gl.colorHalftone,{center:[t,e],angle:s,scale:Math.PI/i,texSize:[this.width,this.height]}),this}function nt(t){const e=this._.gl;return e.triangleBlur=e.triangleBlur||new Z(e,null,"\t\tuniform sampler2D texture;\t\tuniform vec2 delta;\t\tvarying vec2 texCoord;\t\t"+tt+"\t\tvoid main() {\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tfor (float t = -30.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset - 0.5) / 30.0;\t\t\t\tfloat weight = 1.0 - abs(percent);\t\t\t\tvec4 sample = texture2D(texture, texCoord + delta * percent);\t\t\t\t\t\t\t\t/* switch to pre-multiplied alpha to correctly blur transparent images */\t\t\t\tsample.rgb *= sample.a;\t\t\t\t\t\t\t\tcolor += sample * weight;\t\t\t\ttotal += weight;\t\t\t}\t\t\t\t\t\tgl_FragColor = color / total;\t\t\t\t\t\t/* switch back from pre-multiplied alpha */\t\t\tgl_FragColor.rgb /= gl_FragColor.a + 0.00001;\t\t}\t"),this.simpleShader.call(this,e.triangleBlur,{delta:[t/this.width,0]}),this.simpleShader.call(this,e.triangleBlur,{delta:[0,t/this.height]}),this}function ht(t,e){const s=this._.gl,i=this.simpleShader;return s.unsharpMask=s.unsharpMask||new Z(s,null,"\t\tuniform sampler2D blurredTexture;\t\tuniform sampler2D originalTexture;\t\tuniform float strength;\t\tuniform float threshold;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 blurred = texture2D(blurredTexture, texCoord);\t\t\tvec4 original = texture2D(originalTexture, texCoord);\t\t\tgl_FragColor = mix(blurred, original, 1.0 + strength);\t\t}\t"),this._.extraTexture.ensureFormat(this._.texture),this._.texture.use(),this._.extraTexture.drawTo((function(){Z.getDefaultShader(s).drawRect()})),this._.extraTexture.use(1),this.triangleBlur(t),s.unsharpMask.textures({originalTexture:1}),i.call(this,s.unsharpMask,{strength:e}),this._.extraTexture.unuse(1),this}function at(t,e,s,i,r,o,n,h){var a=s-r,l=i-o,c=n-r,d=h-o,u=t-s+r-n,g=e-i+o-h,p=a*d-c*l,f=(u*d-c*g)/p,m=(a*g-u*l)/p;return[s-t+f*s,i-e+f*i,f,n-t+m*n,h-e+m*h,m,t,e,1]}function lt(t,e){var s=at.apply(null,e),i=at.apply(null,t),r=function(t,e){return[t[0]*e[0]+t[1]*e[3]+t[2]*e[6],t[0]*e[1]+t[1]*e[4]+t[2]*e[7],t[0]*e[2]+t[1]*e[5]+t[2]*e[8],t[3]*e[0]+t[4]*e[3]+t[5]*e[6],t[3]*e[1]+t[4]*e[4]+t[5]*e[7],t[3]*e[2]+t[4]*e[5]+t[5]*e[8],t[6]*e[0]+t[7]*e[3]+t[8]*e[6],t[6]*e[1]+t[7]*e[4]+t[8]*e[7],t[6]*e[2]+t[7]*e[5]+t[8]*e[8]]}(function(t){var e=t[0],s=t[1],i=t[2],r=t[3],o=t[4],n=t[5],h=t[6],a=t[7],l=t[8],c=e*o*l-e*n*a-s*r*l+s*n*h+i*r*a-i*o*h;return[(o*l-n*a)/c,(i*a-s*l)/c,(s*n-i*o)/c,(n*h-r*l)/c,(e*l-i*h)/c,(i*r-e*n)/c,(r*a-o*h)/c,(s*h-e*a)/c,(e*o-s*r)/c]}(s),i);return this.matrixWarp(r)}function ct(t,e,s){if(gl.matrixWarp=gl.matrixWarp||Q("\t\tuniform mat3 matrix;\t\tuniform bool useTextureSpace;\t","\t\tif (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;\t\tvec3 warp = matrix * vec3(coord, 1.0);\t\tcoord = warp.xy / warp.z;\t\tif (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;\t"),4==(t=Array.prototype.concat.apply([],t)).length)t=[t[0],t[1],0,t[2],t[3],0,0,0,1];else if(9!=t.length)throw"can only warp with 2x2 or 3x3 matrix";return simpleShader.call(this,gl.matrixWarp,{matrix:e?getInverse(t):t,texSize:[this.width,this.height],useTextureSpace:0|s}),this}function dt(t,e,s,i){const r=this._.gl,o=this.simpleShader;return r.bulgePinch=r.bulgePinch||Q(r,"\t\tuniform float radius;\t\tuniform float strength;\t\tuniform vec2 center;\t","\t\tcoord -= center;\t\tfloat distance = length(coord);\t\tif (distance < radius) {\t\t\tfloat percent = distance / radius;\t\t\tif (strength > 0.0) {\t\t\t\tcoord *= mix(1.0, smoothstep(0.0, radius / distance, percent), strength * 0.75);\t\t\t} else {\t\t\t\tcoord *= mix(1.0, pow(percent, 1.0 + strength * 0.75) * radius / distance, 1.0 - percent);\t\t\t}\t\t}\t\tcoord += center;\t"),o.call(this,r.bulgePinch,{radius:s,strength:clamp(-1,i,1),center:[t,e],texSize:[this.width,this.height]}),this}function ut(t,e,s,i,r,o){gl.tiltShift=gl.tiltShift||new Z(null,"\t\tuniform sampler2D texture;\t\tuniform float blurRadius;\t\tuniform float gradientRadius;\t\tuniform vec2 start;\t\tuniform vec2 end;\t\tuniform vec2 delta;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\t"+randomShaderFunc+"\t\tvoid main() {\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tvec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));\t\t\tfloat radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;\t\t\tfor (float t = -30.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset - 0.5) / 30.0;\t\t\t\tfloat weight = 1.0 - abs(percent);\t\t\t\tvec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);\t\t\t\t\t\t\t\t/* switch to pre-multiplied alpha to correctly blur transparent images */\t\t\t\tsample.rgb *= sample.a;\t\t\t\t\t\t\t\tcolor += sample * weight;\t\t\t\ttotal += weight;\t\t\t}\t\t\t\t\t\tgl_FragColor = color / total;\t\t\t\t\t\t/* switch back from pre-multiplied alpha */\t\t\tgl_FragColor.rgb /= gl_FragColor.a + 0.00001;\t\t}\t");var n=s-t,h=i-e,a=Math.sqrt(n*n+h*h);return simpleShader.call(this,gl.tiltShift,{blurRadius:r,gradientRadius:o,start:[t,e],end:[s,i],delta:[n/a,h/a],texSize:[this.width,this.height]}),simpleShader.call(this,gl.tiltShift,{blurRadius:r,gradientRadius:o,start:[t,e],end:[s,i],delta:[-h/a,n/a],texSize:[this.width,this.height]}),this}function gt(t,e,s,i){return gl.dotScreen=gl.dotScreen||new Z(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 center;\t\tuniform float angle;\t\tuniform float scale;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\t\t\tfloat pattern() {\t\t\tfloat s = sin(angle), c = cos(angle);\t\t\tvec2 tex = texCoord * texSize - center;\t\t\tvec2 point = vec2(\t\t\t\tc * tex.x - s * tex.y,\t\t\t\ts * tex.x + c * tex.y\t\t\t) * scale;\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\t\t}\t\t\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\t\t\tgl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);\t\t}\t"),simpleShader.call(this,gl.dotScreen,{center:[t,e],angle:s,scale:Math.PI/i,texSize:[this.width,this.height]}),this}function pt(t){return gl.edgeWork1=gl.edgeWork1||new Z(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 delta;\t\tvarying vec2 texCoord;\t\t"+randomShaderFunc+"\t\tvoid main() {\t\t\tvec2 color = vec2(0.0);\t\t\tvec2 total = vec2(0.0);\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tfor (float t = -30.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset - 0.5) / 30.0;\t\t\t\tfloat weight = 1.0 - abs(percent);\t\t\t\tvec3 sample = texture2D(texture, texCoord + delta * percent).rgb;\t\t\t\tfloat average = (sample.r + sample.g + sample.b) / 3.0;\t\t\t\tcolor.x += average * weight;\t\t\t\ttotal.x += weight;\t\t\t\tif (abs(t) < 15.0) {\t\t\t\t\tweight = weight * 2.0 - 1.0;\t\t\t\t\tcolor.y += average * weight;\t\t\t\t\ttotal.y += weight;\t\t\t\t}\t\t\t}\t\t\tgl_FragColor = vec4(color / total, 0.0, 1.0);\t\t}\t"),gl.edgeWork2=gl.edgeWork2||new Z(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 delta;\t\tvarying vec2 texCoord;\t\t"+randomShaderFunc+"\t\tvoid main() {\t\t\tvec2 color = vec2(0.0);\t\t\tvec2 total = vec2(0.0);\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tfor (float t = -30.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset - 0.5) / 30.0;\t\t\t\tfloat weight = 1.0 - abs(percent);\t\t\t\tvec2 sample = texture2D(texture, texCoord + delta * percent).xy;\t\t\t\tcolor.x += sample.x * weight;\t\t\t\ttotal.x += weight;\t\t\t\tif (abs(t) < 15.0) {\t\t\t\t\tweight = weight * 2.0 - 1.0;\t\t\t\t\tcolor.y += sample.y * weight;\t\t\t\t\ttotal.y += weight;\t\t\t\t}\t\t\t}\t\t\tfloat c = clamp(10000.0 * (color.y / total.y - color.x / total.x) + 0.5, 0.0, 1.0);\t\t\tgl_FragColor = vec4(c, c, c, 1.0);\t\t}\t"),simpleShader.call(this,gl.edgeWork1,{delta:[t/this.width,0]}),simpleShader.call(this,gl.edgeWork2,{delta:[0,t/this.height]}),this}function ft(t,e,s){const i=this._.gl,r=this.simpleShader;i.lensBlurPrePass=i.lensBlurPrePass||new Z(i,null,"\t\tuniform sampler2D texture;\t\tuniform float power;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tcolor = pow(color, vec4(power));\t\t\tgl_FragColor = vec4(color);\t\t}\t");var o="\t\tuniform sampler2D texture0;\t\tuniform sampler2D texture1;\t\tuniform vec2 delta0;\t\tuniform vec2 delta1;\t\tuniform float power;\t\tvarying vec2 texCoord;\t\t"+tt+"\t\tvec4 sample(vec2 delta) {\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(delta, 151.7182), 0.0);\t\t\t\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\tfor (float t = 0.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset) / 30.0;\t\t\t\tcolor += texture2D(texture0, texCoord + delta * percent);\t\t\t\ttotal += 1.0;\t\t\t}\t\t\treturn color / total;\t\t}\t";i.lensBlur0=i.lensBlur0||new Z(i,null,o+"\t\tvoid main() {\t\t\tgl_FragColor = sample(delta0);\t\t}\t"),i.lensBlur1=i.lensBlur1||new Z(i,null,o+"\t\tvoid main() {\t\t\tgl_FragColor = (sample(delta0) + sample(delta1)) * 0.5;\t\t}\t"),i.lensBlur2=i.lensBlur2||new Z(i,null,o+"\t\tvoid main() {\t\t\tvec4 color = (sample(delta0) + 2.0 * texture2D(texture1, texCoord)) / 3.0;\t\t\tgl_FragColor = pow(color, vec4(power));\t\t}\t").textures({texture1:1});for(var n=[],h=0;h<3;h++){var a=s+h*Math.PI*2/3;n.push([t*Math.sin(a)/this.width,t*Math.cos(a)/this.height])}var l=Math.pow(10,et(-1,e,1));return r.call(this,i.lensBlurPrePass,{power:l}),this._.extraTexture.ensureFormat(this._.texture),r.call(this,i.lensBlur0,{delta0:n[0]},this._.texture,this._.extraTexture),r.call(this,i.lensBlur1,{delta0:n[1],delta1:n[2]},this._.extraTexture,this._.extraTexture),r.call(this,i.lensBlur0,{delta0:n[1]}),this._.extraTexture.use(1),r.call(this,i.lensBlur2,{power:1/l,delta0:n[2]}),this}function mt(t,e,s){const i=this._.gl;return i.zoomBlur=i.zoomBlur||new Z(i,null,"\t\tuniform sampler2D texture;\t\tuniform vec2 center;\t\tuniform float strength;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\t"+tt+"\t\tvoid main() {\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\tvec2 toCenter = center - texCoord * texSize;\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tfor (float t = 0.0; t <= 40.0; t++) {\t\t\t\tfloat percent = (t + offset) / 40.0;\t\t\t\tfloat weight = 4.0 * (percent - percent * percent);\t\t\t\tvec4 sample = texture2D(texture, texCoord + toCenter * percent * strength / texSize);\t\t\t\t\t\t\t\t/* switch to pre-multiplied alpha to correctly blur transparent images */\t\t\t\tsample.rgb *= sample.a;\t\t\t\t\t\t\t\tcolor += sample * weight;\t\t\t\ttotal += weight;\t\t\t}\t\t\t\t\t\tgl_FragColor = color / total;\t\t\t\t\t\t/* switch back from pre-multiplied alpha */\t\t\tgl_FragColor.rgb /= gl_FragColor.a + 0.00001;\t\t}\t"),this.simpleShader.call(this,i.zoomBlur,{center:[t,e],strength:s,texSize:[this.width,this.height]}),this}function xt(t){const e=this._.gl,s=this.simpleShader;return e.noise=e.noise||new Z(e,null,"\t\tuniform sampler2D texture;\t\tuniform float amount;\t\tvarying vec2 texCoord;\t\tfloat rand(vec2 co) {\t\t\treturn fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\t\t}\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\t\t\t\tfloat diff = (rand(texCoord) - 0.5) * amount;\t\t\tcolor.r += diff;\t\t\tcolor.g += diff;\t\t\tcolor.b += diff;\t\t\t\t\t\tgl_FragColor = color;\t\t}\t"),s.call(this,e.noise,{amount:et(0,t,1)}),this}function wt(t){const e=this._.gl,s=this.simpleShader;e.denoise=e.denoise||new Z(e,null,"\t\tuniform sampler2D texture;\t\tuniform float exponent;\t\tuniform float strength;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 center = texture2D(texture, texCoord);\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\tfor (float x = -4.0; x <= 4.0; x += 1.0) {\t\t\t\tfor (float y = -4.0; y <= 4.0; y += 1.0) {\t\t\t\t\tvec4 sample = texture2D(texture, texCoord + vec2(x, y) / texSize);\t\t\t\t\tfloat weight = 1.0 - abs(dot(sample.rgb - center.rgb, vec3(0.25)));\t\t\t\t\tweight = pow(weight, exponent);\t\t\t\t\tcolor += sample * weight;\t\t\t\t\ttotal += weight;\t\t\t\t}\t\t\t}\t\t\tgl_FragColor = color / total;\t\t}\t");for(var i=0;i<2;i++)s.call(this,e.denoise,{exponent:Math.max(0,t),texSize:[this.width,this.height]});return this}function yt(t){for(var e=new SplineInterpolator(t),s=[],i=0;i<256;i++)s.push(clamp(0,Math.floor(256*e.interpolate(i/255)),255));return s}function bt(t,e,s){t=yt(t),1==arguments.length?e=s=t:(e=yt(e),s=yt(s));for(var i=[],r=0;r<256;r++)i.splice(i.length,0,t[r],e[r],s[r],255);return this._.extraTexture.initFromBytes(256,1,i),this._.extraTexture.use(1),gl.curves=gl.curves||new Shader(null,"\t\tuniform sampler2D texture;\t\tuniform sampler2D map;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tcolor.r = texture2D(map, vec2(color.r)).r;\t\t\tcolor.g = texture2D(map, vec2(color.g)).g;\t\t\tcolor.b = texture2D(map, vec2(color.b)).b;\t\t\tgl_FragColor = color;\t\t}\t"),gl.curves.textures({map:1}),simpleShader.call(this,gl.curves,{}),this}function vt(t,e,s,i){const r=this._.gl,o=this.simpleShader;return r.swirl=r.swirl||Q(r,"\t\tuniform float radius;\t\tuniform float angle;\t\tuniform vec2 center;\t","\t\tcoord -= center;\t\tfloat distance = length(coord);\t\tif (distance < radius) {\t\t\tfloat percent = (radius - distance) / radius;\t\t\tfloat theta = percent * percent * angle;\t\t\tfloat s = sin(theta);\t\t\tfloat c = cos(theta);\t\t\tcoord = vec2(\t\t\t\tcoord.x * c - coord.y * s,\t\t\t\tcoord.x * s + coord.y * c\t\t\t);\t\t}\t\tcoord += center;\t"),o.call(this,r.swirl,{radius:s,center:[t,e],angle:i,texSize:[this.width,this.height]}),this}function kt(t){const e=this._.gl;return e.ink=e.ink||new Z(e,null,"\t\tuniform sampler2D texture;\t\tuniform float strength;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec2 dx = vec2(1.0 / texSize.x, 0.0);\t\t\tvec2 dy = vec2(0.0, 1.0 / texSize.y);\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tfloat bigTotal = 0.0;\t\t\tfloat smallTotal = 0.0;\t\t\tvec3 bigAverage = vec3(0.0);\t\t\tvec3 smallAverage = vec3(0.0);\t\t\tfor (float x = -2.0; x <= 2.0; x += 1.0) {\t\t\t\tfor (float y = -2.0; y <= 2.0; y += 1.0) {\t\t\t\t\tvec3 sample = texture2D(texture, texCoord + dx * x + dy * y).rgb;\t\t\t\t\tbigAverage += sample;\t\t\t\t\tbigTotal += 1.0;\t\t\t\t\tif (abs(x) + abs(y) < 2.0) {\t\t\t\t\t\tsmallAverage += sample;\t\t\t\t\t\tsmallTotal += 1.0;\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t\tvec3 edge = max(vec3(0.0), bigAverage / bigTotal - smallAverage / smallTotal);\t\t\tgl_FragColor = vec4(color.rgb - dot(edge, edge) * strength * 100000.0, color.a);\t\t}\t"),this.simpleShader.call(this,e.ink,{strength:t*t*t*t*t,texSize:[this.width,this.height]}),this}function St(t,e){const s=this._.gl,i=this.simpleShader;return s.vignette=s.vignette||new Z(s,null,"\t\tuniform sampler2D texture;\t\tuniform float size;\t\tuniform float amount;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\t\t\t\tfloat dist = distance(texCoord, vec2(0.5, 0.5));\t\t\tcolor.rgb *= smoothstep(0.8, size * 0.799, dist * (amount + size));\t\t\t\t\t\tgl_FragColor = color;\t\t}\t"),i.call(this,s.vignette,{size:et(0,t,1),amount:et(0,e,1)}),this}function Ct(t){const e=this._.gl,s=this.simpleShader;return e.vibrance=e.vibrance||new Z(e,null,"\t\tuniform sampler2D texture;\t\tuniform float amount;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\t\t\tfloat mx = max(color.r, max(color.g, color.b));\t\t\tfloat amt = (mx - average) * (-amount * 3.0);\t\t\tcolor.rgb = mix(color.rgb, vec3(mx), amt);\t\t\tgl_FragColor = color;\t\t}\t"),s.call(this,e.vibrance,{amount:et(-1,t,1)}),this}function Tt(t){const e=this._.gl,s=this.simpleShader;return e.sepia=e.sepia||new Z(e,null,"\t\tuniform sampler2D texture;\t\tuniform float amount;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tfloat r = color.r;\t\t\tfloat g = color.g;\t\t\tfloat b = color.b;\t\t\t\t\t\tcolor.r = min(1.0, (r * (1.0 - (0.607 * amount))) + (g * (0.769 * amount)) + (b * (0.189 * amount)));\t\t\tcolor.g = min(1.0, (r * 0.349 * amount) + (g * (1.0 - (0.314 * amount))) + (b * 0.168 * amount));\t\t\tcolor.b = min(1.0, (r * 0.272 * amount) + (g * 0.534 * amount) + (b * (1.0 - (0.869 * amount))));\t\t\t\t\t\tgl_FragColor = color;\t\t}\t"),s.call(this,e.sepia,{amount:et(0,t,1)}),this}var Pt;function Bt(t){return{_:t,loadContentsOf:function(t){Pt=this._.gl,this._.loadContentsOf(t)},destroy:function(){Pt=this._.gl,this._.destroy()}}}function jt(t){return Bt(J.fromElement(this._.gl,t))}function It(t,e){var s=Pt.UNSIGNED_BYTE;if(Pt.getExtension("OES_texture_float")&&Pt.getExtension("OES_texture_float_linear")){var i=new J(Pt,100,100,Pt.RGBA,Pt.FLOAT);try{i.drawTo((function(){s=Pt.FLOAT}))}catch(t){}i.destroy()}this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=t,this.height=e,this._.texture=new J(Pt,t,e,Pt.RGBA,s),this._.spareTexture=new J(Pt,t,e,Pt.RGBA,s),this._.extraTexture=this._.extraTexture||new J(Pt,0,0,Pt.RGBA,s),this._.flippedShader=this._.flippedShader||new Z(Pt,null,"\t\tuniform sampler2D texture;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tgl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));\t\t}\t"),this._.isInitialized=!0}function Et(t,e,s){this._.isInitialized&&t._.width==this.width&&t._.height==this.height||It.call(this,e||t._.width,s||t._.height);const i=this._.gl;return t._.use(),this._.texture.drawTo((function(){Z.getDefaultShader(i).drawRect()})),this}function Dt(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function At(t,e,s,i){(s||this._.texture).use(),this._.spareTexture.drawTo((function(){t.uniforms(e).drawRect()})),this._.spareTexture.swapWith(i||this._.texture)}function _t(t){return t.parentNode.insertBefore(this,t),t.parentNode.removeChild(t),this}function Mt(){const t=this._.gl;var e=new J(t,this._.texture.width,this._.texture.height,t.RGBA,t.UNSIGNED_BYTE);return this._.texture.use(),e.drawTo((function(){Z.getDefaultShader(t).drawRect()})),Bt(e)}function zt(){var t=this._.texture.width,e=this._.texture.height,s=new Uint8Array(t*e*4);return this._.texture.drawTo((function(){Pt.readPixels(0,0,t,e,Pt.RGBA,Pt.UNSIGNED_BYTE,s)})),s}function Rt(t){return function(...e){return t.call(this,...e)}}function Wt(){const t=new OffscreenCanvas(512,512);try{Pt=t.getContext("webgl")||t.getContext("experimental-webgl",{premultipliedAlpha:!1})}catch(t){Pt=null}if(!Pt)throw"This browser does not support WebGL";return t._={gl:Pt,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},t.texture=jt.bind(t),t.draw=Et.bind(t),t.update=Dt.bind(t),t.replace=_t.bind(t),t.contents=Mt.bind(t),t.getPixelArray=zt.bind(t),t.simpleShader=At.bind(t),t.brightnessContrast=Rt.bind(t)(st),t.hexagonalPixelate=Rt.bind(t)(it),t.hueSaturation=Rt.bind(t)(rt),t.colorHalftone=Rt.bind(t)(ot),t.triangleBlur=Rt.bind(t)(nt),t.unsharpMask=Rt.bind(t)(ht),t.perspective=Rt.bind(t)(lt),t.matrixWarp=Rt.bind(t)(ct),t.bulgePinch=Rt.bind(t)(dt),t.tiltShift=Rt.bind(t)(ut),t.dotScreen=Rt.bind(t)(gt),t.edgeWork=Rt.bind(t)(pt),t.lensBlur=Rt.bind(t)(ft),t.zoomBlur=Rt.bind(t)(mt),t.noise=Rt.bind(t)(xt),t.denoise=Rt.bind(t)(wt),t.curves=Rt.bind(t)(bt),t.swirl=Rt.bind(t)(vt),t.ink=Rt.bind(t)(kt),t.vignette=Rt.bind(t)(St),t.vibrance=Rt.bind(t)(Ct),t.sepia=Rt.bind(t)(Tt),t}class Ft{#Ut=Wt();triangleBlur(t,e=5){const s=this.#Ut,i=s.texture(t);return s.draw(i).triangleBlur(e).update(),s.transferToImageBitmap()}zoomBlur(t,e=.3,s=t.width/2,i=t.height/2){const r=this.#Ut,o=r.texture(t);return r.draw(o).zoomBlur(s,i,e).update(),r.transferToImageBitmap()}lensBlur(t,e,s,i){const r=this.#Ut,o=r.texture(t);return r.draw(o).lensBlur(e,s,i).update(),r.transferToImageBitmap()}ink(t,e=.25){const s=this.#Ut,i=s.texture(t);return s.draw(i).ink(e).update(),s.transferToImageBitmap()}brightnessContrast(t,e=0,s=0){const i=this.#Ut,r=i.texture(t);return i.draw(r).brightnessContrast(e,s).update(),i.transferToImageBitmap()}hueSaturation(t,e=0,s=0){const i=this.#Ut,r=i.texture(t);return i.draw(r).hueSaturation(e,s).update(),i.transferToImageBitmap()}swirl(t,e,s,i=t.width/2,r=t.height/2){const o=this.#Ut,n=o.texture(t);return o.draw(n).swirl(i,r,e,s).update(),o.transferToImageBitmap()}bulgePinch(t,e,s,i=t.width/2,r=t.height/2){const o=this.#Ut,n=o.texture(t);return o.draw(n).bulgePinch(i,r,e,s).update(),o.transferToImageBitmap()}denoise(t,e){const s=this.#Ut,i=s.texture(t);return s.draw(i).denoise(e).update(),s.transferToImageBitmap()}unsharpMask(t,e,s){const i=this.#Ut,r=i.texture(t);return i.draw(r).unsharpMask(e,s).update(),i.transferToImageBitmap()}noise(t,e){const s=this.#Ut,i=s.texture(t);return s.draw(i).noise(e).update(),s.transferToImageBitmap()}sepia(t,e){const s=this.#Ut,i=s.texture(t);return s.draw(i).sepia(e).update(),s.transferToImageBitmap()}vignette(t,e,s){const i=this.#Ut,r=i.texture(t);return i.draw(r).vignette(e,s).update(),i.transferToImageBitmap()}vibrance(t,e){const s=this.#Ut,i=s.texture(t);return s.draw(i).vibrance(e).update(),s.transferToImageBitmap()}}class Ot{#Xt=!1;get name(){return"app"}get version(){return 1}get isSetup(){return this.#Xt}async init(){if(!window.indexedDB)throw console.log("Your browser doesn't support IndexedDB"),new Error("IndexDB is not supported");this.db=await this.#Gt(),this.isSetup&&await this.setup()}needSetup(t){return 0==t}setup(){}ls(t,e=!1,s=0,i=100){return this.#Lt(t,e,s,i)}tail(t,e=0,s=50){return this.#Lt(t,!0,e,s)}lsByIndex(t,e,s,i=!1,r=30,o=0){return this.#Yt(t,e,s,o,r,i)}lsByRating(t,e,s){return this.#Ht(t,"rating",e,s,!0)}lsByRange(t,e,s,i,r=!1,o=50){return this.#Vt(t,e,s,i,r,o)}latest(t,e=0,s=100){return this.#Yt(t,"ts",0,e,s,!0)}count(t){return this.#qt(t)}put(t,e){return Ot.put(this.db,t,e)}update(t,...e){return this.#Kt(t,...e)}updateByIndex(t,...e){return this.#Jt(t,...e)}push(t,...e){return this.#Zt(t,...e)}get(t,e){return this.#Qt(t,e)}rm(t,e){return this.#te(t,e)}rmByIndex(t,e,s){return this.#ee(t,e,s)}pushValue(t,e,s,i){return this.#se(t,e,s,i)}pushValueByIndex(t,e,s,i,r){return this.#ie(t,e,s,i,r)}deleteValue(t,...e){return this.#re(t,...e)}deleteValueByIndex(t,...e){return this.#oe(t,...e)}add(t,e){return this.#ne(t,e)}getById(t){return this.#Qt(kContact,t)}getByEmail(t){return this.#he(kContact,"email",t)}getByIndex(t,e,s){return this.#he(t,e,s)}#Gt(){const t=this.name,e=this.version;return new Promise(((s,i)=>{const r=indexedDB.open(t,e);r.onerror=t=>{console.error(`Database error: ${t.target.errorCode}`),i(t.target.errorCode)},r.onsuccess=t=>{const e=t.target.result;s(e)},r.onupgradeneeded=t=>{const e=t.target.result,s=t.target.transaction,i=t.oldVersion;this.onUpgrade(e,s,i),this.needSetup(i)&&(this.#Xt=!0)}}))}#Yt(t,e,s,i=0,r=50,o=!1){return new Promise(((n,h)=>{const a=this.db.transaction(t,"readonly").objectStore(t),l=s?IDBKeyRange.only(s):IDBKeyRange.lowerBound(0),c=a.index(e).openCursor(l,o?"prev":"next");let d=0==i,u=0;const g=[];c.onsuccess=t=>{const e=t.target.result;if(e)if(d){const t=e.value;g.push(t),u++,u<r?e.continue():n(g)}else d=!0,e.advance(i);else n(g)},c.onerror=t=>{h(t)}}))}addOne(t,e){return new Promise(((s,i)=>{let r=this.db.transaction(t,"readwrite").objectStore(t).add(e);r.onsuccess=s,r.onerror=i}))}#te(t,e){return new Promise(((s,i)=>{const r=this.db.transaction(t,"readwrite").objectStore(t);let o=e?r.delete(e):r.clear();o.onsuccess=function(t){s()},o.onerror=function(t){console.log(t.target.errorCode),i(t.target.errorCode)}}))}#ee(t,e,s){return new Promise(((i,r)=>{const o=this.db.transaction(t,"readwrite").objectStore(t).index(e).openCursor(s);o.onerror=i,o.onsuccess=t=>{const e=t.target.result;e?(e.delete(),e.continue()):i()}}))}#ne(t,e){const s=this.db.transaction(t,"readwrite").objectStore(t);Array.isArray(e)||(e=[e]),console.log("IndexDB: adding new entries =>",t,"\n",e.map((t=>t.id)));const i=[];for(const t of e)i.push(new Promise(((e,i)=>{let r=s.add(t);r.onsuccess=function(t){e()},r.onerror=i})));return Promise.all(i)}#Kt(t,e,s,i={}){return new Promise(((r,o)=>{const n=this.db.transaction(t,"readwrite").objectStore(t),h=n.openCursor(IDBKeyRange.only(e));h.onsuccess=t=>{const h=t.target.result;let a;if(h){const t=Object.assign(h.value,s);Object.deleteUndefined(t),a=h.update(t)}else{const t={id:e,...i,...s};a=n.add(t)}a.onsuccess=function(t){r()},a.onerror=o},h.onerror=o}))}#Jt(t,e,s,i,r={}){return new Promise(((o,n)=>{const h=this.db.transaction(t,"readwrite").objectStore(t),a=h.index(e).openCursor(s);a.onsuccess=t=>{const e=t.target.result;let s;if(e){const t=Object.assign(e.value,i);Object.deleteUndefined(t),s=e.update(t)}else{const t={...r,...i};s=h.add(t)}s.onsuccess=function(t){o()},s.onerror=n},a.onerror=n}))}#se(t,e,s,i){return new Promise(((r,o)=>{const n=this.db.transaction(t,"readwrite").objectStore(t).openCursor(IDBKeyRange.only(e));Nt(s,i,n,r,o)}))}#ie(t,e,s,i,r){return new Promise(((o,n)=>{const h=this.db.transaction(t,"readwrite").objectStore(t).index(e).openCursor(s);Nt(i,r,h,o,n)}))}#re(t,e,s,i){return new Promise(((r,o)=>{const n=this.db.transaction(t,"readwrite").objectStore(t).openCursor(IDBKeyRange.only(e));$t(s,i,n,r,o)}))}#oe(t,e,s,i,r){return new Promise(((o,n)=>{const h=this.db.transaction(t,"readwrite").objectStore(t).index(e).openCursor(s);$t(i,r,h,o,n)}))}#Zt(t,e,s,i){return new Promise(((r,o)=>{const n=this.db.transaction(t,"readwrite").objectStore(t).openCursor(IDBKeyRange.only(e));n.onsuccess=t=>{const e=t.target.result;let n;if(!e)return o("Appending to non-existing record");const h=e.value;h[s]?h[s].push(i):h[s]=[i],h.ts&&(h.ts=Date.seconds()),n=e.update(h),n.onsuccess=function(t){console.log(t),r()},n.onerror=function(t){console.log(t.target.errorCode),o(t.target.errorCode)}},n.onerror=o}))}#Qt(t,e){return new Promise(((s,i)=>{let r=this.db.transaction(t,"readonly").objectStore(t).get(e);r.onsuccess=t=>{t.target.result?s(t.target.result):s(null)},r.onerror=i}))}#he(t,e,s){return new Promise(((i,r)=>{let o=this.db.transaction(t,"readonly").objectStore(t).index(e).get(s);o.onsuccess=t=>{i(o.result)},o.onerror=r}))}#Lt(t,e,s,i){return new Promise(((s,r)=>{const o=this.db.transaction(t,"readonly").objectStore(t),n=[],h=o.openCursor(null,e?"prev":"next");let a=0;h.onsuccess=t=>{let e=t.target.result;if(e){let t=e.value;n.push(t),++a<i?e.continue():s(n)}else s(n)},h.onerror=r}))}#Ht(t,e,s=0,i=50,r=!1){return new Promise(((o,n)=>{const h=this.db.transaction(t,"readonly").objectStore(t),a=IDBKeyRange.lowerBound(0),l=h.index(e).openCursor(a,r?"prev":"next");let c=0==s,d=0;const u=[];l.onsuccess=t=>{const e=t.target.result;if(e)if(c){const t=e.value;u.push(t),d++,d<i?e.continue():o(u)}else c=!0,e.advance(s);else o(u)},l.onerror=n}))}#Vt(t,e,s,i,r=!1,o=50){return new Promise(((n,h)=>{const a=this.db.transaction(t,"readonly").objectStore(t);let l;l=s?i?IDBKeyRange.bound(s,i,!1,!0):IDBKeyRange.lowerBound(s):IDBKeyRange.upperBound(i,!0);const c=a.index(e).openCursor(l,r?"prev":"next"),d=[];let u=0;c.onsuccess=t=>{let e=t.target.result;if(e){let t=e.value;d.push(t),++u<o?e.continue():n(d)}else n(d)},c.onerror=h}))}#qt(t){return new Promise(((e,s)=>{const i=this.db.transaction(t,"readonly").objectStore(t).count();i.onsuccess=t=>{const s=t.target.result;e(s)},i.onerror=s}))}#ae(t){return new Promise(((e,s)=>{const i=this.db.transaction(t,"readonly").objectStore(t).clear();i.onsuccess=()=>e(),i.onerror=s}))}delete(t,e,s,i){return new Promise(((r,o)=>{const n=this.db.transaction(t,"readwrite").objectStore(t);let h,a;e?(h=s==i?IDBKeyRange.only(s):s?i?IDBKeyRange.bound(s,i,!1,!0):IDBKeyRange.lowerBound(s):IDBKeyRange.upperBound(i,!0),a=n.index(e).openCursor(h)):a=n.openCursor(),a.onsuccess=t=>{let e=t.target.result;e?(e.delete(),e.continue()):r()},a.onerror=o}))}static put(t,e,s){const i=t.transaction(e,"readwrite").objectStore(e);Array.isArray(s)||(s=[s]);const r=[];for(const t of s)r.push(new Promise(((e,s)=>{let r=i.put(t);r.onsuccess=function(t){e()},r.onerror=s})));return Promise.all(r)}static addTable=Ut;static addIndex=Gt;static deleteTable=Xt;static deleteIndex=Lt}function Nt(t,e,s,i,r){s.onsuccess=s=>{const o=s.target.result;let n;if(o){const s=o.value;s[t]||(s[t]=[]),Array.isArray(e)?s[t].push(...e):s[t].push(e),n=o.update(s),n.onsuccess=i,n.onerror=r}else i()},s.onerror=r}function $t(t,e,s,i,r){s.onsuccess=s=>{const o=s.target.result;let n;if(o){const s=o.value,h=s[t];Array.isArray(h)&&e?s[t]=h.filter((t=>t!=e)):delete s[t],n=o.update(s),n.onsuccess=function(t){i()},n.onerror=r}else i()},s.onerror=r}function Ut(t,e,s=!1,i="id"){const r={keyPath:i,autoIncrement:s};t.createObjectStore(e,r)}function Xt(t,e){t.deleteObjectStore(e)}function Gt(t,e,s,i=!1,r=e){s.objectStore(t).createIndex(r,e,{unique:i})}function Lt(t,e,s){s.objectStore(t).deleteIndex(e)}function Yt(t,e={}){Object.assign(e,{set(t,e,s){const i=this[t];if(i)switch(i.tagName){case"INPUT":if("checkbox"==i.type)i.checked=!!e;else{s&&(i.dataset.id=s);const t=i.previousElementSibling,r=!!e;t&&"INPUT"==t.tagName&&"checkbox"==t.type?(i.disabled=!r,r&&(i.value=e),r!=t.checked&&(t.checked=r)):i.value="number"==typeof e?isNaN(e)?0:e:e||""}break;case"SELECT":{const t=i.previousElementSibling,s=!!e;t&&"INPUT"==t.tagName&&"checkbox"==t.type?(i.disabled=!s,i.value=s?e:i.children[0].value,s!=t.checked&&(t.checked=s,t.dispatchEvent(new Event("change",{bubbles:!0})))):i.value=e}break;default:i.value=e}return i},assign(t){for(const[e,s]of Object.entries(t))this.set(e,s)}});const s=t.querySelectorAll("input,select,textarea");for(const t of s){const s=t.id||t.getAttribute("role");if(s){const[i,r]=s.split("-");"object"==i&&(e[r]=t)}}return e}function Ht(t,e){const s=t.querySelector(".list"),i=UX.List.createMixin(s);return i.add=function(s,r){const o=s.id;let n;return e?(n=i.addItemTemplate(e,s,!0),r&&("string"==typeof r&&(r=i.getElement(r)),dom.insertAfter(n,r))):(n=document.createElement("span"),n.innerText=o,n.dataset.id=o,n.classList.add("item"),t.appendChild(n)),n},i.select=function(t,e){this.selectItem(t,e)},i.enable=function(e,s){const i=t.querySelector(`button[name="${e}"]`);i&&(i.disabled=!s)},i.swap=function(t,e){const s=this.getElement(t),i=this.getElement(e);dom.swap(s,i)},i}const Vt={add(){},select(){},delete(){},clear(){},clearSelection(){},swap(){},enable(t,e){}},qt={set(){},assign(){},mode(){}};class Kt extends K{#le;#ce=new s;#p;#l="#eeeeee";#h="#111111";#a=1;#de="select";#ue={};#ge=!1;#pe;#r=0;#o=0;#fe;#k;#B;#me=[];#xe=[];#we=new Map;#wt=new Map;#K;#ye=new Map;#be=[];#ve=0;#ke={};#Se={properties:qt,objects:Vt,projects:Vt,canvas:qt,status:qt,tools:qt,actions:qt,notify:Vt,images:Vt,reset(){this.properties.mode(),this.projects.clearSelection(),this.objects.clear(),this.tools.mode("select"),this.actions.mode("select"),this.actions.set("attach",!1)}};get db(){return this.#le}get x(){return 0}get y(){return 0}set width(t){const e=t>800?t:800,s=this.canvas;s.width=e,s.height=3*e/4,this.#ce.width=t,this.#ce.x=(e-t)/2,this.#ce.height<s.height?this.#ce.y=(s.height-this.#ce.height)/2:(this.#ce.y=0,this.#ce.height=s.height);const i=s.getBoundingClientRect();this.#Ce(i)}set height(t){t>this.canvas.height&&(t=this.canvas.height),this.#ce.y=(this.canvas.height-t)/2,this.#ce.height=t,this.#ce.properties=this.#Se.canvas,this.draw()}set fill(t){this.#l=t}set stroke(t){this.#h=t}set strokeWidth(t){this.#a=t}set mode(t){switch(this.#de){case"draw":this.#k&&(this.#k=null);break;case"edit":this.#me=[]}if(this.#de=t,"edit"===this.#de&&this.#p){const t=this.findGroup(this.#p);this.#me=this.#p.getNodes(t)}this.draw(),this.#Se.tools.mode(this.#de),this.#Se.status.set("mode",this.#de.toUpperCase())}constructor(t){super(t),window.app=this;try{window.glfx||(window.glfx=new Ft)}catch(t){console.error("Failed to init WbGL")}this.#Te(),this.#Pe(),this.#ce.width=1200,this.#ce.height=630,this.width=1200,this.reset()}async init(t){t||(t=new Zt,await t.init()),this.#le=t,await tf.setBackend("webgl")}loadProjects(){this.#pe||this.#Be()}center(){return[this.width/2,this.height/2]}reset(){this.#p=null,this.#fe=null,this.#be=[],this.#ve=0,this.#k=null,this.#de="select",this.#me=[],this.#ce.fill="#fafafa",this.#K=null,this.#ye.clear(),this.canvas.focus();const t=super.reset().filter((t=>"chart"==t.type));let e;for(let s of t)e=s.getData(),0==e.refs&&this.#wt.delete(s.file);this.#ce.properties=this.#Se.canvas,this.#Se.reset()}drawBefore(t){this.#ce.draw(t)}drawAfter(t){if(this.#k&&this.#k.draw(t,this.#de),"edit"==this.#de&&this.#p?.visible)for(const e of this.#me)e.draw(t)}draw(t=!0){super.draw(t,this.#de)}add(t,e="",s=null){const i=super.create(t,s);switch(i.type){case"bubble":i.width=300,i.height=150;break;case"rect":case"label":i.width=350,i.height=200;break;case"circle":i.width=200,i.height=200;break;case"text":i.setText("Text");break;case"emoji":case"icon":i.setText(e);break;case"chart":i.width=400,i.height=300;break;case"image":if(e){const t=this.#we.get(e);i.setImage(t)}}return i?(this.#de="select",i.fill=this.#l,i.stroke=this.#h,i.strokeWidth=this.#a,i.x=50+Math.round(400*Math.random()),i.y=10+Math.round(300*Math.random()),this.#Se.objects.add(i),this.select(i),this.emit("newobject",i.id)):console.error("Unknown object type:",t),i}remove(t=this.#p?.id){const e=this.find(t);super.remove(t),"chart"==e.type&&0==e.getData().refs&&this.#wt.delete(e.file),t==this.#p?.id&&(this.#p=null,this.emit("select",null),this.#Se.properties.mode()),this.#Se.objects.delete(t)}move(t,e){const s=super.reorderObject(t,e);this.draw(),this.#Se.objects.swap(t,s)}applyMask(t){const e=this.findGroup(t).objects,s=e.findIndex((e=>e.id==t)),i=e[s-1];i&&"image"==i.type&&(i.setMask(e[s]),this.draw())}export(t="meme",e="jpeg"){const s=this.#ce,i=new OffscreenCanvas(s.width,s.height),r=i.getContext("2d");return r.drawImage(this.canvas,s.x,s.y,s.width,s.height,0,0,s.width,s.height),function(t,e,s=t.canvas.height){const i=t.canvas.width,r=i/50,o=.01*i,n=s-o;t.save(),t.fillStyle="#888",t.textBaseline="middle",t.textAlign="left",t.font=`bold ${r}px monospace`,t.fillText(e,o,n),t.restore()}(r,"www.sipme.io"),this.#je(i,t,e)}exportObject(){if(!this.#p)return;const t=this.#p,e=new OffscreenCanvas(t.width,t.height),s=e.getContext("2d");return s.translate(-t.x,-t.y),t.draw(s),this.#je(e,t.name,"png")}async attach(t){if(!showSaveFilePicker)return void this.#Se.notify.add("Browser not supported!","error");const e={id:"project",suggestedName:"MyProject.memed",startIn:"documents",types:[{description:"Project file",accept:{"application/memed":[".memed"]}}]};try{const s=await showSaveFilePicker(e);this.#K=s,await this.#Ie(t),this.#Se.notify.add("Attached !","success")}catch(t){console.error("Failed to export project",t),this.#Se.notify.add("Failed export !","error")}}async import(t){if(!t){const e={id:"import",types:[{description:"Images",accept:{"image/*":[".png",".webp",".jpeg",".jpg"]}},{description:"CSV",accept:{"text/csv":[".csv"]}}],excludeAcceptAllOption:!0,multiple:!0},s=await showOpenFilePicker(e);t=await Promise.all(s.map((t=>t.getFile())))}if(1==t.length){const e=t[0].type;if("text/csv"==e)return this.#Ee(t[0]);if(""==e)return this.#De(t[0])}return this.#Ae(t)}async save(t){try{const e=super.save(),s=this.#ce.save();await this.#le.put("meme",{id:t,canvas:s,objects:e,ts:Date.now(),file:this.#K,blobs:this.#ye}),this.#Se.projects&&(this.#Se.projects.getElementIds().includes(t)||this.#Se.projects.add({id:t,objects:this.objects},!0),this.#Se.projects.selectItem(t)),this.#Ie(t),this.emit("save",t),this.#Se.notify.add("Saved !","success")}catch(t){console.error("Failed to save project"),this.#Se.notify.add("Failed !","error")}}async open(t){if(t!=this.#fe){this.reset();try{const e=await this.#le.get("meme",t);e.canvas||([e.canvas]=e.objects.splice(0,1));const s=super.open(e.objects),i=s.filter((t=>"image"==t.type)),r=Object.fromArray(s.filter((t=>"path"==t.type)));let o,n,h,a;this.#ce.load(e.canvas),this.#ye=e.blobs,this.#K=e.file;for(const t of i)n=t.file,o=this.#we.get(n),o&&0!=o._refs?t.setImage(o):(a=this.#ye.get(n),o=await t.loadImage(a),this.#we.set(n,o)),h=t.maskPath,h&&(h=r[h],h&&t.setMask(h,!1));this.#fe=t,this.draw(),this.emit("open",t),this.#Se.projects.select(t);for(const t of this.objects)this.#Se.objects.add(t);this.#ce.properties=this.#Se.canvas,this.#Se.actions.assign({width:this.#ce.width,height:this.#ce.height,attach:!!this.#K})}catch(t){console.error("Failed to load objects",t)}}}async delete(t){t==this.#fe&&this.reset();try{await this.#le.rm("meme",t),this.emit("delete",t),this.#Se.projects.delete(t)}catch(t){console.error("Failed to delete project")}}update(t,e,s=this.#p){if("string"==typeof s&&(s="canvas"==s?this.#ce:this.find(s)),!s)return;const{setter:i,getter:r}=Object.getProperty(s,t);if(i){r&&(this.#ke[t]||(this.#ke[t]=setTimeout((()=>{this.#be.splice(this.#ve++,this.#be.length);const e=r.call(s),i={};i[t]=e,console.debug("Adding to history",this.#ve,t,"=>",e);const o={id:s.id,values:i};this.#be.push(o),this.#ke[t]=null}),2e3)));const o=s.save();i.call(s,e),this.draw();const n=s.save(),h={};delete n[t];for(const[t,e]of Object.entries(n))o[t]!=e&&(h[t]=e);this.#Se.properties.assign(h)}}select(t,e){this.#_e(t,e)&&this.draw()}group(){const t=[];for(const e of this.all)e.isSelected()&&(this.findGroup(e,!0),t.push(e),e.selected=!1);const e=super.add("group");e.addObjects(t);for(const e of t)this.#Se.objects.delete(e.id);this.#Se.objects.add(e),this.select(e),this.emit("newobject",e.id)}removeNode(){const t=this.#xe.shift();null!=t&&this.#p.remove(t)&&(this.#me=this.#me.filter((e=>e!=t)),this.draw())}insertNode(){let t=this.#xe[0];null!=t&&(t=this.#p.split(t),this.#me.push(t),this.draw())}copy(t){const e=super.copy(t);e.x+=10,e.y+=10,this.draw(),this.#Se.objects.add(e,t)}undo(){this.#ve>0&&this.#Me(--this.#ve,!0)}redo(){this.#ve<this.#be.length-1&&this.#Me(++this.#ve)}alignImages(){const t=this.#ce.height,e=this.#ce.width,s=this.objects.filter((t=>"image"==t.type)),i=s.map((t=>t.width)).sum();let r,o=this.#ce.x,n=this.#ce.y,h=s.map((t=>t.imgHeight)).max(),a=e/i;h*=a,n+=(t-h)/2;for(const t of s)a=t.imgHeight/t.imgWidth,r=t.width/i,t.width=r*e,t.height=a*t.width,t.imgWidth=t.width,t.imgHeight=t.height,t.height=h,t.imgY=(t.height-t.imgHeight)/2,t.x=o,t.y=n,o+=t.width,t==this.#p&&(t.properties=this.#Se.properties);this.draw()}centerImage(t=this.#p){if(!t||"image"!=t.type)return;const e=t.centerInBox();this.#Se.properties.assign(e),this.draw()}fitImageSize(t=this.#p){if(!t||"image"!=t.type)return;const e=t.fitSize();this.#Se.properties.assign(e),this.draw()}centerText(t=this.#p){if(!t)return;const e=t.centerText();this.#Se.properties.assign(e),this.draw()}centerView(){this.updateView(!0),this.draw()}async detectBody(t){if(!this.#p||"image"!=this.#p.type)return;const e=this.#p,s=await l.detectBody(e,t);if(s){const t=this.findGroup(e);this.#ze(t,s),this.draw(),this.#Se.properties.set("mask",s.name,s.id)}else this.#Se.notify.add("Failed to detect human !","error")}wrap(){this.wrapProperties("properties"),this.wrapObjects("objects","item-object"),this.wrapProjects("projects","item-project"),this.wrapImages("images","item-image"),this.wrapCanvas("background"),this.wrapStatus("status"),this.wrapActions("actions"),this.wrapTools("tools"),this.wrapNotifications("notifications","item-notification");const t=this.canvas.parentElement;let e=0;t.ondragover=s=>{s.preventDefault(),0==e&&t.classList.add("dnd")},t.ondragleave=s=>{0==--e&&t.classList.remove("dnd")},t.ondrop=s=>{s.preventDefault(),e=0,t.classList.remove("dnd");const i=[];if(s.dataTransfer.items){for(const t of s.dataTransfer.items)if("file"===t.kind){const e=t.getAsFile();i.push(e)}}else s.dataTransfer.files.forEach(((t,e)=>{console.log(` file[${e}].name = ${t.name}`),i.push(t)}));console.log("File(s) dropped",i),this.import(i)},document.onmousedown=t=>{const e=t.target;if(e.classList.contains("v-sash")){const s=e.previousElementSibling,i=e.classList.contains("reverse"),r=t.clientX,o=s.offsetWidth;document.body.style.cursor="e-resize";const n=t=>{const e=r-t.clientX,n=i?o+e:o-e;s.style.width=`${n}px`},h=t=>{document.documentElement.removeEventListener("mousemove",n,!1),document.documentElement.removeEventListener("mouseup",h,!1),document.body.style.cursor="default";const e=s.id;if(e){const t=parseInt(s.style.width);this.updateWidth(e,t)}};document.documentElement.addEventListener("mousemove",n,!1),document.documentElement.addEventListener("mouseup",h,!1)}}}wrapProperties(t){return this.#Se.properties=function(t,e){"string"==typeof t&&(t=document.getElementById(t));const s=Yt(t,{mode(e){e?t.setAttribute("mode",e):t.removeAttribute("mode")}});return s.set_=s.set,s.set=function(t,e,s){const i=this.set_(t,e,s);switch(t){case"angle":case"radius":case"strokeWidth":case"alpha":i.dispatchEvent(new Event("change",{bubbles:!0}))}},t.oninput=t=>{let s,i,r,o=t.target;"checkbox"==o.type&&(r=o.checked,o.getAttribute("for")&&(o=o.nextElementSibling,r=r?o.value:""));const n=o.id||o.getAttribute("role");n&&([s,i]=n.split("-"),null==r&&(r=o.dataset.id||o.value),e&&e.update(i,r))},t.onclick=async t=>{const s=t.target;if("detect"===s.name){const t=s.previousElementSibling,i=parseFloat(t.value);s.disabled=!0,await delayResolve(e.detectBody(i),2e3),s.disabled=!1}},s}(t,this)}wrapObjects(t,e){return this.#Se.objects=function(t,e,s){return"string"==typeof t&&(t=document.getElementById(t)),t.onclick=t=>{const s=t.target;if(UX.List.isItem(s)){const i=s.dataset.id,r=t.ctrlKey;e.select(i,r)}},t.oninput=t=>{const s=t.target,i=s.closest("[data-id]");if(i){const t=i.dataset.id,r=s.innerText;e.update("name",r,t)}},Ht(t,s)}(t,this,e)}wrapProjects(t,e){return this.#Se.projects=function(t,e,s){return"string"==typeof t&&(t=document.getElementById(t)),Ht(t,s)}(t,0,e)}wrapImages(t,e){return this.#Se.images=function(t,e,s){return"string"==typeof t&&(t=document.getElementById(t)),t.onclick=t=>{const s=t.target;if(UX.List.isItem(s)){const t=s.dataset.id;e.add("image",t)}},Ht(t,s)}(t,this,e)}wrapCanvas(t){return this.#Se.canvas=function(t,e){"string"==typeof t&&(t=document.getElementById(t));const s=Yt(t);return t.oninput=t=>{let s,i,r,o=t.target;const n=o.id||o.getAttribute("role");n&&([s,i]=n.split("-"),null==r&&(r=o.value),e&&e.update(i,r,"canvas"))},s}(t,this),this.#ce.properties=this.#Se.canvas,this.#Se.canvas}wrapTools(t){return this.#Se.tools=function(t,e){return"string"==typeof t&&(t=document.getElementById(t)),t.onclick=t=>{const s=t.target;if("BUTTON"==s.tagName){const t=s.name;if(s.hasAttribute("selectable")){const t=s.parentElement.querySelectorAll("[selectable]");for(const e of t)e.disabled=!1;s.disabled=!0}switch(t){case"select":case"draw":case"edit":e.mode=t;break;default:e.add(t)}}},{mode(e){const s=t.querySelectorAll("[selectable]");for(const t of s)t.disabled=t.name==e}}}(t,this)}wrapStatus(t){return this.#Se.status=function(t){const e={};"string"==typeof t&&(t=document.getElementById(t));const s=t.querySelectorAll("[name]");for(const t of s)e[t.name]=t;return Object.assign(e,{set(t,e){this[t]&&(this[t].value=e)},assign(t){for(const[e,s]of Object.entries(t))this.set(e,s)}}),e}(t)}wrapActions(t){return this.#Se.actions=function(t,e){"string"==typeof t&&(t=document.getElementById(t));const s=t.querySelector('button[name="save"]').previousElementSibling,i=t.querySelector('input[name="zoom"]'),r=i.nextElementSibling,o=r.querySelectorAll(".dropdown-option");let n;i.addEventListener("focus",(()=>{r.style.display="block"})),document.addEventListener("click",(t=>{r.contains(t.target)||t.target===i||(r.style.display="none")})),o.forEach((t=>{t.addEventListener("click",(()=>{i.value=t.textContent,r.style.display="none",i.dispatchEvent(new Event("change",{bubbles:!0}))}))})),i.addEventListener("input",(()=>{o.forEach((t=>{t.style.display="block"}))}));const h={current:"select",mode(e){t.setAttribute("mode",e)},assign(t){for(const[e,s]of Object.entries(t))this.set(e,s)},set(e,s){if("zoom"===e)i.value=parseInt(100*s)+"%";else{const i=t.querySelector(`[name="${e}"]`);i&&(i.value=s)}}};return t.onchange=t=>{const s=t.target,i=s.value;switch(s.name){case"height":e.height=parseInt(i);break;case"width":e.width=parseInt(i);break;case"fill":e.fill=i;break;case"stroke":e.stroke=i;break;case"strokeWidth":e.strokeWidth=parseInt(i);break;case"zoom":e.zoom=parseInt(i)/100}},t.oninput=t=>{const s=t.target;s.value,"zoom"===s.name&&(n||(n=setTimeout((()=>{n=null;const t=parseInt(i.value);console.log("Zoom change",t),e.zoom=t/100}),1200)))},e.on("open",(t=>s.value=t.detail)),h}(t,this)}wrapNotifications(t,e){return this.#Se.notify=function(t,e){"string"==typeof t&&(t=document.getElementById(t));const s=UX.List.createMixin(t);return s.add=function(t,s){const i=this.addItemTemplate(e,t);i.classList.add({success:"w3-green",error:"w3-red"}[s]),setTimeout((()=>dom.removeElement(i)),3e3)},s}(t,e)}#Me(t,e=!1){const{id:s,values:i}=this.#be[t],r={},o=this.find(s);if(o){for(const[t,e]of Object.entries(i)){const{setter:s,getter:i}=Object.getProperty(o,t);i&&(r[t]=i.call(o)),s&&s.call(o,e),this.#Se.properties.set(t,e)}this.draw(),e&&t==this.#be.length-1&&this.#be.push({id:s,values:r})}}#_e(t,e){let s,i;if("string"==typeof t){if(this.#p&&t==this.#p.id)return!1;s=this.find(t)}else s=t;s&&(s.selected=!0,s.properties=this.#Se.properties,i=s.save());const r=this.#p!=s;return r&&(this.#p?e?this.#Se.objects.enable("group",!0):(this.#p.selected=!1,this.#Se.objects.enable("group",!1)):this.#Se.objects.enable("group",!1),this.#p=s,this.#Se.properties.mode(s?.type),this.#Se.objects.select(s?.id,e),this.emit("select",i)),r}#Ce(t){this.setSize(t.width,t.height)}#ze(t,e=this.#k){e.closed||e.end(),super.add(e,t),this.#k=null,this.#_e(e),this.#Se.objects.add(e)}#Re(t,e){if(this.#B){if(this.#p){this.#be.splice(this.#ve++,this.#be.length);const t={id:this.#p.id,values:{x:this.#B.x,y:this.#B.y,width:this.#B.width,height:this.#B.height}};this.#be.push(t)}return void(this.#B=null)}const s=this.#ue.Control;let i;this.#p&&!s&&(this.#p.selected=!1);for(const r of[...this.objects].reverse())if(r.visible&&(i=r.handleSelect(t,e,s)))break;this.select(i,s)}#We(t,e){this.#B=null;for(const s of this.objects)if(this.#B=s.handleClick(t,e)){this.#B.x=s.x,this.#B.y=s.y,this.#B.width=s.width,this.#B.height=s.height;break}}#Fe(t,e){if(!this.#B)return;for(let s,i,r=0;r<this.objects.length;++r)if(i=this.objects[r],i!=this.#p&&(s=i.snap(t,e))){t=s[0],e=s[1];break}this.#B.move(t,e),this.draw();const s=this.#p;if(s){const t={x:s.x,y:s.y,width:s.width,height:s.height,angle:s.angle};this.#Se.properties.assign(t),this.emit("update",t)}}#Oe(t,e){}#Ne(t,e){this.#k||(this.#k=new l),this.#k.mouseDown(t,e,this.#ue),this.#k.closed&&this.#ze(this),this.draw()}#$e(t,e){this.#k&&(this.#k.mouseUp(t,e,this.#ue),this.draw())}#Ue(t,e){this.#k&&(this.#k.mouseMove(t,e,this.#ue),this.draw())}#Xe(t,e){this.#B=null;for(const s of this.#me)if(this.#B=s.handleSelect(t,e))return this.draw(),void this.#Se.actions.mode("edit");this.#Se.actions.mode("")}#Ge(t,e){this.#B&&(this.#B.move(t,e),this.draw())}#Le(t,e){this.#B&&this.#B.control&&(this.#B.selected?this.#xe.unshift(this.#B):this.#xe=this.#xe.filter((t=>t!=this.#B))),this.#B=null}#Te(){const t=this.canvas;t.onclick=t=>{const[e,s]=this.getCordinates(t.offsetX,t.offsetY);switch(this.#de){case"select":this.#Re(e,s);break;case"draw":this.#Oe(e,s);break;case"edit":this.#Le(e,s)}},t.onmousemove=t=>{let[e,s]=this.getCordinates(t.offsetX,t.offsetY);if(this.#Se.status.assign({x:Math.round(e),y:Math.round(s)}),this.#ue.Shift){const t=Math.abs(e-this.#r),i=Math.abs(s-this.#o);Math.abs(t-i)<Math.max(3,3*t/10)?s=s<this.#o?this.#o-t:this.#o+t:t<i?e=this.#r:s=this.#o}switch(this.#de){case"select":this.#Fe(e,s);break;case"draw":this.#Ue(e,s);break;case"edit":this.#Ge(e,s)}},t.onmousedown=t=>{const[e,s]=this.getCordinates(t.offsetX,t.offsetY);switch(this.#r=e,this.#o=s,this.#de){case"select":this.#We(e,s);break;case"draw":this.#Ne(e,s);break;case"edit":this.#Xe(e,s)}},t.onmouseup=t=>{const[e,s]=this.getCordinates(t.offsetX,t.offsetY);"draw"===this.#de&&this.#$e(e,s)},t.onmouseenter=t=>{this.#ge=!0},t.onmouseleave=t=>{this.#ge=!1},t.onkeydown=t=>{const e=t.key;if("draw"==this.#de)switch(e){case"Enter":this.#k&&this.#ze(this);case"Escape":return this.#k=null,void this.draw();case"Backspace":return void(this.#k&&(this.#k.undo(),this.draw()))}else if("edit"==this.#de)switch(e){case"Delete":return this.removeNode(),void this.draw();case"n":return this.insertNode(),void this.draw()}if(this.#p&&e.startsWith("Arrow")){switch(e.substr(5)){case"Up":this.#p.y-=5;break;case"Down":this.#p.y+=5;break;case"Left":this.#p.x-=5;break;case"Right":this.#p.x+=5}this.draw()}else switch(e){case"s":this.mode="select";break;case"e":this.mode="edit";break;case"d":this.mode="draw";break;case"r":this.add("rect");break;case"b":this.add("bubble");break;case"t":this.add("text");break;case"g":this.group()}},window.onwheel=t=>{if(this.#ge){if(this.#ue.Control){const e=t.deltaY<0?.1:-.1;this.updateZoom(e),this.#Se.actions.set("zoom",this.zoom)}else if(this.#ue.Shift){const e=t.deltaY<0?-30:30;this.updatePosition(e,0)}else{const e=t.deltaY<0?-30:30;this.updatePosition(0,e)}this.draw()}},window.onkeydown=t=>{const e=t.key;["Control","Shift"].includes(e)&&(this.#ue[e]=!0)},window.onkeyup=t=>{const e=t.key;["Control","Shift"].includes(e)&&delete this.#ue[e]}}#Pe(){new ResizeObserver((t=>this.#Ce(t[0].contentRect))).observe(this.canvas.parentElement)}async#Be(){this.#pe=[];const t=await this.#le.latest("meme");console.debug("Projects loaded",t),this.#Se.projects.clear();for(const e of t)this.#pe.push({name:e.id,objects:e.objects.length}),this.#Se.projects.add(e);this.emit("projects",t)}updateView(t=!1){super.updateView(t),this.#Se.status.set("zoom",this.zoom.toFixed(2))}async#je(t,s,i,r=this.#ce.box()){if(showSaveFilePicker){const e={types:[{description:"Image file",accept:{"image/*":[".png",".jpeg",".jpg",".svg"]},suggestedName:"meme.jpeg",startIn:"pictures"}]};try{const s=await showSaveFilePicker(e);let i,[,o]=s.name.split(".");"jpg"==o&&(o="jpeg");const n="image/"+o,h=await s.createWritable();i="svg"==o?super.toSVG(r):await t.convertToBlob({type:n}),await h.write(i),await h.close(),this.#Se.notify.add("Exported !","success")}catch(t){console.error("Failed to export image",t),this.#Se.notify.add("Failed export !","error")}}else{const t=e.toDataURL("image/"+i),r=document.createElement("a");r.download=s+"."+i,r.href=t,r.click()}}async#Ee(t){console.debug("Parsing csv file");const e=t.name,s=function(t){const e=[];let s=[],i="",r=!1;for(let o=0;o<t.length;o++){const n=t[o],h=t[o+1];'"'===n?r&&'"'===h?(i+='"',o++):r=!r:","!==n||r?"\n"!==n||r?i+=n:(s.push(i.trim()),e.push(s),s=[],i=""):(s.push(i.trim()),i="")}return(s.length>0||""!==i)&&(s.push(i.trim()),e.push(s)),e}(await t.text());let i=0;if(s.length>1){const r=G.processData(s);if(r){this.#p&&"chart"==this.#p.type||this.add("chart");const s=this.#p;r.refs=0,s.setData(r),this.#wt.set(e,r),this.draw(),await this.#le.put("file",{id:e,file:t,type:"csv"}),this.#Se.properties.set("kind",this.#p.kind)}else i=!0}i&&(console.error("Invalid CSV data"),this.#Se.notify.add("Failed to import CSV !","error"))}async#Ae(t){let e,s,i,r;for(const o of t)i=o.name,e=Kt.create("image"),e.file=o,s=this.#we.get(i),s&&0!=s._refs?e.setImage(s):(s=await e.loadImage(o),this.#we.set(i,s),r=await O.thumb(s),this.#Se.images.add({id:i,link:r,type:o.type,size:o.size,width:s.width,height:s.height})),this.add(e),this.#ye.set(i,o);t.length>1?this.alignImages():this.draw()}async#Ie(t){if(!this.#K)return;const e=await this.#K.createWritable(),s=super.save(),i=this.#ce.save();await Jt(e,0,{id:t,canvas:i,objects:s});for(const[t,s]of this.#ye.entries())await Jt(e,0,t),await Jt(e,0,s.type),await Jt(e,0,s);await e.close()}async#De(t){const e=await t.arrayBuffer(),s=new DataView(e);let i,r,o=0;function n(){o+=2,r=s.getUint32(o),o+=4,i=new Uint8Array(e,o,r),o+=r}n();const h=unzip(i),a=JSON.parse(h),l=new TextDecoder;for(let t,e,r,h;o<s.byteLength;)n(),t=l.decode(i),n(),e=l.decode(i),n(),r=new Blob([i],{type:e}),r.name=t,h=await O.load(r),h._file=r,h._ref=0,this.#we.set(t,h),this.#ye.set(t,r);const c=super.open(a.objects).filter((t=>"image"==t.type));let d;this.#ce.load(a.canvas);for(const t of c)d=this.#we.get(t.file),t.setImage(d);this.draw()}}async function Jt(t,e,s){let i,r;return"string"==typeof s?(r=1,i=s.toArrayBuffer()):s instanceof Blob?(r=function(t){switch(t){case"image/jpg":return 4;case"image/png":return 5;case"image/webp":return 6}}(s.type),i=new Uint8Array(await s.arrayBuffer())):(r=2,i=zip(JSON.stringify(s))),function(t,e,s,i){const r=new Uint8Array(6+i.byteLength),o=r.buffer;return new DataView(o).setUint32(2,i.byteLength),r.set(i,6),t.write(r)}(t,0,0,i)}class Zt extends Ot{get name(){return"meme"}get version(){return 2}onUpgrade(t,e,s){switch(s){case 0:Zt.addTable(t,"meme"),Zt.addIndex("meme","ts",e);case 1:Zt.addTable(t,"file"),Zt.addIndex("file","type",e)}}}})(),r.default})()));