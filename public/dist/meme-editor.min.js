!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.MemeEditor=e():t.MemeEditor=e()}(self,(()=>(()=>{var t={546:()=>{Object.clone=function(t){var e=t instanceof Array?[]:{};for(let s in t)t[s]&&"object"==typeof t[s]?e[s]=ArrayBuffer.isView(t[s])?new t[s].constructor(t[s]):Object.clone(t[s]):e[s]=t[s];return e},Object.getGetters=function(t){let e={},s=Object.getPrototypeOf(t);for(;s&&s!==Object.prototype;){const t=Object.getOwnPropertyDescriptors(s);for(const[s,i]of Object.entries(t))"function"!=typeof i.get||s in e||(e[s]=i.get);s=Object.getPrototypeOf(s)}return e},Object.getSetters=function(t){let e={},s=Object.getPrototypeOf(t);for(;s&&s!==Object.prototype;){const t=Object.getOwnPropertyDescriptors(s);for(const[s,i]of Object.entries(t))"function"!=typeof i.set||s in e||(e[s]=i.set);s=Object.getPrototypeOf(s)}return e},Object.getProperties=function(t){let e={},s={},i=Object.getPrototypeOf(t);for(;i&&i!==Object.prototype;){const t=Object.getOwnPropertyDescriptors(i);for(const[i,r]of Object.entries(t))"function"!=typeof r.get||i in s||(s[i]=r.get),"function"!=typeof r.set||i in e||(e[i]=r.set);i=Object.getPrototypeOf(i)}return{setters:e,getters:s}},Object.getGetter=function(t,e){return Object.getGetters(t)[e]},Object.getSetter=function(t,e){return Object.getSetters(t)[e]},Object.getProperty=function(t,e){const{setters:s,getters:i}=Object.getProperties(t);return{setter:s[e],getter:i[e]}},Object.fromInstance=function(t,e={},...s){const i=Object.getGetters(t);for(const[r,o]of Object.entries(i))s.includes(r)||(e[r]=o.call(t));return e},Object.instanceFrom=function(t,e){const s=Object.getSetters(t);for(const[i,r]of Object.entries(s))i in e&&r.call(t,e[i]);return t},Array.repeat=function(t,e=0){return new Array(t).fill(0)},Array.prototype.last=function(){return this[this.length-1]},String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)}}},s={};function i(e){var r=s[e];if(void 0!==r)return r.exports;var o=s[e]={exports:{}};return t[e](o,o.exports,i),o.exports}i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var r={};return(()=>{"use strict";i.d(r,{default:()=>$t}),i(546);class t{static ID=1;#t;#e;#s=0;#i=0;#r=50;#o=50;#h=0;#n="#000000";#a=1;#l="#eeeeee";#c="ff";#d;#u="#444444";#g=2;#p=!1;#m=!0;constructor(e){this.#t=e||Date.now().toString(16),this.#e=this.type+" "+t.ID++}get id(){return this.#t}get name(){return this.#e}get x(){return this.#r}get y(){return this.#o}get width(){return this.#s}get height(){return this.#i}get angle(){return this.#h}get stroke(){return this.#n}get strokeWidth(){return this.#a}get fill(){return this.#l}get alpha(){return parseInt(this.#c,16)/255}get shadow(){return this.#d}get shadowWidth(){return this.#g}get shadowColor(){return this.#u}get visible(){return this.#m}set id(t){this.#t=t}set name(t){this.#e=t}set x(t){"string"==typeof t&&(t=parseInt(t)),this.#r=t}set y(t){"string"==typeof t&&(t=parseInt(t)),this.#o=t}set width(t){"string"==typeof t&&(t=parseInt(t))<10&&(t=10),this.#s=t}set height(t){"string"==typeof t&&(t=parseInt(t))<10&&(t=10),this.#i=t}set stroke(t){this.#n=t}set strokeWidth(t){"string"==typeof t&&(t=parseInt(t)),this.#a=t}set fill(t){this.#l=t}set alpha(t){"string"==typeof t&&(t=parseFloat(t));const e=Math.round(255*t);this.#c=(e<16?"0":"")+e.toString(16)}set shadow(t){this.#d=t}set shadowWidth(t){"string"==typeof t&&(t=parseInt(t)),this.#g=t}set shadowColor(t){this.#u=t}set selected(t){this.#p=t}set visible(t){"toggle"==t?this.toggleVisible():this.#m=t}set angle(t){"string"==typeof t&&(t=parseFloat(t));const e=Math.PI,s=[0,e/4,e/2,3*e/4,e,5*e/4,3*e/2,7*e/4];for(const e of s)if(t>e-.1&&t<e+.1){t=e;break}this.#h=t}set properties(t){t.assign(Object.fromInstance(this))}fillColor(){return this.#l+this.#c}isSelected(){return this.#p}toggleVisible(){this.#m=!this.#m}center(){return[this.#r+this.#s/2,this.y+this.#i/2]}draw(){}drawSelection(t,e){t.save();const{x:s,y:i}=this.setGeometry(t,!1);t.lineWidth=1,this.drawNode(t,0,0),this.drawNode(t,-s,-i),t.restore()}drawLine(t,e,s,i=this.#r,r=this.#o,o=this.#d){t.save(),t.strokeStyle=this.#n,t.lineWidth=this.#a,o&&this.#g>0&&(t.save(),this.addShadow(t),t.beginPath(),t.moveTo(i,r),t.lineTo(e,s),t.stroke(),t.restore()),t.beginPath(),t.moveTo(i,r),t.lineTo(e,s),t.stroke(),t.restore()}drawLineShadow(t,e,s,i=this.#r,r=this.#o){this.#d&&(t.save(),t.strokeStyle=this.#n,t.lineWidth=this.#a,this.addShadow(t),t.beginPath(),t.moveTo(i,r),t.lineTo(e,s),t.stroke(),t.restore())}drawPath(t,e,s=!0,i=this.#h){t.save(),s&&this.setGeometry(t,i),t.fillStyle=this.fillColor(),this.#g>0&&(t.save(),this.addShadow(t),"fill"==this.#d?t.fill(e):"stroke"==this.#d&&t.stroke(e),t.restore()),this.#l&&t.fill(e),this.strokePath(t,e),t.restore()}fillPath(t,e,s=!0,i=this.#h){t.save(),s&&this.setGeometry(t,i),t.fillStyle=this.#l+this.#c,this.#d&&this.#g>0&&(t.save(),this.addShadow(t),t.fill(e),t.restore()),t.fill(e),t.restore()}strokePath(t,e,s=!1,i=this.#h){this.#n&&this.#a>0&&(t.save(),s&&this.setGeometry(t,i),t.strokeStyle=this.#n,t.lineWidth=this.#a,t.lineCap="round",t.lineJoin="round",t.stroke(e),t.restore())}drawRectangle(t){t.save();const{x:e,y:s}=this.setGeometry(t);this.#g>0&&(t.save(),this.addShadow(t),"fill"==this.#d?t.fillRect(e,s,this.#s,this.#i):"stroke"==this.#d&&t.strokeRect(e,s,this.#s,this.#i),t.restore()),this.#l&&(t.save(),t.fillStyle=this.#l+this.#c,t.fillRect(e,s,this.#s,this.#i),t.restore()),this.#n&&this.#a>0&&(t.save(),t.strokeStyle=this.#n,t.lineWidth=this.#a,t.strokeRect(e,s,this.#s,this.#i),t.restore()),t.restore()}drawText(t,e,s={size:30,font:"Airal"}){e=e.split("\n").map((t=>t.trim())),t.save();let{x:i,y:r}=this.setGeometry(t);t.textBaseline=s.baseline||"top",t.textAlign=s.align||"left",t.font=(s.bold?"bold ":"")+(s.italic?"italic ":"")+`${s.size}px `+s.font,t.fillStyle=this.#l,t.strokeStyle=this.#n,t.lineWidth=this.#a;const o=1.2*t.measureText("M").width;for(const s of e)this.#d&&this.#g>0&&(this.addShadow(t),"fill"==this.shadow?t.fillText(s,i,r):"stroke"==this.shadow&&this.strokeWidth>0&&t.strokeText(s,i,r)),this.#l&&t.fillText(s,i,r),this.strokeWidth>0&&t.strokeText(s,i,r),r+=o;t.restore()}setGeometry(t,e=this.#h){const[s,i]=this.center();return t.translate(s,i),e&&t.rotate(e),{x:-this.#s/2,y:-this.#i/2}}addShadow(t){t.shadowColor=this.#u,t.shadowBlur=5,t.shadowOffsetX=this.#g,t.shadowOffsetY=this.#g}drawBorder(t,e=1,s="#000",i=0,r=!1){"number"==typeof i&&(i=[i,i]),t.save();let{x:o,y:h}=this.setGeometry(t,!1);const n=this.#s-2*i[0],a=this.#i-2*i[1];o+=i[0],h+=i[1],r&&t.setLineDash([10,5]),t.strokeStyle=s,t.lineWidth=e,t.strokeRect(o,h,n,a),t.restore()}drawNode(...e){t.drawNode(...e)}release(){}getNodes(){return[]}toSVG(){return""}toSVGFilter(){if(!this.#d)return"";const t=this.#t+"-shadow",e=this.#g;return`<filter id="${t}" x="-50%" y="-50%" width="200%" height="200%"><feFlood flood-color="${this.#u}" result="flood"/><feComposite in2="SourceAlpha" operator="in" result="shadow"/><feGaussianBlur in="shadow" stdDeviation="3"/><feOffset dx="${e}" dy="${e}" result="offsetblur"/><feMerge><feMergeNode in="offsetblur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>`}handleClick(t,e){let s=this.x+this.width/2,i=this.y+this.height/2;return this.inNode(t,e,s,i)?{move:(t,e)=>this.updatePos(t,e)}:(s=this.x+this.width,i=this.y+this.height,this.inNode(t,e,s,i)?{move:(t,e)=>this.updateSize(t,e)}:null)}handleSelect(t,e){const s=this.x,i=s+this.width,r=this.y,o=r+this.height;return this.selected=t>s&&t<i&&e>r&&e<o}inNode(...e){return t.inNode(...e)}updatePos(t,e){this.x=Math.round(t-this.width/2),this.y=Math.round(e-this.height/2)}updateSize(t,e){this.width=Math.round(t-this.#r),this.height=Math.round(e-this.#o)}snap(t,e){const[s,i]=this.center(),r=this.#r+this.#s,o=this.#o+this.#i,h=[[s,i],[this.#r,this.#o],[this.#r,i],[this.#r,o],[s,this.#o],[s,o],[r,this.#o],[r,i],[r,o],[t,this.#o],[this.#r,e],[t,o],[r,e]];for(const s of h)if(this.inNode(t,e,s[0],s[1]))return[s[0],s[1]]}static drawNode(t,e,s,i="#00f",r=!1,o=5){t.strokeStyle=i,t.lineWidth=1,t.beginPath(),t.arc(e,s,o,0,2*Math.PI),t.closePath(),r&&(t.fillStyle="boolean"==typeof r?i:r,t.fill()),t.stroke()}static inNode(t,e,s,i){return t>s-5&&t<s+5&&e>i-5&&e<i+5}}class s extends t{#f="";#x=30;#w=!1;#y=!1;#b="Arial";#v=!1;get type(){return"text"}constructor(t){super(),this.fill="#111111",this.strokeWidth=0,this.stroke=null,this.shadow=null,this.#v=!!t}get size(){return this.#x}get bold(){return this.#w}get italic(){return this.#y}get font(){return this.#b}get value(){return this.#f}set size(t){"string"==typeof t&&(t=parseInt(t)),t<8&&(t=8),this.#x=t,this.#k()}set bold(t){this.#w=t}set italic(t){this.#y=t}set font(t){this.#b=t}set value(t){console.debug("Setting text:",t),this.#f=t,this.#v||this.#k()}set text(t){this.value=t}draw(t){this.#f&&this.drawText(t,this.#f,{size:this.#x,font:this.#b,bold:this.#w,italic:this.#y})}drawSelection(t){this.drawBorder(t,1,"#888",5,!0),super.drawSelection(t)}toSVG(t=this.x,e=this.y){const s=this.fill,i=this.stroke,r=this.alpha,o=this.shadow,h=this.angle*(180/Math.PI);let n="";if(n+=`<text x="${t}" y="${e}" font-size="${this.#x}" font-family="${this.#b}" dy="${this.#x}"`,this.#w&&(n+=' font-weight="bold"'),this.#y&&(n+=' font-style="italic"'),s&&(n+=` fill="${s}"`,r<1&&(n+=` fill-opacity="${r}"`)),i&&(n+=` stroke="${i}" stroke-width="${this.strokeWidth}"`),o&&(n+=` filter="url(#${this.id+"-shadow"})"`),h){const[t,e]=this.center();n+=` transform="rotate(${h},${t},${e})"`}return n+=`>${this.#f}</text>`,n}#k(){if(this.#f){const t=this.#f.trim().split("\n");t.sort(((t,e)=>e.length-t.length)),this.width=t[0].length*this.#x,this.height=t.length*this.#x*1.1}else this.width=this.width,this.height=this.height}}class o extends t{#S=0;#C;get type(){return"rect"}get radius(){return this.#S}set radius(t){"string"==typeof t&&(t=parseInt(t)),this.#S=t,this.#C=this.getPath()}get width(){return super.width}set width(t){super.width=t,this.#S&&this.updatePath()}get height(){return super.height}set height(t){super.height=t,this.#S&&this.updatePath()}draw(t){this.#C?this.drawPath(t,this.#C):this.drawRectangle(t)}strokeBorder(t){this.strokeWidth>0&&super.drawBorder(t,this.strokeWidth,this.stroke,-this.strokeWidth/2)}getPath(t=this.#S){let e=this.width,s=this.height,i=-e/2,r=-s/2;if("number"==typeof t){if(0==t)return;t={tl:t,tr:t,br:t,bl:t}}else{var o={tl:0,tr:0,br:0,bl:0};for(var h in o)t[h]=t[h]||o[h]}const n=new Path2D;return n.moveTo(i+t.tl,r),n.lineTo(i+e-t.tr,r),n.quadraticCurveTo(i+e,r,i+e,r+t.tr),n.lineTo(i+e,r+s-t.br),n.quadraticCurveTo(i+e,r+s,i+e-t.br,r+s),n.lineTo(i+t.bl,r+s),n.quadraticCurveTo(i,r+s,i,r+s-t.bl),n.lineTo(i,r+t.tl),n.quadraticCurveTo(i,r,i+t.tl,r),n.closePath(),n}updatePath(){this.#C=this.getPath()}toSVG(t=!1){const e=this.fill,s=this.stroke,i=this.alpha,r=this.shadow,o=this.angle*(180/Math.PI);let h="";if(h+=`<rect x="${this.x}" y="${this.y}" width="${this.width}" height="${this.height}"`,this.#S>0&&(h+=` rx="${this.#S}" ry="${this.#S}"`),!t&&(e&&(h+=` fill="${e}"`,i<1&&(h+=` fill-opacity="${i}"`)),s&&(h+=` stroke="${s}" stroke-width="${this.strokeWidth}"`),r&&(h+=` filter="url(#${this.id+"-shadow"})"`),o)){const[t,e]=this.center();h+=` transform="rotate(${o},${t},${e})"`}return h+="/>",h}}class h extends o{#f;get type(){return"label"}constructor(){super();const t=new s(this);t.x=10,t.y=10,t.shadowColor="#555555",this.#f=t,this.width=200,this.height=150}get width(){return super.width}get height(){return super.height}get angle(){return super.angle}get text(){return this.#f.value}get textOffsetX(){return this.#f.x}get textOffsetY(){return this.#f.y}get textSize(){return this.#f.size}get textBold(){return this.#f.bold}get textItalic(){return this.#f.italic}get textFill(){return this.#f.fill}get textStroke(){return this.#f.stroke}get textStrokeWidth(){return this.#f.strokeWidth}get textFont(){return this.#f.font}get textShadow(){return this.#f.shadow}get textShadowWidth(){return this.#f.shadowWidth}get textShadowColor(){return this.#f.shadowColor}set width(t){"string"==typeof t&&(t=parseInt(t)),super.width=t,this.#f.width=t-2*this.#f.x}set height(t){"string"==typeof t&&(t=parseInt(t)),super.height=t,this.#f.height=t-2*this.#f.y}set angle(t){"string"==typeof t&&(t=parseFloat(t)),super.angle=t,this.#f.angle=t}set textOffsetX(t){"string"==typeof t&&(t=parseInt(t)),this.#f.x=t,this.#f.width=this.width-2*t}set textOffsetY(t){"string"==typeof t&&(t=parseInt(t)),this.#f.y=t,this.#f.height=this.height-2*t}set textSize(t){"string"==typeof t&&(t=parseInt(t)),this.#f.size=t}set textBold(t){this.#f.bold=t}set textItalic(t){this.#f.italic=t}set textFont(t){this.#f.font=t}set textFill(t){this.#f.fill=t}set textStroke(t){this.#f.stroke=t}set textStrokeWidth(t){"string"==typeof t&&(t=parseInt(t)),this.#f.strokeWidth=t}set textShadow(t){this.#f.shadow=t}set textShadowWidth(t){"string"==typeof t&&(t=parseInt(t)),this.#f.shadowWidth=t}set textShadowColor(t){this.#f.shadowColor=t}set text(t){this.#f.value=t}draw(t){super.draw(t),t.save(),t.translate(this.x,this.y),this.#f.draw(t),t.restore()}drawText(t){this.#f.draw(t)}toSVG(){let t="<g>";const e=this.x+this.#f.x,s=this.y+this.#f.y;return t+=super.toSVG(),t+=this.#f.toSVG(e,s),t+="</g>",t}}class n extends h{#T="left";#B=.2;#I;#P;get type(){return"bubble"}get px(){return this.#I}get py(){return this.#P}set px(t){this.#I=t,this.#T=this.#I<0?"left":"right"}set py(t){this.#P=t}get beak(){return this.#T}set beak(t){this.#T!=t&&(this.#I=-this.#I+this.width,this.#T=t,this.updatePath())}get beakWidth(){return this.#B}set beakWidth(t){"string"==typeof t&&(t=parseFloat(t)),this.#B=t,this.updatePath()}constructor(){super(),this.#I=-30,this.#P=50,this.radius=10}handleClick(t,e){if(!this.isSelected())return;let s=this.x+this.#I,i=this.y+this.#P;return this.inNode(t,e,s,i)?{move:(t,e)=>{this.#I=t-this.x,this.#P=e-this.y,this.updatePath()}}:super.handleClick(t,e)}getPath(){const t=this.width,e=this.height,s=-t/2,i=-e/2,r=s+this.#I,o=i+this.#P;let h=this.radius;const n=(e-2*h)*this.#B;h={tl:h,tr:h,br:h,bl:h};const a=new Path2D;return a.moveTo(s+h.tl,i),a.lineTo(s+t-h.tr,i),a.quadraticCurveTo(s+t,i,s+t,i+h.tr),"right"==this.#T&&(a.lineTo(s+t,i+h.tl),a.lineTo(r,o),a.lineTo(s+t,i+h.tl+n)),a.lineTo(s+t,i+e-h.br),a.quadraticCurveTo(s+t,i+e,s+t-h.br,i+e),a.lineTo(s+h.bl,i+e),a.quadraticCurveTo(s,i+e,s,i+e-h.bl),"left"==this.#T&&(a.lineTo(s,i+h.tl+n),a.lineTo(r,o)),a.lineTo(s,i+h.tl),a.quadraticCurveTo(s,i,s+h.tl,i),a.closePath(),a}drawSelection(t,e){this.drawNode(t,this.x+this.#I,this.y+this.#P),super.drawSelection(t)}}class a extends t{get type(){return"canvas"}constructor(){super("canvas"),this.x=0,this.y=0,this.width=0,this.height=0,this.stroke=null,this.fill="#fafafa"}handleClick(){}handleSelect(){}draw(t){this.drawRectangle(t)}}class l{#j;#D;constructor(t){this.#j=t}get name(){return"none"}glfx(){return this.#j.glfx()}image(){return this.#j.image()}getBitmap(){return this.#D}setBitmap(t){this.#D=t}release(){this.#D&&(this.#D.close(),this.#D=null)}apply(){}}class c extends l{#S=5;get radius(){return this.#S}set radius(t){this.release(),this.#S=t,t>0&&this.setBitmap(this.apply())}}class d extends l{#E=.5;get amount(){return this.#E}set amount(t){this.release(),this.#E=t,t>0&&this.setBitmap(this.apply())}}class u extends c{#r;#o;get x(){return this.#r}get y(){return this.#o}constructor(t){super(t),this.#r=t.width/2,this.#o=t.height/2}apply(){}}class g extends l{#_=.3;get name(){return"zoomBlur"}get strength(){return this.#_}set strength(t){this.release(),this.#_=t,t>0&&this.setBitmap(this.apply())}}class p extends c{#_=.3;get strength(){return this.#_}set strength(t){this.release(),this.#_=t,t>0&&this.setBitmap(this.apply())}}class m extends c{get name(){return"triangleBlur"}apply(){return this.glfx().triangleBlur(this.image(),this.radius)}}class f extends c{#R=.75;#h=0;get name(){return"lensBlur"}get brightness(){return this.#R}get angle(){return this.#h}set brightness(t){this.release(),this.#R=t,t>0&&this.setBitmap(this.apply())}set angle(t){this.release(),this.#h=t,t>0&&this.setBitmap(this.apply())}apply(){return this.glfx().lensBlur(this.image(),this.radius,this.#R,this.#h)}}class x extends g{get name(){return"zoomBlur"}apply(){return this.glfx().zoomBlur(this.image(),this.strength)}}class w extends g{get name(){return"ink"}apply(){return this.glfx().ink(this.image(),this.strength)}}class y extends l{#R=0;#A=0;get name(){return"brightnessContrast"}get brightness(){return this.#R}get contrast(){return this.#A}set brightness(t){this.release(),t>0&&this.setBitmap(this.glfx().brightnessContrast(this.image(),t,this.#A)),this.#R=t}set contrast(t){this.release(),t>0&&this.setBitmap(this.glfx().brightnessContrast(this.image(),this.#R,t)),this.#A=t}}class b extends l{#z=0;#W=0;get name(){return"hueSaturation"}get brightness(){return this.#z}get contrast(){return this.#W}set hue(t){this.release(),t>0&&this.setBitmap(this.glfx().hueSaturation(this.image(),t,this.#W)),this.#z=t}set saturation(t){this.release(),t>0&&this.setBitmap(this.glfx().hueSaturation(this.image(),this.#z,t)),this.#W=t}}class v extends u{#h=0;get name(){return"swirl"}get angle(){return this.#h}set angle(t){this.release(),this.#h=t,t>0&&this.setBitmap(this.apply())}apply(){return this.glfx().swirl(this.image(),this.radius,this.#h,this.x,this.y)}}class k extends u{#_=.25;get name(){return"bulgePinch"}get strength(){return this.#_}set strength(t){this.release(),this.#_=t,t>0&&this.setBitmap(this.apply())}apply(){return this.glfx().bulgePinch(this.image(),this.radius,this.#_,this.x,this.y)}}class S extends l{#F=20;get name(){return"denoise"}get exponent(){return this.#F}set exponent(t){this.release(),this.#F=t,this.setBitmap(this.glfx().denoise(this.image(),this.#F))}}class C extends p{get name(){return"unsharpMask"}apply(){return this.glfx().unsharpMask(this.image(),this.radius,this.strength)}}class T extends d{get name(){return"noise"}apply(){return this.glfx().noise(this.image(),this.amount)}}class B extends d{get name(){return"sepia"}apply(){return this.glfx().sepia(this.image(),this.amount)}}class I extends d{#x=.5;get name(){return"vignette"}get size(){return this.#x}set size(t){this.#x=t,this.release(),this.setBitmap(this.apply())}apply(){return this.glfx().vignette(this.image(),this.#x,this.amount)}}class P extends d{get name(){return"vibrance"}apply(){return this.glfx().vibrance(this.image(),this.amount)}}let j;const D=new OffscreenCanvas(512,512),E=D.getContext("2d");class _ extends o{#M;#j;#D;#O;#N;#U=0;#$=0;#L;#X=0;#Y=0;#G=0;#H=0;#V=!0;#q=!1;#K=0;#Z=0;#J=0;#Q=0;#tt;#et=0;get type(){return"image"}constructor(t){super(),t instanceof _&&(this.#j=t.image(),this.#M=t.file)}set file(t){t instanceof File&&(this.#M||(this.#M=t,this.#j=this.load(t)))}set selected(t){super.selected=t}set imgX(t){"string"==typeof t&&(t=parseInt(t)),this.#X=t}set imgY(t){"string"==typeof t&&(t=parseInt(t)),this.#Y=t}set imgWidth(t){if("string"==typeof t&&(t=parseInt(t)),0==t)return;let e=this.#Q/(this.#J||1);console.debug("## P",e),this.#G=t,this.#V&&(this.#H=Math.round(this.#G*e))}set imgHeight(t){if("string"==typeof t&&(t=parseInt(t)),0==t)return;let e=this.#G/(this.#H||1);this.#H=t,this.#V&&(this.#G=Math.round(this.#H*e))}set imgMirror(t){this.#q=t}set imgScale(t){if("string"==typeof t&&(t=parseFloat(t)),isNaN(t)||0==t)return;const e=this.width==this.#G&&this.height==this.#H;this.#G=Math.round(this.#j.width*t),this.#H=Math.round(this.#j.height*t),e&&(this.width=this.#G,this.height=this.#H)}set imgKeepProportion(t){this.#V=t}set cropX(t){"string"==typeof t&&(t=parseInt(t)),this.#K=t}set cropY(t){"string"==typeof t&&(t=parseInt(t)),this.#Z=t}set cropWidth(t){"string"==typeof t&&(t=parseInt(t)),this.#J=t}set cropHeight(t){"string"==typeof t&&(t=parseInt(t)),this.#Q=t}set cropMirror(t){this.#q=t}set mask(t){this.#O=t}set maskPath(t){this.#N=t}set maskX(t){"string"==typeof t&&(t=parseInt(t)),this.#U=t??0}set maskY(t){"string"==typeof t&&(t=parseInt(t)),this.#$=t??0}set blur(t){"string"==typeof t&&(t=parseInt(t)),this.#D&&this.#D.close(),this.#D=t>0?glfx.blur(this.#j,t):null}set filter(t){switch(this.#L&&(this.#L.release(),this.#L=null),t){case"triangleBlur":this.#L=new m(this);break;case"zoomBlur":this.#L=new x(this);break;case"lensBlur":this.#L=new f(this);break;case"ink":this.#L=new w(this);break;case"contrast":this.#L=new y(this);break;case"hue":this.#L=new b(this);break;case"swirl":this.#L=new v(this);break;case"bulge":this.#L=new k(this);break;case"denoise":this.#L=new S(this);break;case"unsharp":this.#L=new C(this);break;case"noise":this.#L=new T(this);break;case"sepia":this.#L=new B(this);break;case"vignette":this.#L=new I(this);break;case"vibrance":this.#L=new P(this)}}set filterRadius(t){this.#L&&("string"==typeof t&&(t=parseInt(t)),this.#L.radius=t)}set filterStrength(t){this.#L&&("string"==typeof t&&(t=parseFloat(t)),this.#L.strength=t)}set filterBrightness(t){this.#L&&("string"==typeof t&&(t=parseFloat(t)),this.#L.brightness=t)}set filterAngle(t){this.#L&&("string"==typeof t&&(t=parseFloat(t)),this.#L.angle=t)}set filterContrast(t){this.#L&&("string"==typeof t&&(t=parseFloat(t)),this.#L.contrast=t)}set filterHue(t){this.#L&&("string"==typeof t&&(t=parseFloat(t)),this.#L.hue=t)}set filterSaturation(t){this.#L&&("string"==typeof t&&(t=parseFloat(t)),this.#L.saturation=t)}set filterExponent(t){this.#L&&("string"==typeof t&&(t=parseInt(t)),this.#L.exponent=t)}set filterAmount(t){this.#L&&("string"==typeof t&&(t=parseFloat(t)),this.#L.amount=t)}set filterSize(t){this.#L&&("string"==typeof t&&(t=parseFloat(t)),this.#L.size=t)}get file(){return this.#M}get imgX(){return this.#X}get imgY(){return this.#Y}get imgWidth(){return Math.round(this.#G)}get imgHeight(){return Math.round(this.#H)}get imgMirror(){return this.#q}get imgScale(){return this.#G/this.#j.width}get imgKeepProportion(){return this.#V}get cropX(){return this.#K}get cropY(){return this.#Z}get cropWidth(){return this.#J}get cropHeight(){return this.#Q}get mask(){return this.#O}get maskPath(){return"string"==typeof this.#N?this.#N:this.#N?.id}get maskX(){return this.#U}get maskY(){return this.#$}get blur(){return this.#et}get filter(){return this.#L?.name}get filterRadius(){return this.#L?.radius??0}get filterStrength(){return this.#L?.strength??0}get filterBrightness(){return this.#L?.brightness??0}get filterAngle(){return this.#L?.angle??0}get filterContrast(){return this.#L?.contrast??0}get filterHue(){return this.#L?.hue??0}get filterSaturation(){return this.#L?.saturation??0}get filterExponent(){return this.#L?.exponent??0}get filterAmount(){return this.#L?.amount??0}get filterSize(){return this.#L?.size??0}image(){return this.#j}glfx(){return glfx}setMask(t,e=!0){if(this.#O=t.name,this.#N=t,e){const[e,s]=this.center(),[i,r]=t.center();this.#U=i-e,this.#$=r-s}}release(){this.#j&&URL.revokeObjectURL(this.#j.src),this.#D&&this.#D.close()}draw(t){this.drawRectangle(t);let e=Math.min(this.width,this.#G),s=Math.min(this.height,this.#H),i=this.#L?.getBitmap()||this.#j,r=this.x+this.#X,o=this.y+this.#Y;if(this.imgScale,this.#O){D.width=i.width,D.height=i.height,E.save();const t=this.#j.width/2+this.#U,e=this.#j.height/2+this.#$,s=this.#G/this.#j.width,r=this.#H/this.#j.height;E.translate(t,e),E.scale(s,r),E.clip(this.#N.getPath()),E.translate(-t,-e),E.drawImage(i,0,0,i.width,i.height),E.restore(),i=D}t.save(),t.translate(r,o),r=0,o=0,this.angle&&(r=this.width/2,o=this.height/2,t.translate(r,o),t.rotate(this.angle),r=-r,o=-o),this.#q?(t.scale(-1,1),t.drawImage(i,this.#K,this.#Z,this.#J,this.#Q,r,o,-e,s)):t.drawImage(i,this.#K,this.#Z,this.#J,this.#Q,r,o,e,s),this.#tt&&(t.fillStyle="#222",t.fill(this.#tt)),t.restore(),this.strokeBorder(t)}drawSelection(t){0==this.strokeWidth&&this.drawBorder(t,1,"#333",0,!0),super.drawSelection(t)}updateSize(t,e){super.updateSize(t,e),Math.abs(this.width-this.#G)<4&&(this.width=this.#G),Math.abs(this.height-this.#H)<4&&(this.height=this.#H)}blurSlow(t,e=this.#et){if(0==e)return;const s=this.x+this.#X,i=this.y+this.#Y,r=this.#G,o=this.#H,h=t.getImageData(s,i,r,o),n=h.data,a=new Uint8ClampedArray(n);for(let t=0;t<o;t++)for(let s=0;s<r;s++){let i=0,h=0,l=0,c=0;for(let n=-e;n<=e;n++)for(let d=-e;d<=e;d++){const e=s+d,u=t+n;if(e>=0&&e<r&&u>=0&&u<o){const t=4*(u*r+e);i+=a[t],h+=a[t+1],l+=a[t+2],c++}}const d=4*(t*r+s);n[d]=i/c,n[d+1]=h/c,n[d+2]=l/c}t.putImageData(h,s,i)}async load(t,e=1200,s=900){this.#M=t,this.#j=await _.load(t),console.debug("Image imported:",this.#j.width,this.#j.height);const i=e-this.#j.width,r=s-this.#j.height;if(i<0||r<0){const t=i<r?e/this.#j.width:s/this.#j.height,o=this.#j.width*t,h=this.#j.height*t;D.width=o,D.height=h,E.drawImage(this.#j,0,0,this.#j.width,this.#j.height,0,0,o,h),URL.revokeObjectURL(this.#j.src),this.#j=await async function(t){const e=await function(t,e="image/png"){return t.convertToBlob({type:e})}(t);return R(e)}(D)}this.width=this.width||this.#j.width,this.height=this.height||this.#j.height,this.#G=this.#G||this.#j.width,this.#H=this.#H||this.#j.height,this.#K=0,this.#Z=0,this.#J=this.#j.width,this.#Q=this.#j.height}async detectBodySelfie(t=.7){await async function(){j||(j=await bodyPix.load({architecture:"ResNet50",outputStride:16,multiplier:1,quantBytes:2}))}();const e=this.#D||this.#j,s=await bodySegmentation.createSegmenter(bodySegmentation.SupportedModels.MediaPipeSelfieSegmentation,{runtime:"mediapipe",modelType:"general"}),i=await s.segmentPeople(e),r=await bodySegmentation.toBinaryMask(i);this.#O=function(t){const e=new Path2D;return console.log(t),e}(r)}static load=R}function R(t){return new Promise(((e,s)=>{const i=new Image;i.src=URL.createObjectURL(t),i.onload=()=>e(i),i.onerror=s}))}class A extends s{get type(){return"emoji"}constructor(t){super(),this.value=t,this.font="Win32"==window.navigator.platform?"Noto Color Emoji":"emoji",this.size=50}}class z{x;y;constructor(t,e){this.x=t,this.y=e}isLine(){return!0}controlPoint(){return this}toCurve(){return new W(this.x,this.y)}clone(){return new z(this.x,this.y)}draw(t){t.lineTo(this.x,this.y)}move(t,e){this.x+=t,this.y+=e}set(t,e){this.x=t,this.y=e}invert(t,e){const s=2*t-this.x,i=2*e-this.y;this.set(s,i)}tangent(t,e){}split(t,e=.5){const s=M(t,this),i=new z(this.x,this.y);return this.set(s.x,s.y),i}moveTangent(){}moveNode(t,e){this.x+=t,this.y+=e}toArray(){return[this.x,this.y]}toSVG(t=0,e=0){return`L ${this.x+t} ${this.y+e}`}static create(t,e){const s=new z;return s.x=t,s.y=e,s}}class W extends z{cp=new z;constructor(t,e){super(t,e),this.cp.set(t,e)}isLine(){return!1}toArray(){return[this.cp.x,this.cp.y,this.x,this.y]}toSVG(t=0,e=0){return`Q ${this.cp.x+t} ${this.cp.y+e}, ${this.x+t} ${this.y+e}`}clone(){const t=new W(this.x,this.y);return t.cp.set(this.cp.x,this.cp.y),t}controlPoint(){return this.cp}setControlPoint(t,e){this.cp.set(t,e)}toCurve(t,e){const s=new F(this.x,this.y);return s.cp.set(t+2/3*(this.cp.x-t),e+2/3*(this.cp.y-e)),s.cp2.set(this.x+2/3*(this.cp.x-this.x),this.y+2/3*(this.cp.y-this.y)),s}draw(t){t.quadraticCurveTo(this.cp.x,this.cp.y,this.x,this.y)}move(t,e){super.move(t,e),this.cp.x+=t,this.cp.y+=e}moveTangent(t,e){this.cp.x+=t,this.cp.y+=e}tangent(t,e){const s=2*this.x-t,i=2*this.y-e;this.cp.set(s,i)}static draw(t,e){}}class F extends W{cp2=new z;toArray(){return[this.cp.x,this.cp.y,this.cp2.x,this.cp2.y,this.x,this.y]}toSVG(t=0,e=0){return`C ${this.cp.x+t} ${this.cp.y+e}, ${this.cp2.x+t} ${this.cp2.y+e}, ${this.x+t} ${this.y+e}`}clone(){const t=new F(this.x,this.y);return t.cp.set(this.cp.x,this.cp.y),t.cp2.set(this.cp2.x,this.cp2.y),t}controlPoint(){return this.cp2}toCurve(){return this}draw(t){t.bezierCurveTo(this.cp.x,this.cp.y,this.cp2.x,this.cp2.y,this.x,this.y)}tangent(t,e){const s=2*this.x-t,i=2*this.y-e;this.cp2.set(s,i)}move(t,e){super.move(t,e),this.cp2.x+=t,this.cp2.y+=e}moveNode(t,e){super.moveNode(t,e),this.cp2.x+=t,this.cp2.y+=e}split(t,e=.5){const s=M(t,this.cp,e),i=M(this.cp,this.cp2,e),r=M(this.cp2,this,e),o=M(s,i,e),h=M(i,r,e),n=M(o,h,e),a=new F(this.x,this.y);return a.cp=h,a.cp2=r,this.cp.set(s.x,s.y),this.cp2.set(o.x,o.y),this.set(n.x,n.y),a}}function M(t,e,s){return new z((1-s)*t.x+s*e.x,(1-s)*t.y+s*e.y)}class O extends t{get type(){return"path"}#st=[];#it=!1;#rt=!1;#ot;#ht;#nt;#C;get closed(){return this.#rt}set closed(t){this.#rt=!!t}get segments(){return this.#st.map((t=>t.toArray()))}set segments(t){let e,s=[];for(const i of t)6==i.length?(e=new F,e.cp.set(i[0],i[1]),e.cp2.set(i[2],i[3]),e.set(i[4],i[5])):4==i.length?(e=new W,e.cp.set(i[0],i[1]),e.set(i[2],i[3])):e=new z(i[0],i[1]),s.push(e);this.#st=s,this.updatePath()}getNodes(){const t=this.#st.map((t=>new N(this,t)));for(let e=1;e<t.length;++e)t[e].prev=t[e-1],t[e-1].next=t[e];if(this.#rt){const e=t[0],s=t.last();s.next=e,e.prev=s}return t}getPath(){return this.#C}draw(t,e="select"){if(0==this.#st.length)return;const s="draw"==e,i="edit"==e?0:this.angle,r=this.#rt||!this.#ot;if(this.#st.length>1){const e=this.#C;!s&&this.#rt?this.drawPath(t,e,!0,i):this.strokePath(t,e,r,i)}const o=this.#st.last();if(s&&!r){const e=this.#st[0];this.drawNode(t,e.x,e.y),t.save(),t.strokeStyle="#f33",t.lineWidth=1;const s=new Path2D,i=this.#ot.controlPoint();let r=o;s.moveTo(o.x,o.y),this.#ot.draw(s),t.stroke(s),t.strokeStyle="#33f",this.#it&&(r=new z(i.x,i.y),r.invert(o.x,o.y)),t.moveTo(r.x,r.y),t.lineTo(i.x,i.y),t.stroke(),this.drawNode(t,i.x,i.y),this.#it&&this.drawNode(t,r.x,r.y),this.#st.length>1&&this.inNode(this.#ot.x,this.#ot.y,e.x,e.y)?this.drawNode(t,this.#ot.x,this.#ot.y,"#f33","#f33"):this.drawNode(t,this.#ot.x,this.#ot.y),t.restore()}else super.draw(t)}drawSelection(t,e){"edit"==e||(super.drawSelection(t,e),this.drawBorder(t,1,"#888",8,!0))}addPoint(t,e){this.#st.push(new z(t,e))}addCurve2(t,e,s,i){const r=new W(t,e);r.cp.set(s,i),this.#st.push(r)}addCurve3(t,e,s,i,r,o){const h=new F(t,e);h.cp.set(s,i),h.cp2.set(r,o),this.#st.push(h)}mouseMove(t,e,s){this.#ht&&!this.inNode(t,e,this.#ht.x,this.#ht.y)&&(this.#ht=null,this.#it=!0,s.Control?(this.#ot=new W,this.#ot.cp.set(t,e)):this.#at()),this.#it&&this.#st.last().tangent(t,e),this.#ot.set(t,e),this.#C=this.getPath()}mouseDown(t,e,s){console.debug("PATH down:",t,e),this.#ot||(this.#ot=new z(t,e)),this.#ht=new z(t,e),this.#it=!1,this.#lt()}mouseUp(t,e,s){console.debug("PATH up:",t,e,this.#ht),this.#it&&(this.#st.last(),this.#ot=new W(t,e),this.#it=!1),this.#nt=this.#st.length-1,this.#ht=null}getPath(t=this.#rt){const e=new Path2D;let s,i;t?(s=this.#st.last(),i=this.#st):(s=this.#st[0],i=this.#st.slice(1)),e.moveTo(s.x,s.y);for(const t of i)t.draw(e);return t&&e.closePath(),e}updatePath(){this.#C=this.getPath()}toSVG(){const t=this.fill,e=this.stroke,s=this.alpha,i=this.shadow,r=this.angle*(180/Math.PI),[o,h]=this.center(),n=this.#rt?this.#st.last():this.#st[0];let a='<path d="';a+=`M ${n.x+o} ${n.y+h}`;for(const t of this.#st)a+=" "+t.toSVG(o,h);return this.#rt&&(a+=" Z"),a+='"',t&&(a+=` fill="${t}"`,s<1&&(a+=` fill-opacity="${s}"`)),e&&(a+=` stroke="${e}" stroke-width="${this.strokeWidth}"`),i&&(a+=` filter="url(#${this.id+"-shadow"})"`),r&&(a+=` transform="rotate(${r},${o},${h})"`),a+="/>",a}close(t=!0){console.debug("PATH close:",this.#st[0]);let e=this.#st[0],s=this.#st.last();e.isLine()&&(this.#st.shift(),e=this.#st[0]),s.isLine()||e.isLine()||(console.debug("First:",e),console.debug("Last:",s),e=e.toCurve(s.x,s.y),s=s.toCurve(s.x,s.y),e.cp.set(2*s.x-s.cp2.x,2*s.y-s.cp2.y),e.cp.set(s.cp2.x,s.cp2.y),e.cp.invert(s.x,s.y),console.debug("First:",e),console.debug("Last:",s),this.#st[0]=e,this.#st[this.#st.length-1]=s),console.debug("PATH close reduce:",this.#st),this.#rt=!0,this.end(t)}end(t=!0){t&&this.#ct(),this.#ot=null,this.move(0,0)}remove(t){if(this.#st.length<3)return!1;let e;t instanceof N?(t.prev.next=t.next,t.next.prev=t.prev,e=t.segment,t=this.#st.findIndex((t=>t==e))):e=this.#st[t];const s=t<this.#st.length-1?this.#st[t+1]:this.#st[0],i=t>0?this.#st[t-1]:this.#st.last();if(e.isLine());else if(s.isLine());else if(i.isLine());else{const t=i.x+1.75*(i.x-i.cp2.x),r=i.y+1.75*(i.y-i.cp2.y);s.cp.set(t,r),s.cp2.set(e.cp2.x,e.cp2.y),i.tangent(t,r)}return this.#st.splice(t,1),this.updatePath(),!0}split(t){let e,s;t instanceof N?(s=t,e=t.segment,t=this.#st.findIndex((t=>t==e))):e=this.#st[t];const i=t>0?this.#st[t-1]:this.#st.last(),r=e.split(i);this.#st.splice(t+1,0,r),this.updatePath();const o=new N(this,r);return s&&(o.next=s.next,o.prev=s,s.next=o),o}undo(){this.#ot=this.#st.pop(),this.#nt--}move(t,e){const[s,i]=this.center(),r=t-s,o=e-i;for(const t of this.#st)t.move(r,o);this.#C=this.getPath()}#at(){if(this.#st.length<2)return;const t=this.#st[this.#st.length-2],e=this.#st.last().toCurve(t.x,t.y);console.log(e),this.#st[this.#st.length-1]=e}#lt(){const t=this.#st[0];if(t&&this.inNode(this.#ot.x,this.#ot.y,t.x,t.y))return this.#ot.set(t.x,t.y),this.#st.push(this.#ot),void this.close();console.debug("# Adding point",this.#ot,this.#st),this.#st.push(this.#ot),this.#ot=new z(this.#ot.x,this.#ot.y),this.#C=this.getPath()}#ct(t=0,e=0){const s=this.#st[0];let i=s.x,r=i,o=s.y,h=o;for(const t of this.#st)t.x<i?i=t.x:t.x>r&&(r=t.x),t.y<o?o=t.y:t.y>h&&(h=t.y);i=Math.round(i),o=Math.round(o),r=Math.round(r),h=Math.round(h),this.x=i,this.y=o,this.width=Math.abs(r-i),this.height=Math.abs(h-o)}}O.detectBody=async function(t,e=.7){await async function(){$||($=await bodyPix.load({architecture:"ResNet50",outputStride:16,multiplier:1,quantBytes:2}))}();const s=t.image(),i=await $.segmentPerson(s,{flipHorizontal:!1,internalResolution:.75,segmentationThreshold:e}),r=function(t){const{width:e,height:s,data:i}=t,r=[];for(let t=1;t<s-1;t++)for(let s=1;s<e-1;s++)i[4*(t*e+s)+3]>0&&(0!==i[4*((t-1)*e+s)+3]&&0!==i[4*((t+1)*e+s)+3]&&0!==i[4*(t*e+(s-1))+3]&&0!==i[4*(t*e+(s+1))+3]||r.push([s,t]));const o=function(t){if(0===t.length)return[];const e=[t.shift()];for(;t.length>0;){const s=e[e.length-1];let i=0,r=1/0;for(let e=0;e<t.length;e++){const[o,h]=s,[n,a]=t[e],l=Math.hypot(n-o,a-h);l<r&&(r=l,i=e)}e.push(t.splice(i,1)[0])}return e}(r);return function(t,e){if(t.length<3)return t;const s=function(t,e=10){const s=[];for(let i=0;i<t.length-1;i++){const r=t[Math.max(i-1,0)],o=t[i],h=t[i+1],n=t[Math.min(i+2,t.length-1)];for(let t=0;t<=1;t+=1/e){const e=t*t,i=e*t,a=.5*(2*o[0]+(-r[0]+h[0])*t+(2*r[0]-5*o[0]+4*h[0]-n[0])*e+(-r[0]+3*o[0]-3*h[0]+n[0])*i),l=.5*(2*o[1]+(-r[1]+h[1])*t+(2*r[1]-5*o[1]+4*h[1]-n[1])*e+(-r[1]+3*o[1]-3*h[1]+n[1])*i);s.push([a,l])}}return s.push(t[t.length-1]),s}(t),i=function(t,e){const s=[0];for(let e=1;e<t.length;e++){const[i,r]=t[e-1],[o,h]=t[e];s.push(s[e-1]+Math.hypot(o-i,h-r))}const i=s[s.length-1]/(e-1),r=[t[0]];let o=i;for(let e=1;e<s.length;e++)for(;o<=s[e];){const h=(o-s[e-1])/(s[e]-s[e-1]),[n,a]=t[e-1],[l,c]=t[e];r.push([n+h*(l-n),a+h*(c-a)]),o+=i}return r.push(t[t.length-1]),r}(s,91);return function(t){if(t.length<=2)return t;const e=[t[0]];for(let s=1;s<t.length-1;s++){const[i,r]=e[e.length-1],[o,h]=t[s],[n,a]=t[s+1];(o-i)*(a-r)!=(h-r)*(n-i)&&e.push(t[s])}return e.push(t[t.length-1]),e}(i)}(o)}(bodyPix.toMask(i)),o=new O;o.x=0,o.y=0,o.width=t.width,o.height=t.height,o.addPoint(r[0][0],r[0][1]);for(let t=1;t<r.length-2;t+=3)o.addCurve3(r[t+2][0],r[t+2][1],r[t][0],r[t][1],r[t+2][0],r[t+2][1]);return o.close(!1),o.x=t.x,o.y=t.y,o.alpha=.5,t.setMask(o),o};class N{#dt;#C;#p=!1;#ut;#gt;#pt=new z;prev;get x(){return this.#dt.x+this.#pt.x}get y(){return this.#dt.y+this.#pt.y}get selected(){return this.#p}get next(){return this.#gt}get segment(){return this.#dt}get control(){return!0}constructor(t,e){const[s,i]=t.center();this.#pt.set(s,i),this.#dt=e,this.#C=t,e.isLine()||(this.#ut=new U(e,t))}set next(t){this.#ut&&this.#ut.add(t.segment),this.#gt=t}move(t,e){const s=t-this.x,i=e-this.y;this.#dt.moveNode(s,i),this.#gt&&this.#gt.segment.moveTangent(s,i),this.#p=!0,this.#C.updatePath()}draw(t){this.#p?(O.drawNode(t,this.x,this.y,"#33f","#55e"),this.#ut&&this.#ut.draw(t)):O.drawNode(t,this.x,this.y)}handleSelect(t,e){if(this.#p){const s=this.#ut?.handleSelect(t,e);if(s)return s}if(O.inNode(t,e,this.x,this.y))return this.#p=!this.#p,this}}class U{#mt;#ft;#dt;#xt;#C;constructor(t,e){this.#mt=t.cp2||t,this.#dt=this.#ft=t;const[s,i]=e.center();this.#xt=new z(s,i),this.#C=e}add(t){this.#ft=t.cp||t}draw(t){t.save(),t.lineWidth=2,t.strokeStyle="#55e",t.setLineDash([6,2]),t.translate(this.#xt.x,this.#xt.y),t.moveTo(this.#mt.x,this.#mt.y),t.lineTo(this.#ft.x,this.#ft.y),t.stroke(),this.#ft.isLine()&&this.#wt(t,this.#ft),this.#mt.isLine()&&this.#wt(t,this.#mt),t.restore()}handleSelect(t,e){t-=this.#xt.x,e-=this.#xt.y;class s{constructor(t,e,s,i,r){this.p=t,this.p0=e,this.p1=s,this.o=i,this.path=r}move(t,e){t-=this.o.x,e-=this.o.y,this.p0.set(t,e),this.p1.isLine()&&(this.p1.set(t,e),this.p1.invert(this.p.x,this.p.y)),this.path.updatePath()}}return O.inNode(t,e,this.#mt.x,this.#mt.y)?new s(this.#dt,this.#mt,this.#ft,this.#xt,this.#C):this.#ft.isLine()&&O.inNode(t,e,this.#ft.x,this.#ft.y)?new s(this.#dt,this.#ft,this.#mt,this.#xt,this.#C):void 0}#wt(t,e){O.drawNode(t,e.x,e.y,"#f44336","#f44336")}}let $;class L extends t{#yt=[200,0];#bt="end";get type(){return"arrow"}constructor(){super(),this.width=200,this.height=20}get y(){return super.y+this.height/2}set y(t){"string"==typeof t&&(t=parseInt(t)),super.y=t-this.height/2}set fill(t){}get fill(){return this.stroke}get stroke(){return super.stroke}set stroke(t){super.stroke=t,super.fill=t}get arrow(){return this.#bt}set arrow(t){this.#bt=t}draw(t){let[e,s,i,r]=this.#vt();const o=8+1.3*this.strokeWidth;t.save(),t.translate(e,s),t.rotate(this.angle);let h,n,a=i-e,l=r-s;if(e=0,"begin"==this.#bt||"both"==this.#bt){e+=o;const t=new Path2D;t.moveTo(o,o/2),t.lineTo(0,0),t.lineTo(o,-o/2),t.closePath(),h=t}else this.#kt(t,0,0);if("end"==this.#bt||"both"==this.#bt){a-=o;const t=new Path2D;t.moveTo(a,o/2),t.lineTo(a+o,0),t.lineTo(a,-o/2),t.closePath(),n=t}else this.#kt(t,a,l);this.drawLine(t,a+1,l,e,0),h&&this.fillPath(t,h,!1,0),n&&this.fillPath(t,n,!1,0),this.drawLine(t,a+1,0,e-1,0,!1),t.restore(),super.draw(t)}drawSelection(t){const[e,s,i,r]=this.#vt();t.save(),t.translate(e,s),t.rotate(this.angle),this.drawNode(t,0,0),this.drawNode(t,i-e,r-s),t.restore()}toSVGFilter(){if(!this.shadow)return"";const t=this.id+"-shadow",e=this.shadowWidth;return`<filter id="${t}" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="${e}" dy="${e}" stdDeviation="5" flood-color="${this.shadowColor}"/></filter>`}toSVG(){const t=8+1.3*this.strokeWidth,e=this.stroke,s=this.angle*(180/Math.PI),i=this.x,r=this.y;let o=i,h=this.x+this.width,n=.7*this.strokeWidth,a="";return n<2&&(n=2),a+=`<g stroke="${e}" stroke-width="${this.strokeWidth}" fill="${e}"`,s&&(a+=` transform="rotate(${s},${i},${r})"`),a+=">","end"==this.#bt||"both"==this.#bt?(h-=t,a+=`<path d="M ${h} ${r+t/2} L ${h+t} ${r} L ${h} ${r-t/2} Z"/>`):a+=`<circle cx="${h}" cy="${r}" r="${n}"/>`,"begin"==this.#bt||"both"==this.#bt?(o+=t,a+=`<path d="M ${o} ${r+t/2} L ${o-t} ${r} L ${o} ${r-t/2} Z"/>`):a+=`<circle cx="${i}" cy="${r}" r="${n}" fill="${e}"/>`,a+=`<line x1="${o}" y1="${r}" x2="${h}" y2="${r}"/>`,a+="</g>",a}handleClick(t,e){const[s,i,r,o]=this.#vt(!0);return this.inNode(t,e,s,i)?{move:(t,e)=>{this.x=Math.round(t),this.y=Math.round(e-this.height/2)}}:this.inNode(t,e,r,o)?{move:(t,e)=>{const[s,i]=this.#vt();let r=Math.asin((e-i)/this.width);isNaN(r)?r=e>i?Math.PI/2:3*Math.PI/2:t<s?r=Math.PI-r:r<0&&(r=2*Math.PI+r),this.width=e==i?Math.abs(t-s):t==s?Math.abs(e-i):Math.hypot(t-s,e-i),this.angle=r}}:null}handleSelect(t,e){const s=this.x,i=this.y,r=this.angle,o=t-s,h=e-i,n=Math.cos(-r),a=Math.sin(-r),l=o*n-h*a+s,c=o*a+h*n+i,d=this.x,u=super.y,g=d+this.width,p=u+this.height;return l>=d&&l<=g&&c>=u&&c<=p}#kt(t,e,s){let i=.7*this.strokeWidth;i<2&&(i=2),this.drawNode(t,e,s,this.stroke,!0,i)}#vt(t=!1){let e=this.x,s=this.y,i=this.width,r=0;return t&&(r=i*Math.sin(this.angle),i*=Math.cos(this.angle)),[e,s,e+i,s+r]}}class X{#St=!1;get name(){return"app"}get version(){return 1}get isSetup(){return this.#St}async init(){if(!window.indexedDB)throw console.log("Your browser doesn't support IndexedDB"),new Error("IndexDB is not supported");this.db=await this.#Ct(),this.isSetup&&await this.setup()}needSetup(t){return 0==t}setup(){}ls(t,e=!1,s=0,i=100){return this.#Tt(t,e,s,i)}tail(t,e=0,s=50){return this.#Tt(t,!0,e,s)}lsByIndex(t,e,s,i=!1,r=30,o=0){return this.#Bt(t,e,s,o,r,i)}lsByRating(t,e,s){return this.#It(t,"rating",e,s,!0)}lsByRange(t,e,s,i,r=!1,o=50){return this.#Pt(t,e,s,i,r,o)}latest(t,e=0,s=100){return this.#Bt(t,"ts",0,e,s,!0)}count(t){return this.#jt(t)}put(t,e){return X.put(this.db,t,e)}update(t,...e){return this.#Dt(t,...e)}updateByIndex(t,...e){return this.#Et(t,...e)}push(t,...e){return this.#_t(t,...e)}get(t,e){return this.#Rt(t,e)}rm(t,e){return this.#At(t,e)}rmByIndex(t,e,s){return this.#zt(t,e,s)}pushValue(t,e,s,i){return this.#Wt(t,e,s,i)}pushValueByIndex(t,e,s,i,r){return this.#Ft(t,e,s,i,r)}deleteValue(t,...e){return this.#Mt(t,...e)}deleteValueByIndex(t,...e){return this.#Ot(t,...e)}add(t,e){return this.#Nt(t,e)}getById(t){return this.#Rt(kContact,t)}getByEmail(t){return this.#Ut(kContact,"email",t)}getByIndex(t,e,s){return this.#Ut(t,e,s)}#Ct(){const t=this.name,e=this.version;return new Promise(((s,i)=>{const r=indexedDB.open(t,e);r.onerror=t=>{console.error(`Database error: ${t.target.errorCode}`),i(t.target.errorCode)},r.onsuccess=t=>{const e=t.target.result;s(e)},r.onupgradeneeded=t=>{const e=t.target.result,s=t.target.transaction,i=t.oldVersion;this.onUpgrade(e,s,i),this.needSetup(i)&&(this.#St=!0)}}))}#Bt(t,e,s,i=0,r=50,o=!1){return new Promise(((h,n)=>{const a=this.db.transaction(t,"readonly").objectStore(t),l=s?IDBKeyRange.only(s):IDBKeyRange.lowerBound(0),c=a.index(e).openCursor(l,o?"prev":"next");let d=0==i,u=0;const g=[];c.onsuccess=t=>{const e=t.target.result;if(e)if(d){const t=e.value;g.push(t),u++,u<r?e.continue():h(g)}else d=!0,e.advance(i);else h(g)},c.onerror=t=>{n(t)}}))}addOne(t,e){return new Promise(((s,i)=>{let r=this.db.transaction(t,"readwrite").objectStore(t).add(e);r.onsuccess=s,r.onerror=i}))}#At(t,e){return new Promise(((s,i)=>{const r=this.db.transaction(t,"readwrite").objectStore(t);let o=e?r.delete(e):r.clear();o.onsuccess=function(t){s()},o.onerror=function(t){console.log(t.target.errorCode),i(t.target.errorCode)}}))}#zt(t,e,s){return new Promise(((i,r)=>{const o=this.db.transaction(t,"readwrite").objectStore(t).index(e).openCursor(s);o.onerror=i,o.onsuccess=t=>{const e=t.target.result;e?(e.delete(),e.continue()):i()}}))}#Nt(t,e){const s=this.db.transaction(t,"readwrite").objectStore(t);Array.isArray(e)||(e=[e]),console.log("IndexDB: adding new entries =>",t,"\n",e.map((t=>t.id)));const i=[];for(const t of e)i.push(new Promise(((e,i)=>{let r=s.add(t);r.onsuccess=function(t){e()},r.onerror=i})));return Promise.all(i)}#Dt(t,e,s,i={}){return new Promise(((r,o)=>{const h=this.db.transaction(t,"readwrite").objectStore(t),n=h.openCursor(IDBKeyRange.only(e));n.onsuccess=t=>{const n=t.target.result;let a;if(n){const t=Object.assign(n.value,s);Object.deleteUndefined(t),a=n.update(t)}else{const t={id:e,...i,...s};a=h.add(t)}a.onsuccess=function(t){r()},a.onerror=o},n.onerror=o}))}#Et(t,e,s,i,r={}){return new Promise(((o,h)=>{const n=this.db.transaction(t,"readwrite").objectStore(t),a=n.index(e).openCursor(s);a.onsuccess=t=>{const e=t.target.result;let s;if(e){const t=Object.assign(e.value,i);Object.deleteUndefined(t),s=e.update(t)}else{const t={...r,...i};s=n.add(t)}s.onsuccess=function(t){o()},s.onerror=h},a.onerror=h}))}#Wt(t,e,s,i){return new Promise(((r,o)=>{const h=this.db.transaction(t,"readwrite").objectStore(t).openCursor(IDBKeyRange.only(e));Y(s,i,h,r,o)}))}#Ft(t,e,s,i,r){return new Promise(((o,h)=>{const n=this.db.transaction(t,"readwrite").objectStore(t).index(e).openCursor(s);Y(i,r,n,o,h)}))}#Mt(t,e,s,i){return new Promise(((r,o)=>{const h=this.db.transaction(t,"readwrite").objectStore(t).openCursor(IDBKeyRange.only(e));G(s,i,h,r,o)}))}#Ot(t,e,s,i,r){return new Promise(((o,h)=>{const n=this.db.transaction(t,"readwrite").objectStore(t).index(e).openCursor(s);G(i,r,n,o,h)}))}#_t(t,e,s,i){return new Promise(((r,o)=>{const h=this.db.transaction(t,"readwrite").objectStore(t).openCursor(IDBKeyRange.only(e));h.onsuccess=t=>{const e=t.target.result;let h;if(!e)return o("Appending to non-existing record");const n=e.value;n[s]?n[s].push(i):n[s]=[i],n.ts&&(n.ts=Date.seconds()),h=e.update(n),h.onsuccess=function(t){console.log(t),r()},h.onerror=function(t){console.log(t.target.errorCode),o(t.target.errorCode)}},h.onerror=o}))}#Rt(t,e){return new Promise(((s,i)=>{let r=this.db.transaction(t,"readonly").objectStore(t).get(e);r.onsuccess=t=>{t.target.result?s(t.target.result):s(null)},r.onerror=i}))}#Ut(t,e,s){return new Promise(((i,r)=>{let o=this.db.transaction(t,"readonly").objectStore(t).index(e).get(s);o.onsuccess=t=>{i(o.result)},o.onerror=r}))}#Tt(t,e,s,i){return new Promise(((s,r)=>{const o=this.db.transaction(t,"readonly").objectStore(t),h=[],n=o.openCursor(null,e?"prev":"next");let a=0;n.onsuccess=t=>{let e=t.target.result;if(e){let t=e.value;h.push(t),++a<i?e.continue():s(h)}else s(h)},n.onerror=r}))}#It(t,e,s=0,i=50,r=!1){return new Promise(((o,h)=>{const n=this.db.transaction(t,"readonly").objectStore(t),a=IDBKeyRange.lowerBound(0),l=n.index(e).openCursor(a,r?"prev":"next");let c=0==s,d=0;const u=[];l.onsuccess=t=>{const e=t.target.result;if(e)if(c){const t=e.value;u.push(t),d++,d<i?e.continue():o(u)}else c=!0,e.advance(s);else o(u)},l.onerror=h}))}#Pt(t,e,s,i,r=!1,o=50){return new Promise(((h,n)=>{const a=this.db.transaction(t,"readonly").objectStore(t);let l;l=s?i?IDBKeyRange.bound(s,i,!1,!0):IDBKeyRange.lowerBound(s):IDBKeyRange.upperBound(i,!0);const c=a.index(e).openCursor(l,r?"prev":"next"),d=[];let u=0;c.onsuccess=t=>{let e=t.target.result;if(e){let t=e.value;d.push(t),++u<o?e.continue():h(d)}else h(d)},c.onerror=n}))}#jt(t){return new Promise(((e,s)=>{const i=this.db.transaction(t,"readonly").objectStore(t).count();i.onsuccess=t=>{const s=t.target.result;e(s)},i.onerror=s}))}#$t(t){return new Promise(((e,s)=>{const i=this.db.transaction(t,"readonly").objectStore(t).clear();i.onsuccess=()=>e(),i.onerror=s}))}delete(t,e,s,i){return new Promise(((r,o)=>{const h=this.db.transaction(t,"readwrite").objectStore(t);let n,a;e?(n=s==i?IDBKeyRange.only(s):s?i?IDBKeyRange.bound(s,i,!1,!0):IDBKeyRange.lowerBound(s):IDBKeyRange.upperBound(i,!0),a=h.index(e).openCursor(n)):a=h.openCursor(),a.onsuccess=t=>{let e=t.target.result;e?(e.delete(),e.continue()):r()},a.onerror=o}))}static put(t,e,s){const i=t.transaction(e,"readwrite").objectStore(e);Array.isArray(s)||(s=[s]);const r=[];for(const t of s)r.push(new Promise(((e,s)=>{let r=i.put(t);r.onsuccess=function(t){e()},r.onerror=s})));return Promise.all(r)}static addTable=H;static addIndex=q;static deleteTable=V;static deleteIndex=K}function Y(t,e,s,i,r){s.onsuccess=s=>{const o=s.target.result;let h;if(o){const s=o.value;s[t]||(s[t]=[]),Array.isArray(e)?s[t].push(...e):s[t].push(e),h=o.update(s),h.onsuccess=i,h.onerror=r}else i()},s.onerror=r}function G(t,e,s,i,r){s.onsuccess=s=>{const o=s.target.result;let h;if(o){const s=o.value,n=s[t];Array.isArray(n)&&e?s[t]=n.filter((t=>t!=e)):delete s[t],h=o.update(s),h.onsuccess=function(t){i()},h.onerror=r}else i()},s.onerror=r}function H(t,e,s=!1,i="id"){const r={keyPath:i,autoIncrement:s};t.createObjectStore(e,r)}function V(t,e){t.deleteObjectStore(e)}function q(t,e,s,i=!1,r=e){s.objectStore(t).createIndex(r,e,{unique:i})}function K(t,e,s){s.objectStore(t).deleteIndex(e)}const Z=function(){function t(t,e,s,i,r){this.gl=t,this.id=t.createTexture(),this.width=e,this.height=s,this.format=i,this.type=r,t.bindTexture(t.TEXTURE_2D,this.id),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e&&s&&t.texImage2D(t.TEXTURE_2D,0,this.format,e,s,0,this.format,this.type,null)}t.fromElement=function(e,s){var i=new t(e,0,0,e.RGBA,e.UNSIGNED_BYTE);return i.loadContentsOf(s),i},t.prototype.loadContentsOf=function(t){this.width=t.width||t.videoWidth,this.height=t.height||t.videoHeight,this.gl.bindTexture(this.gl.TEXTURE_2D,this.id),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.format,this.format,this.type,t)},t.prototype.initFromBytes=function(t,e,s){this.width=t,this.height=e,this.format=this.gl.RGBA,this.type=this.gl.UNSIGNED_BYTE,this.gl.bindTexture(this.gl.TEXTURE_2D,this.id),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,e,0,this.gl.RGBA,this.type,new Uint8Array(s))},t.prototype.destroy=function(){this.gl.deleteTexture(this.id),this.id=null},t.prototype.use=function(t){this.gl.activeTexture(this.gl.TEXTURE0+(t||0)),this.gl.bindTexture(this.gl.TEXTURE_2D,this.id)},t.prototype.unuse=function(t){this.gl.activeTexture(this.gl.TEXTURE0+(t||0)),this.gl.bindTexture(this.gl.TEXTURE_2D,null)},t.prototype.ensureFormat=function(t,e,s,i){if(1==arguments.length){var r=arguments[0];t=r.width,e=r.height,s=r.format,i=r.type}t==this.width&&e==this.height&&s==this.format&&i==this.type||(this.width=t,this.height=e,this.format=s,this.type=i,this.gl.bindTexture(this.gl.TEXTURE_2D,this.id),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.format,t,e,0,this.format,this.type,null))},t.prototype.drawTo=function(t){if(this.gl.framebuffer=this.gl.framebuffer||this.gl.createFramebuffer(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.gl.framebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.id,0),this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!==this.gl.FRAMEBUFFER_COMPLETE)throw new Error("incomplete framebuffer");this.gl.viewport(0,0,this.width,this.height),t(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};var e=null;function s(t){null==e&&(e=document.createElement("canvas")),e.width=t.width,e.height=t.height;var s=e.getContext("2d");return s.clearRect(0,0,e.width,e.height),s}return t.prototype.fillUsingCanvas=function(t){return t(s(this)),this.format=this.gl.RGBA,this.type=this.gl.UNSIGNED_BYTE,this.gl.bindTexture(this.gl.TEXTURE_2D,this.id),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this},t.prototype.toImage=function(t){this.use(),Shader.getDefaultShader().drawRect();var i=this.width*this.height*4,r=new Uint8Array(i),o=s(this),h=o.createImageData(this.width,this.height);this.gl.readPixels(0,0,this.width,this.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,r);for(var n=0;n<i;n++)h.data[n]=r[n];o.putImageData(h,0,0),t.src=e.toDataURL()},t.prototype.swapWith=function(t){var e;e=t.id,t.id=this.id,this.id=e,e=t.width,t.width=this.width,this.width=e,e=t.height,t.height=this.height,this.height=e,e=t.format,t.format=this.format,this.format=e},t}(),J=function(){function t(t){return"[object Number]"==Object.prototype.toString.call(t)}function e(t,e,s){var i=t.createShader(e);if(t.shaderSource(i,s),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw"compile error: "+t.getShaderInfoLog(i);return i}function s(t,s,i){if(this.vertexAttribute=null,this.texCoordAttribute=null,this.program=t.createProgram(),s=s||"\tattribute vec2 vertex;\tattribute vec2 _texCoord;\tvarying vec2 texCoord;\tvoid main() {\t\ttexCoord = _texCoord;\t\tgl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);\t}",i="precision highp float;"+(i=i||"\tuniform sampler2D texture;\tvarying vec2 texCoord;\tvoid main() {\t\tgl_FragColor = texture2D(texture, texCoord);\t}"),t.attachShader(this.program,e(t,t.VERTEX_SHADER,s)),t.attachShader(this.program,e(t,t.FRAGMENT_SHADER,i)),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))throw"link error: "+t.getProgramInfoLog(this.program);this.gl=t}return s.prototype.destroy=function(){this.gl.deleteProgram(this.program),this.program=null},s.prototype.uniforms=function(e){for(var s in this.gl.useProgram(this.program),e)if(e.hasOwnProperty(s)){var i=this.gl.getUniformLocation(this.program,s);if(null!==i){var r=e[s];if(o=r,"[object Array]"==Object.prototype.toString.call(o))switch(r.length){case 1:this.gl.uniform1fv(i,new Float32Array(r));break;case 2:this.gl.uniform2fv(i,new Float32Array(r));break;case 3:this.gl.uniform3fv(i,new Float32Array(r));break;case 4:this.gl.uniform4fv(i,new Float32Array(r));break;case 9:this.gl.uniformMatrix3fv(i,!1,new Float32Array(r));break;case 16:this.gl.uniformMatrix4fv(i,!1,new Float32Array(r));break;default:throw"dont't know how to load uniform \""+s+'" of length '+r.length}else{if(!t(r))throw'attempted to set uniform "'+s+'" to invalid value '+(r||"undefined").toString();this.gl.uniform1f(i,r)}}}var o;return this},s.prototype.textures=function(t){for(var e in this.gl.useProgram(this.program),t)t.hasOwnProperty(e)&&this.gl.uniform1i(this.gl.getUniformLocation(this.program,e),t[e]);return this},s.prototype.drawRect=function(t,e,s,i){var r,o=this.gl.getParameter(this.gl.VIEWPORT);e=e!==r?(e-o[1])/o[3]:0,t=t!==r?(t-o[0])/o[2]:0,s=s!==r?(s-o[0])/o[2]:1,i=i!==r?(i-o[1])/o[3]:1,null==this.gl.vertexBuffer&&(this.gl.vertexBuffer=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([t,e,t,i,s,e,s,i]),this.gl.STATIC_DRAW),null==this.gl.texCoordBuffer&&(this.gl.texCoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl.texCoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),this.gl.STATIC_DRAW)),null==this.vertexAttribute&&(this.vertexAttribute=this.gl.getAttribLocation(this.program,"vertex"),this.gl.enableVertexAttribArray(this.vertexAttribute)),null==this.texCoordAttribute&&(this.texCoordAttribute=this.gl.getAttribLocation(this.program,"_texCoord"),this.gl.enableVertexAttribArray(this.texCoordAttribute)),this.gl.useProgram(this.program),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl.vertexBuffer),this.gl.vertexAttribPointer(this.vertexAttribute,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl.texCoordBuffer),this.gl.vertexAttribPointer(this.texCoordAttribute,2,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)},s.getDefaultShader=function(t){return t.defaultShader=t.defaultShader||new s(t),t.defaultShader},s}();function Q(t,e,s){return new J(t,null,e+"\tuniform sampler2D texture;\tuniform vec2 texSize;\tvarying vec2 texCoord;\tvoid main() {\t\tvec2 coord = texCoord * texSize;\t\t"+s+"\t\tgl_FragColor = texture2D(texture, coord / texSize);\t\tvec2 clampedCoord = clamp(coord, vec2(0.0), texSize);\t\tif (coord != clampedCoord) {\t\t\t/* fade to transparent if we are outside the image */\t\t\tgl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));\t\t}\t}")}const tt="\tfloat random(vec3 scale, float seed) {\t\t/* use the fragment position for a different seed per-pixel */\t\treturn fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);\t}";function et(t,e,s){return Math.max(t,Math.min(e,s))}function st(t,e){const s=this._.gl,i=this.simpleShader;return s.brightnessContrast=s.brightnessContrast||new J(s,null,"\t\tuniform sampler2D texture;\t\tuniform float brightness;\t\tuniform float contrast;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tcolor.rgb += brightness;\t\t\tif (contrast > 0.0) {\t\t\t\tcolor.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;\t\t\t} else {\t\t\t\tcolor.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;\t\t\t}\t\t\tgl_FragColor = color;\t\t}\t"),i.call(this,s.brightnessContrast,{brightness:et(-1,t,1),contrast:et(-1,e,1)}),this}function it(t,e,s){return gl.hexagonalPixelate=gl.hexagonalPixelate||new J(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 center;\t\tuniform float scale;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec2 tex = (texCoord * texSize - center) / scale;\t\t\ttex.y /= 0.866025404;\t\t\ttex.x -= tex.y * 0.5;\t\t\t\t\t\tvec2 a;\t\t\tif (tex.x + tex.y - floor(tex.x) - floor(tex.y) < 1.0) a = vec2(floor(tex.x), floor(tex.y));\t\t\telse a = vec2(ceil(tex.x), ceil(tex.y));\t\t\tvec2 b = vec2(ceil(tex.x), floor(tex.y));\t\t\tvec2 c = vec2(floor(tex.x), ceil(tex.y));\t\t\t\t\t\tvec3 TEX = vec3(tex.x, tex.y, 1.0 - tex.x - tex.y);\t\t\tvec3 A = vec3(a.x, a.y, 1.0 - a.x - a.y);\t\t\tvec3 B = vec3(b.x, b.y, 1.0 - b.x - b.y);\t\t\tvec3 C = vec3(c.x, c.y, 1.0 - c.x - c.y);\t\t\t\t\t\tfloat alen = length(TEX - A);\t\t\tfloat blen = length(TEX - B);\t\t\tfloat clen = length(TEX - C);\t\t\t\t\t\tvec2 choice;\t\t\tif (alen < blen) {\t\t\t\tif (alen < clen) choice = a;\t\t\t\telse choice = c;\t\t\t} else {\t\t\t\tif (blen < clen) choice = b;\t\t\t\telse choice = c;\t\t\t}\t\t\t\t\t\tchoice.x += choice.y * 0.5;\t\t\tchoice.y *= 0.866025404;\t\t\tchoice *= scale / texSize;\t\t\tgl_FragColor = texture2D(texture, choice + center / texSize);\t\t}\t"),simpleShader.call(this,gl.hexagonalPixelate,{center:[t,e],scale:s,texSize:[this.width,this.height]}),this}function rt(t,e){const s=this._.gl,i=this.simpleShader;return s.hueSaturation=s.hueSaturation||new J(s,null,"\t\tuniform sampler2D texture;\t\tuniform float hue;\t\tuniform float saturation;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\t\t\t\t/* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */\t\t\tfloat angle = hue * 3.14159265;\t\t\tfloat s = sin(angle), c = cos(angle);\t\t\tvec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;\t\t\tfloat len = length(color.rgb);\t\t\tcolor.rgb = vec3(\t\t\t\tdot(color.rgb, weights.xyz),\t\t\t\tdot(color.rgb, weights.zxy),\t\t\t\tdot(color.rgb, weights.yzx)\t\t\t);\t\t\t\t\t\t/* saturation adjustment */\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\t\t\tif (saturation > 0.0) {\t\t\t\tcolor.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));\t\t\t} else {\t\t\t\tcolor.rgb += (average - color.rgb) * (-saturation);\t\t\t}\t\t\t\t\t\tgl_FragColor = color;\t\t}\t"),i.call(this,s.hueSaturation,{hue:et(-1,t,1),saturation:et(-1,e,1)}),this}function ot(t,e,s,i){return gl.colorHalftone=gl.colorHalftone||new J(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 center;\t\tuniform float angle;\t\tuniform float scale;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\t\t\tfloat pattern(float angle) {\t\t\tfloat s = sin(angle), c = cos(angle);\t\t\tvec2 tex = texCoord * texSize - center;\t\t\tvec2 point = vec2(\t\t\t\tc * tex.x - s * tex.y,\t\t\t\ts * tex.x + c * tex.y\t\t\t) * scale;\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\t\t}\t\t\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tvec3 cmy = 1.0 - color.rgb;\t\t\tfloat k = min(cmy.x, min(cmy.y, cmy.z));\t\t\tcmy = (cmy - k) / (1.0 - k);\t\t\tcmy = clamp(cmy * 10.0 - 3.0 + vec3(pattern(angle + 0.26179), pattern(angle + 1.30899), pattern(angle)), 0.0, 1.0);\t\t\tk = clamp(k * 10.0 - 5.0 + pattern(angle + 0.78539), 0.0, 1.0);\t\t\tgl_FragColor = vec4(1.0 - cmy - k, color.a);\t\t}\t"),simpleShader.call(this,gl.colorHalftone,{center:[t,e],angle:s,scale:Math.PI/i,texSize:[this.width,this.height]}),this}function ht(t){const e=this._.gl;return e.triangleBlur=e.triangleBlur||new J(e,null,"\t\tuniform sampler2D texture;\t\tuniform vec2 delta;\t\tvarying vec2 texCoord;\t\t"+tt+"\t\tvoid main() {\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tfor (float t = -30.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset - 0.5) / 30.0;\t\t\t\tfloat weight = 1.0 - abs(percent);\t\t\t\tvec4 sample = texture2D(texture, texCoord + delta * percent);\t\t\t\t\t\t\t\t/* switch to pre-multiplied alpha to correctly blur transparent images */\t\t\t\tsample.rgb *= sample.a;\t\t\t\t\t\t\t\tcolor += sample * weight;\t\t\t\ttotal += weight;\t\t\t}\t\t\t\t\t\tgl_FragColor = color / total;\t\t\t\t\t\t/* switch back from pre-multiplied alpha */\t\t\tgl_FragColor.rgb /= gl_FragColor.a + 0.00001;\t\t}\t"),this.simpleShader.call(this,e.triangleBlur,{delta:[t/this.width,0]}),this.simpleShader.call(this,e.triangleBlur,{delta:[0,t/this.height]}),this}function nt(t,e){const s=this._.gl,i=this.simpleShader;return s.unsharpMask=s.unsharpMask||new J(s,null,"\t\tuniform sampler2D blurredTexture;\t\tuniform sampler2D originalTexture;\t\tuniform float strength;\t\tuniform float threshold;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 blurred = texture2D(blurredTexture, texCoord);\t\t\tvec4 original = texture2D(originalTexture, texCoord);\t\t\tgl_FragColor = mix(blurred, original, 1.0 + strength);\t\t}\t"),this._.extraTexture.ensureFormat(this._.texture),this._.texture.use(),this._.extraTexture.drawTo((function(){J.getDefaultShader(s).drawRect()})),this._.extraTexture.use(1),this.triangleBlur(t),s.unsharpMask.textures({originalTexture:1}),i.call(this,s.unsharpMask,{strength:e}),this._.extraTexture.unuse(1),this}function at(t,e,s,i,r,o,h,n){var a=s-r,l=i-o,c=h-r,d=n-o,u=t-s+r-h,g=e-i+o-n,p=a*d-c*l,m=(u*d-c*g)/p,f=(a*g-u*l)/p;return[s-t+m*s,i-e+m*i,m,h-t+f*h,n-e+f*n,f,t,e,1]}function lt(t,e){var s=at.apply(null,e),i=at.apply(null,t),r=function(t,e){return[t[0]*e[0]+t[1]*e[3]+t[2]*e[6],t[0]*e[1]+t[1]*e[4]+t[2]*e[7],t[0]*e[2]+t[1]*e[5]+t[2]*e[8],t[3]*e[0]+t[4]*e[3]+t[5]*e[6],t[3]*e[1]+t[4]*e[4]+t[5]*e[7],t[3]*e[2]+t[4]*e[5]+t[5]*e[8],t[6]*e[0]+t[7]*e[3]+t[8]*e[6],t[6]*e[1]+t[7]*e[4]+t[8]*e[7],t[6]*e[2]+t[7]*e[5]+t[8]*e[8]]}(function(t){var e=t[0],s=t[1],i=t[2],r=t[3],o=t[4],h=t[5],n=t[6],a=t[7],l=t[8],c=e*o*l-e*h*a-s*r*l+s*h*n+i*r*a-i*o*n;return[(o*l-h*a)/c,(i*a-s*l)/c,(s*h-i*o)/c,(h*n-r*l)/c,(e*l-i*n)/c,(i*r-e*h)/c,(r*a-o*n)/c,(s*n-e*a)/c,(e*o-s*r)/c]}(s),i);return this.matrixWarp(r)}function ct(t,e,s){if(gl.matrixWarp=gl.matrixWarp||Q("\t\tuniform mat3 matrix;\t\tuniform bool useTextureSpace;\t","\t\tif (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;\t\tvec3 warp = matrix * vec3(coord, 1.0);\t\tcoord = warp.xy / warp.z;\t\tif (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;\t"),4==(t=Array.prototype.concat.apply([],t)).length)t=[t[0],t[1],0,t[2],t[3],0,0,0,1];else if(9!=t.length)throw"can only warp with 2x2 or 3x3 matrix";return simpleShader.call(this,gl.matrixWarp,{matrix:e?getInverse(t):t,texSize:[this.width,this.height],useTextureSpace:0|s}),this}function dt(t,e,s,i){const r=this._.gl,o=this.simpleShader;return r.bulgePinch=r.bulgePinch||Q(r,"\t\tuniform float radius;\t\tuniform float strength;\t\tuniform vec2 center;\t","\t\tcoord -= center;\t\tfloat distance = length(coord);\t\tif (distance < radius) {\t\t\tfloat percent = distance / radius;\t\t\tif (strength > 0.0) {\t\t\t\tcoord *= mix(1.0, smoothstep(0.0, radius / distance, percent), strength * 0.75);\t\t\t} else {\t\t\t\tcoord *= mix(1.0, pow(percent, 1.0 + strength * 0.75) * radius / distance, 1.0 - percent);\t\t\t}\t\t}\t\tcoord += center;\t"),o.call(this,r.bulgePinch,{radius:s,strength:clamp(-1,i,1),center:[t,e],texSize:[this.width,this.height]}),this}function ut(t,e,s,i,r,o){gl.tiltShift=gl.tiltShift||new J(null,"\t\tuniform sampler2D texture;\t\tuniform float blurRadius;\t\tuniform float gradientRadius;\t\tuniform vec2 start;\t\tuniform vec2 end;\t\tuniform vec2 delta;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\t"+randomShaderFunc+"\t\tvoid main() {\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tvec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));\t\t\tfloat radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;\t\t\tfor (float t = -30.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset - 0.5) / 30.0;\t\t\t\tfloat weight = 1.0 - abs(percent);\t\t\t\tvec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);\t\t\t\t\t\t\t\t/* switch to pre-multiplied alpha to correctly blur transparent images */\t\t\t\tsample.rgb *= sample.a;\t\t\t\t\t\t\t\tcolor += sample * weight;\t\t\t\ttotal += weight;\t\t\t}\t\t\t\t\t\tgl_FragColor = color / total;\t\t\t\t\t\t/* switch back from pre-multiplied alpha */\t\t\tgl_FragColor.rgb /= gl_FragColor.a + 0.00001;\t\t}\t");var h=s-t,n=i-e,a=Math.sqrt(h*h+n*n);return simpleShader.call(this,gl.tiltShift,{blurRadius:r,gradientRadius:o,start:[t,e],end:[s,i],delta:[h/a,n/a],texSize:[this.width,this.height]}),simpleShader.call(this,gl.tiltShift,{blurRadius:r,gradientRadius:o,start:[t,e],end:[s,i],delta:[-n/a,h/a],texSize:[this.width,this.height]}),this}function gt(t,e,s,i){return gl.dotScreen=gl.dotScreen||new J(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 center;\t\tuniform float angle;\t\tuniform float scale;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\t\t\tfloat pattern() {\t\t\tfloat s = sin(angle), c = cos(angle);\t\t\tvec2 tex = texCoord * texSize - center;\t\t\tvec2 point = vec2(\t\t\t\tc * tex.x - s * tex.y,\t\t\t\ts * tex.x + c * tex.y\t\t\t) * scale;\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\t\t}\t\t\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\t\t\tgl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);\t\t}\t"),simpleShader.call(this,gl.dotScreen,{center:[t,e],angle:s,scale:Math.PI/i,texSize:[this.width,this.height]}),this}function pt(t){return gl.edgeWork1=gl.edgeWork1||new J(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 delta;\t\tvarying vec2 texCoord;\t\t"+randomShaderFunc+"\t\tvoid main() {\t\t\tvec2 color = vec2(0.0);\t\t\tvec2 total = vec2(0.0);\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tfor (float t = -30.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset - 0.5) / 30.0;\t\t\t\tfloat weight = 1.0 - abs(percent);\t\t\t\tvec3 sample = texture2D(texture, texCoord + delta * percent).rgb;\t\t\t\tfloat average = (sample.r + sample.g + sample.b) / 3.0;\t\t\t\tcolor.x += average * weight;\t\t\t\ttotal.x += weight;\t\t\t\tif (abs(t) < 15.0) {\t\t\t\t\tweight = weight * 2.0 - 1.0;\t\t\t\t\tcolor.y += average * weight;\t\t\t\t\ttotal.y += weight;\t\t\t\t}\t\t\t}\t\t\tgl_FragColor = vec4(color / total, 0.0, 1.0);\t\t}\t"),gl.edgeWork2=gl.edgeWork2||new J(null,"\t\tuniform sampler2D texture;\t\tuniform vec2 delta;\t\tvarying vec2 texCoord;\t\t"+randomShaderFunc+"\t\tvoid main() {\t\t\tvec2 color = vec2(0.0);\t\t\tvec2 total = vec2(0.0);\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tfor (float t = -30.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset - 0.5) / 30.0;\t\t\t\tfloat weight = 1.0 - abs(percent);\t\t\t\tvec2 sample = texture2D(texture, texCoord + delta * percent).xy;\t\t\t\tcolor.x += sample.x * weight;\t\t\t\ttotal.x += weight;\t\t\t\tif (abs(t) < 15.0) {\t\t\t\t\tweight = weight * 2.0 - 1.0;\t\t\t\t\tcolor.y += sample.y * weight;\t\t\t\t\ttotal.y += weight;\t\t\t\t}\t\t\t}\t\t\tfloat c = clamp(10000.0 * (color.y / total.y - color.x / total.x) + 0.5, 0.0, 1.0);\t\t\tgl_FragColor = vec4(c, c, c, 1.0);\t\t}\t"),simpleShader.call(this,gl.edgeWork1,{delta:[t/this.width,0]}),simpleShader.call(this,gl.edgeWork2,{delta:[0,t/this.height]}),this}function mt(t,e,s){const i=this._.gl,r=this.simpleShader;i.lensBlurPrePass=i.lensBlurPrePass||new J(i,null,"\t\tuniform sampler2D texture;\t\tuniform float power;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tcolor = pow(color, vec4(power));\t\t\tgl_FragColor = vec4(color);\t\t}\t");var o="\t\tuniform sampler2D texture0;\t\tuniform sampler2D texture1;\t\tuniform vec2 delta0;\t\tuniform vec2 delta1;\t\tuniform float power;\t\tvarying vec2 texCoord;\t\t"+tt+"\t\tvec4 sample(vec2 delta) {\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(delta, 151.7182), 0.0);\t\t\t\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\tfor (float t = 0.0; t <= 30.0; t++) {\t\t\t\tfloat percent = (t + offset) / 30.0;\t\t\t\tcolor += texture2D(texture0, texCoord + delta * percent);\t\t\t\ttotal += 1.0;\t\t\t}\t\t\treturn color / total;\t\t}\t";i.lensBlur0=i.lensBlur0||new J(i,null,o+"\t\tvoid main() {\t\t\tgl_FragColor = sample(delta0);\t\t}\t"),i.lensBlur1=i.lensBlur1||new J(i,null,o+"\t\tvoid main() {\t\t\tgl_FragColor = (sample(delta0) + sample(delta1)) * 0.5;\t\t}\t"),i.lensBlur2=i.lensBlur2||new J(i,null,o+"\t\tvoid main() {\t\t\tvec4 color = (sample(delta0) + 2.0 * texture2D(texture1, texCoord)) / 3.0;\t\t\tgl_FragColor = pow(color, vec4(power));\t\t}\t").textures({texture1:1});for(var h=[],n=0;n<3;n++){var a=s+n*Math.PI*2/3;h.push([t*Math.sin(a)/this.width,t*Math.cos(a)/this.height])}var l=Math.pow(10,et(-1,e,1));return r.call(this,i.lensBlurPrePass,{power:l}),this._.extraTexture.ensureFormat(this._.texture),r.call(this,i.lensBlur0,{delta0:h[0]},this._.texture,this._.extraTexture),r.call(this,i.lensBlur1,{delta0:h[1],delta1:h[2]},this._.extraTexture,this._.extraTexture),r.call(this,i.lensBlur0,{delta0:h[1]}),this._.extraTexture.use(1),r.call(this,i.lensBlur2,{power:1/l,delta0:h[2]}),this}function ft(t,e,s){const i=this._.gl;return i.zoomBlur=i.zoomBlur||new J(i,null,"\t\tuniform sampler2D texture;\t\tuniform vec2 center;\t\tuniform float strength;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\t"+tt+"\t\tvoid main() {\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\tvec2 toCenter = center - texCoord * texSize;\t\t\t\t\t\t/* randomize the lookup values to hide the fixed number of samples */\t\t\tfloat offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\t\t\t\t\t\tfor (float t = 0.0; t <= 40.0; t++) {\t\t\t\tfloat percent = (t + offset) / 40.0;\t\t\t\tfloat weight = 4.0 * (percent - percent * percent);\t\t\t\tvec4 sample = texture2D(texture, texCoord + toCenter * percent * strength / texSize);\t\t\t\t\t\t\t\t/* switch to pre-multiplied alpha to correctly blur transparent images */\t\t\t\tsample.rgb *= sample.a;\t\t\t\t\t\t\t\tcolor += sample * weight;\t\t\t\ttotal += weight;\t\t\t}\t\t\t\t\t\tgl_FragColor = color / total;\t\t\t\t\t\t/* switch back from pre-multiplied alpha */\t\t\tgl_FragColor.rgb /= gl_FragColor.a + 0.00001;\t\t}\t"),this.simpleShader.call(this,i.zoomBlur,{center:[t,e],strength:s,texSize:[this.width,this.height]}),this}function xt(t){const e=this._.gl,s=this.simpleShader;return e.noise=e.noise||new J(e,null,"\t\tuniform sampler2D texture;\t\tuniform float amount;\t\tvarying vec2 texCoord;\t\tfloat rand(vec2 co) {\t\t\treturn fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\t\t}\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\t\t\t\tfloat diff = (rand(texCoord) - 0.5) * amount;\t\t\tcolor.r += diff;\t\t\tcolor.g += diff;\t\t\tcolor.b += diff;\t\t\t\t\t\tgl_FragColor = color;\t\t}\t"),s.call(this,e.noise,{amount:et(0,t,1)}),this}function wt(t){const e=this._.gl,s=this.simpleShader;e.denoise=e.denoise||new J(e,null,"\t\tuniform sampler2D texture;\t\tuniform float exponent;\t\tuniform float strength;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 center = texture2D(texture, texCoord);\t\t\tvec4 color = vec4(0.0);\t\t\tfloat total = 0.0;\t\t\tfor (float x = -4.0; x <= 4.0; x += 1.0) {\t\t\t\tfor (float y = -4.0; y <= 4.0; y += 1.0) {\t\t\t\t\tvec4 sample = texture2D(texture, texCoord + vec2(x, y) / texSize);\t\t\t\t\tfloat weight = 1.0 - abs(dot(sample.rgb - center.rgb, vec3(0.25)));\t\t\t\t\tweight = pow(weight, exponent);\t\t\t\t\tcolor += sample * weight;\t\t\t\t\ttotal += weight;\t\t\t\t}\t\t\t}\t\t\tgl_FragColor = color / total;\t\t}\t");for(var i=0;i<2;i++)s.call(this,e.denoise,{exponent:Math.max(0,t),texSize:[this.width,this.height]});return this}function yt(t){for(var e=new SplineInterpolator(t),s=[],i=0;i<256;i++)s.push(clamp(0,Math.floor(256*e.interpolate(i/255)),255));return s}function bt(t,e,s){t=yt(t),1==arguments.length?e=s=t:(e=yt(e),s=yt(s));for(var i=[],r=0;r<256;r++)i.splice(i.length,0,t[r],e[r],s[r],255);return this._.extraTexture.initFromBytes(256,1,i),this._.extraTexture.use(1),gl.curves=gl.curves||new Shader(null,"\t\tuniform sampler2D texture;\t\tuniform sampler2D map;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tcolor.r = texture2D(map, vec2(color.r)).r;\t\t\tcolor.g = texture2D(map, vec2(color.g)).g;\t\t\tcolor.b = texture2D(map, vec2(color.b)).b;\t\t\tgl_FragColor = color;\t\t}\t"),gl.curves.textures({map:1}),simpleShader.call(this,gl.curves,{}),this}function vt(t,e,s,i){const r=this._.gl,o=this.simpleShader;return r.swirl=r.swirl||Q(r,"\t\tuniform float radius;\t\tuniform float angle;\t\tuniform vec2 center;\t","\t\tcoord -= center;\t\tfloat distance = length(coord);\t\tif (distance < radius) {\t\t\tfloat percent = (radius - distance) / radius;\t\t\tfloat theta = percent * percent * angle;\t\t\tfloat s = sin(theta);\t\t\tfloat c = cos(theta);\t\t\tcoord = vec2(\t\t\t\tcoord.x * c - coord.y * s,\t\t\t\tcoord.x * s + coord.y * c\t\t\t);\t\t}\t\tcoord += center;\t"),o.call(this,r.swirl,{radius:s,center:[t,e],angle:i,texSize:[this.width,this.height]}),this}function kt(t){const e=this._.gl;return e.ink=e.ink||new J(e,null,"\t\tuniform sampler2D texture;\t\tuniform float strength;\t\tuniform vec2 texSize;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec2 dx = vec2(1.0 / texSize.x, 0.0);\t\t\tvec2 dy = vec2(0.0, 1.0 / texSize.y);\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tfloat bigTotal = 0.0;\t\t\tfloat smallTotal = 0.0;\t\t\tvec3 bigAverage = vec3(0.0);\t\t\tvec3 smallAverage = vec3(0.0);\t\t\tfor (float x = -2.0; x <= 2.0; x += 1.0) {\t\t\t\tfor (float y = -2.0; y <= 2.0; y += 1.0) {\t\t\t\t\tvec3 sample = texture2D(texture, texCoord + dx * x + dy * y).rgb;\t\t\t\t\tbigAverage += sample;\t\t\t\t\tbigTotal += 1.0;\t\t\t\t\tif (abs(x) + abs(y) < 2.0) {\t\t\t\t\t\tsmallAverage += sample;\t\t\t\t\t\tsmallTotal += 1.0;\t\t\t\t\t}\t\t\t\t}\t\t\t}\t\t\tvec3 edge = max(vec3(0.0), bigAverage / bigTotal - smallAverage / smallTotal);\t\t\tgl_FragColor = vec4(color.rgb - dot(edge, edge) * strength * 100000.0, color.a);\t\t}\t"),this.simpleShader.call(this,e.ink,{strength:t*t*t*t*t,texSize:[this.width,this.height]}),this}function St(t,e){const s=this._.gl,i=this.simpleShader;return s.vignette=s.vignette||new J(s,null,"\t\tuniform sampler2D texture;\t\tuniform float size;\t\tuniform float amount;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\t\t\t\tfloat dist = distance(texCoord, vec2(0.5, 0.5));\t\t\tcolor.rgb *= smoothstep(0.8, size * 0.799, dist * (amount + size));\t\t\t\t\t\tgl_FragColor = color;\t\t}\t"),i.call(this,s.vignette,{size:et(0,t,1),amount:et(0,e,1)}),this}function Ct(t){const e=this._.gl,s=this.simpleShader;return e.vibrance=e.vibrance||new J(e,null,"\t\tuniform sampler2D texture;\t\tuniform float amount;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\t\t\tfloat mx = max(color.r, max(color.g, color.b));\t\t\tfloat amt = (mx - average) * (-amount * 3.0);\t\t\tcolor.rgb = mix(color.rgb, vec3(mx), amt);\t\t\tgl_FragColor = color;\t\t}\t"),s.call(this,e.vibrance,{amount:et(-1,t,1)}),this}function Tt(t){const e=this._.gl,s=this.simpleShader;return e.sepia=e.sepia||new J(e,null,"\t\tuniform sampler2D texture;\t\tuniform float amount;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tvec4 color = texture2D(texture, texCoord);\t\t\tfloat r = color.r;\t\t\tfloat g = color.g;\t\t\tfloat b = color.b;\t\t\t\t\t\tcolor.r = min(1.0, (r * (1.0 - (0.607 * amount))) + (g * (0.769 * amount)) + (b * (0.189 * amount)));\t\t\tcolor.g = min(1.0, (r * 0.349 * amount) + (g * (1.0 - (0.314 * amount))) + (b * 0.168 * amount));\t\t\tcolor.b = min(1.0, (r * 0.272 * amount) + (g * 0.534 * amount) + (b * (1.0 - (0.869 * amount))));\t\t\t\t\t\tgl_FragColor = color;\t\t}\t"),s.call(this,e.sepia,{amount:et(0,t,1)}),this}var Bt;function It(t){return{_:t,loadContentsOf:function(t){Bt=this._.gl,this._.loadContentsOf(t)},destroy:function(){Bt=this._.gl,this._.destroy()}}}function Pt(t){return It(Z.fromElement(this._.gl,t))}function jt(t,e){var s=Bt.UNSIGNED_BYTE;if(Bt.getExtension("OES_texture_float")&&Bt.getExtension("OES_texture_float_linear")){var i=new Z(Bt,100,100,Bt.RGBA,Bt.FLOAT);try{i.drawTo((function(){s=Bt.FLOAT}))}catch(t){}i.destroy()}this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=t,this.height=e,this._.texture=new Z(Bt,t,e,Bt.RGBA,s),this._.spareTexture=new Z(Bt,t,e,Bt.RGBA,s),this._.extraTexture=this._.extraTexture||new Z(Bt,0,0,Bt.RGBA,s),this._.flippedShader=this._.flippedShader||new J(Bt,null,"\t\tuniform sampler2D texture;\t\tvarying vec2 texCoord;\t\tvoid main() {\t\t\tgl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));\t\t}\t"),this._.isInitialized=!0}function Dt(t,e,s){this._.isInitialized&&t._.width==this.width&&t._.height==this.height||jt.call(this,e||t._.width,s||t._.height);const i=this._.gl;return t._.use(),this._.texture.drawTo((function(){J.getDefaultShader(i).drawRect()})),this}function Et(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function _t(t,e,s,i){(s||this._.texture).use(),this._.spareTexture.drawTo((function(){t.uniforms(e).drawRect()})),this._.spareTexture.swapWith(i||this._.texture)}function Rt(t){return t.parentNode.insertBefore(this,t),t.parentNode.removeChild(t),this}function At(){const t=this._.gl;var e=new Z(t,this._.texture.width,this._.texture.height,t.RGBA,t.UNSIGNED_BYTE);return this._.texture.use(),e.drawTo((function(){J.getDefaultShader(t).drawRect()})),It(e)}function zt(){var t=this._.texture.width,e=this._.texture.height,s=new Uint8Array(t*e*4);return this._.texture.drawTo((function(){Bt.readPixels(0,0,t,e,Bt.RGBA,Bt.UNSIGNED_BYTE,s)})),s}function Wt(t){return function(...e){return t.call(this,...e)}}function Ft(){const t=new OffscreenCanvas(512,512);try{Bt=t.getContext("webgl")||t.getContext("experimental-webgl",{premultipliedAlpha:!1})}catch(t){Bt=null}if(!Bt)throw"This browser does not support WebGL";return t._={gl:Bt,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},t.texture=Pt.bind(t),t.draw=Dt.bind(t),t.update=Et.bind(t),t.replace=Rt.bind(t),t.contents=At.bind(t),t.getPixelArray=zt.bind(t),t.simpleShader=_t.bind(t),t.brightnessContrast=Wt.bind(t)(st),t.hexagonalPixelate=Wt.bind(t)(it),t.hueSaturation=Wt.bind(t)(rt),t.colorHalftone=Wt.bind(t)(ot),t.triangleBlur=Wt.bind(t)(ht),t.unsharpMask=Wt.bind(t)(nt),t.perspective=Wt.bind(t)(lt),t.matrixWarp=Wt.bind(t)(ct),t.bulgePinch=Wt.bind(t)(dt),t.tiltShift=Wt.bind(t)(ut),t.dotScreen=Wt.bind(t)(gt),t.edgeWork=Wt.bind(t)(pt),t.lensBlur=Wt.bind(t)(mt),t.zoomBlur=Wt.bind(t)(ft),t.noise=Wt.bind(t)(xt),t.denoise=Wt.bind(t)(wt),t.curves=Wt.bind(t)(bt),t.swirl=Wt.bind(t)(vt),t.ink=Wt.bind(t)(kt),t.vignette=Wt.bind(t)(St),t.vibrance=Wt.bind(t)(Ct),t.sepia=Wt.bind(t)(Tt),t}class Mt{#Lt=Ft();triangleBlur(t,e=5){const s=this.#Lt,i=s.texture(t);return s.draw(i).triangleBlur(e).update(),s.transferToImageBitmap()}zoomBlur(t,e=.3,s=t.width/2,i=t.height/2){const r=this.#Lt,o=r.texture(t);return r.draw(o).zoomBlur(s,i,e).update(),r.transferToImageBitmap()}lensBlur(t,e,s,i){const r=this.#Lt,o=r.texture(t);return r.draw(o).lensBlur(e,s,i).update(),r.transferToImageBitmap()}ink(t,e=.25){const s=this.#Lt,i=s.texture(t);return s.draw(i).ink(e).update(),s.transferToImageBitmap()}brightnessContrast(t,e=0,s=0){const i=this.#Lt,r=i.texture(t);return i.draw(r).brightnessContrast(e,s).update(),i.transferToImageBitmap()}hueSaturation(t,e=0,s=0){const i=this.#Lt,r=i.texture(t);return i.draw(r).hueSaturation(e,s).update(),i.transferToImageBitmap()}swirl(t,e,s,i=t.width/2,r=t.height/2){const o=this.#Lt,h=o.texture(t);return o.draw(h).swirl(i,r,e,s).update(),o.transferToImageBitmap()}bulgePinch(t,e,s,i=t.width/2,r=t.height/2){const o=this.#Lt,h=o.texture(t);return o.draw(h).bulgePinch(i,r,e,s).update(),o.transferToImageBitmap()}denoise(t,e){const s=this.#Lt,i=s.texture(t);return s.draw(i).denoise(e).update(),s.transferToImageBitmap()}unsharpMask(t,e,s){const i=this.#Lt,r=i.texture(t);return i.draw(r).unsharpMask(e,s).update(),i.transferToImageBitmap()}noise(t,e){const s=this.#Lt,i=s.texture(t);return s.draw(i).noise(e).update(),s.transferToImageBitmap()}sepia(t,e){const s=this.#Lt,i=s.texture(t);return s.draw(i).sepia(e).update(),s.transferToImageBitmap()}vignette(t,e,s){const i=this.#Lt,r=i.texture(t);return i.draw(r).vignette(e,s).update(),i.transferToImageBitmap()}vibrance(t,e){const s=this.#Lt,i=s.texture(t);return s.draw(i).vibrance(e).update(),s.transferToImageBitmap()}}function Ot(t,e={}){Object.assign(e,{set(t,e,s){const i=this[t];if(i)switch(i.tagName){case"INPUT":if("checkbox"==i.type)i.checked=!!e;else{s&&(i.dataset.id=s);const t=i.previousElementSibling,r=!!e;t&&"INPUT"==t.tagName&&"checkbox"==t.type?(i.disabled=!r,r&&(i.value=e),r!=t.checked&&(t.checked=r)):e&&(i.value=e)}break;case"SELECT":{const t=i.previousElementSibling,s=!!e;t&&"INPUT"==t.tagName&&"checkbox"==t.type?(i.disabled=!s,i.value=s?e:i.children[0].value,s!=t.checked&&(t.checked=s,t.dispatchEvent(new Event("change",{bubbles:!0})))):i.value=e}break;default:i.value=e}},assign(t){for(const[e,s]of Object.entries(t))this.set(e,s)}});const s=t.querySelectorAll("input,select,textarea");for(const t of s){const s=t.id||t.getAttribute("role");if(s){const[i,r]=s.split("-");"object"==i&&(e[r]=t)}}return e}const Nt={add(){},select(){},delete(){},clear(){},clearSelection(){},swap(){}},Ut={set(){},assign(){},mode(){}};class $t extends EventTarget{#Xt;#Yt;#Gt;#Ht=[];#Vt=new a;#qt;#p;#Kt=[1,1];#Zt=2;#l="#eeeeee";#n="#111111";#a=1;#Jt="select";#Qt={};#te=!1;#ee;#se=1;#ie=0;#re=0;#r=0;#o=0;#oe;#C;#ut;#he=[];#ne=[];#ae=[];#le=0;#ce={};#de={properties:Ut,objects:Nt,projects:Nt,canvas:Ut,status:Ut,tools:Ut,actions:Ut,notify:Nt};get canvas(){return this.#Xt.canvas}get context(){return this.#Xt}get width(){return this.canvas.width}get height(){return this.canvas.height}set width(t){const e=t>800?t:800,s=this.canvas;s.width=e,s.height=3*e/4,this.#Vt.width=t,this.#Vt.x=(e-t)/2,this.#Vt.height<s.height?this.#Vt.y=(s.height-this.#Vt.height)/2:(this.#Vt.y=0,this.#Vt.height=s.height);const i=s.getBoundingClientRect();this.#ue(i)}set height(t){t>this.canvas.height&&(t=this.canvas.height),this.#Vt.y=(this.canvas.height-t)/2,this.#Vt.height=t,this.#Vt.properties=this.#de.canvas,this.draw()}set fill(t){this.#l=t}set stroke(t){this.#n=t}set strokeWidth(t){this.#a=t}set mode(t){switch(this.#Jt){case"draw":this.#C&&(this.#C=null);break;case"edit":this.#he=[]}this.#Jt=t,"edit"===this.#Jt&&this.#p&&(this.#he=this.#p.getNodes()),this.draw(),this.#de.tools.mode(this.#Jt)}set zoom(t){this.#se=t,this.#ge(),this.draw()}constructor(t){super(),this.#Xt=t.getContext("2d");try{window.glfx||(window.glfx=new Mt),this.#Yt=glfx}catch(t){console.error("Failed to init WbGL")}const e=t.getBoundingClientRect();this.#ue(e),this.#pe(),this.#me(),this.#Vt.width=1200,this.#Vt.height=630,this.width=1200,this.reset()}on(t,e){this.addEventListener(t,e)}async init(t){t||(t=new Yt,await t.init()),this.#ee=t,await this.#fe(),await tf.setBackend("webgl")}reset(){this.#qt&&URL.revokeObjectURL(this.#qt.src),this.#p=null,this.#qt=null,this.#oe=null,this.#ae=[],this.#le=0,this.#C=null,this.#Jt="select",this.#he=[],this.#se=1,this.#ie=0,this.#re=0,this.#Ht=[this.#Vt],this.draw(),this.canvas.focus(),this.#de.projects.clearSelection(),this.#de.objects.clear(),this.#Vt.properties=this.#de.canvas,this.#de.tools.mode("select")}draw(){const t=this.#Xt;t.save(),t.clearRect(0,0,this.canvas.width,this.canvas.height),t.scale(this.#se,this.#se),t.translate(this.#ie,this.#re),this.#qt&&t.drawImage(this.#qt,0,0);for(const e of this.#Ht)e.visible&&e.draw(t,this.#Jt);if(this.#p?.visible&&this.#p.drawSelection(t,this.#Jt),this.#C&&this.#C.draw(t,this.#Jt),"edit"==this.#Jt&&this.#p?.visible)for(const e of this.#he)e.draw(t);t.restore()}add(t="bubble",e=""){let i;switch(t){case"bubble":i=new n;break;case"rect":case"rectext":i=new h;break;case"text":i=new s,i.value="Text";break;case"emoji":i=new A(e);break;case"arrow":i=new L}return i?(this.#Jt="select",i.fill=this.#l,i.stroke=this.#n,i.strokeWidth=this.#a,i.x=50+Math.round(400*Math.random()),i.y=10+Math.round(300*Math.random()),this.#Ht.push(i),this.select(i),this.#xe("newobject",i.id),this.#de.objects.add(i)):console.error("Unknown object type:",t),i}remove(t=this.#p?.id){const e=this.#Ht.findIndex((e=>e.id==t));if(-1!=e){const[s]=this.#Ht.splice(e,1);s.release(),t==this.#p?.id&&(this.#p=null,this.#xe("select",null),this.#de.properties.mode()),this.draw()}}move(t,e){const s=this.#Ht.findIndex((e=>e.id==t));if(-1==s)return;const i=s-e>0?s-e:1;if(s==i)return;const[r]=this.#Ht.splice(s,1);this.#Ht.splice(i,0,r),this.#de.objects.swap(s-1,i-1),this.draw()}applyMask(t){let e=this.#Ht.findIndex((e=>e.id==t));if(e<2)return;const s=this.#Ht[e];for(e--;e>=0;--e){const t=this.#Ht[e];if("image"==t.type)return t.setMask(s),this.#de.properties.set("mask",s.name,s.id),void this.draw()}}export(t="meme",e="jpeg"){const s=document.createElement("canvas"),i=s.getContext("2d"),r=this.#Ht[0];return s.width=r.width,s.height=r.height,i.drawImage(this.canvas,r.x,r.y,r.width,r.height,0,0,r.width,r.height),Xt(i,"www.sipme.io"),this.#we(s,t,e)}exportObject(){if(!this.#p)return;const t=this.#p;t.selected=!1,this.draw();const e=document.createElement("canvas"),s=e.getContext("2d");return e.width=t.width,e.height=t.height,s.drawImage(this.canvas,t.x,t.y,t.width,t.height,0,0,t.width,t.height),t.selected=!0,this.draw(),this.#we(e,t.name,"png")}async import(t){if(!t){const e={types:[{description:"Images",accept:{"image/*":[".png",".webp",".jpeg",".jpg"]}}],excludeAcceptAllOption:!0,multiple:!0},s=await showOpenFilePicker(e);t=await Promise.all(s.map((t=>t.getFile())))}let e;const s=this.#Vt.width,i=this.#Vt.height;for(const r of t)e=new _(this.#Yt),await e.load(r,s,i),e.x=Math.round(Math.random()*(this.width-e.width)),e.y=Math.round(Math.random()*(this.height-e.height)),this.#Ht.push(e),this.#de.objects.add(e);t.length>1?this.alignImages():this.draw()}async importInImage(t){this.#qt&&URL.revokeObjectURL(this.#qt.src);const e=document.createElement("canvas"),s=this.canvas;e.width=s.width,e.height=s.height;const i=e.getContext("2d");let r,o,h,n=0,a=0,l=s.width,c=0,d=0,u=[];for(const e of t)h=await Lt(e),u.push(h),c<h.width&&(c=h.width),d<h.height&&(d=h.height);const g=u.map((t=>t.width)).reduce(((t,e)=>t+e),0);r=s.width/g,c*=r,d*=r;for(let t,e=0;e<u.length;++e)h=u[e],t=h.width/g,l=h.width*r,o=h.height*r,a=0,o<d&&(a+=(d-o)/2),console.log("Draw image:",n,a,l,o),i.drawImage(h,n,a,l,o),i.lineWidth=1,i.strokeStyle="#eeeeee",i.strokeRect(n,0,l,d),Xt(i,"www.sipme.io",d),URL.revokeObjectURL(h.src),n+=l;this.#qt=await Lt(e.toDataURL("image/png")),this.#Kt[1]=d/s.height,this.draw()}async save(t){if(this.#Ht.length<2)return void console.warn("Nothing to save");const e=this.#Ht.map((t=>Object.fromInstance(t,{})));console.debug(e);try{await this.#ee.put("meme",{id:t,objects:e,ts:Date.now()}),this.#de.projects&&(this.#de.projects.getElementIds().includes(t)||this.#de.projects.add({id:t,objects:this.#Ht},!0),this.#de.projects.selectItem(t)),this.#xe("save",t),this.#de.notify.add("Saved !","success")}catch(t){console.error("Failed to save project"),this.#de.notify.add("Failed !","error")}}async open(t){if(t==this.#oe)return;this.reset();const e={rect:h,label:h,bubble:n,text:s,emoji:A,image:_,path:O,arrow:L,canvas:a};try{const s=await this.#ee.get("meme",t);console.debug("Open projects",s);for(const t of this.#Ht)t.release();this.#Ht=s.objects.map((t=>Object.instanceFrom(new e[t.type],t))),this.#oe=t;const i=this.#Ht.filter((t=>"image"==t.type)),r=Object.fromArray(this.#Ht.filter((t=>"path"==t.type)));let o;await Promise.all(i.map((t=>t.image())));for(const t of i)o=t.maskPath,o&&(o=r[o],o&&t.setMask(o,!1));this.#Vt=this.#Ht[0],this.draw(),this.#xe("open",t),this.#de.projects.select(t);for(const t of this.#Ht.slice(1))this.#de.objects.add(t);this.#Vt.properties=this.#de.canvas,this.#de.actions.assign({width:this.#Vt.width,height:this.#Vt.height})}catch(t){console.error("Failed to load objects")}}async delete(t){t==this.#oe&&this.reset();try{await this.#ee.rm("meme",t),this.#xe("delete",t),this.#de.projects.delete(t)}catch(t){console.error("Failed to delete project")}}update(t,e,s=this.#p){if("string"==typeof s&&(s=this.#Ht.find((t=>t.id==s))),!s)return;const{setter:i,getter:r}=Object.getProperty(s,t);if(i)switch(r&&(this.#ce[t]||(this.#ce[t]=setTimeout((()=>{this.#ae.splice(this.#le++,this.#ae.length);const e=r.call(s),i={};i[t]=e,console.debug("Adding to history",this.#le,t,"=>",e);const o={id:s.id,values:i};this.#ae.push(o),this.#ce[t]=null}),2e3))),i.call(s,e),this.draw(),t){case"imgScale":this.#de.properties.assign({width:s.width,height:s.height,imgWidth:s.imgWidth,imgHeight:s.imgHeight});break;case"imgWidth":this.#de.properties.assign({imgHeight:s.imgHeight});break;case"imgHeight":this.#de.properties.assign({imgWidth:s.imgWidth})}}select(t){this.#ye(t)&&this.draw()}removeNode(){const t=this.#ne.shift();null!=t&&this.#p.remove(t)&&(this.#he=this.#he.filter((e=>e!=t)),this.draw())}insertNode(){let t=this.#ne[0];null!=t&&(t=this.#p.split(t),this.#he.push(t),this.draw())}copy(t){let e,s=this.#Ht.length;if("string"==typeof t){if(s=this.#Ht.findIndex((e=>e.id==t)),-1==s)return;e=this.#Ht[s]}else e=t;const i=Object.fromInstance(e),r=new e.__proto__.constructor(e);Object.instanceFrom(r,i),r.id=i.id+"_2",r.x+=10,r.y+=10,this.#Ht.splice(s+1,0,r),this.draw(),this.#de.objects.add(r,s-1)}undo(){this.#le>0&&this.#be(--this.#le,!0)}redo(){this.#le<this.#ae.length-1&&this.#be(++this.#le)}alignImages(){const t=this.#Vt.height,e=this.#Vt.width,s=this.#Ht.filter((t=>"image"==t.type)),i=s.map((t=>t.width)).sum();let r,o=this.#Vt.x,h=this.#Vt.y,n=s.map((t=>t.imgHeight)).max(),a=e/i;n*=a,h+=(t-n)/2;for(const t of s)a=t.imgHeight/t.imgWidth,r=t.width/i,t.width=r*e,t.height=a*t.width,t.imgWidth=t.width,t.imgHeight=t.height,t.height=n,t.imgY=(t.height-t.imgHeight)/2,t.x=o,t.y=h,o+=t.width,t==this.#p&&(t.properties=this.#de.properties);this.draw()}centerImage(){if(!this.#p||"image"!=this.#p.type)return;const t=this.#p,e=t.width,s=t.height,i=t.imgWidth,r=t.imgHeight;i<e&&(t.imgX=Math.round((e-i)/2)),r<s&&(t.imgY=Math.round((s-r)/2)),this.draw()}centerView(){this.#ge(!0),this.draw()}async detectBody(t){if(!this.#p||"image"!=this.#p.type)return;const e=await O.detectBody(this.#p,t);e&&(this.#C=e,this.#ve(),this.draw()),this.#de.properties.set("mask",e.name,e.id)}wrap(){this.wrapProperties("properties"),this.wrapObjects("objects","item-object"),this.wrapProjects("projects","item-project"),this.wrapCanvas("background"),this.wrapStatus("status"),this.wrapActions("actions"),this.wrapTools("tools"),this.wrapNotifications("notifications","item-notification");const t=document.body;t.ondragover=t=>t.preventDefault(),t.ondrop=t=>{t.preventDefault();const e=[];if(t.dataTransfer.items){for(const s of t.dataTransfer.items)if("file"===s.kind){const t=s.getAsFile();e.push(t)}}else t.dataTransfer.files.forEach(((t,s)=>{console.log(`… file[${s}].name = ${t.name}`),e.push(t)}));console.log("File(s) dropped",e),this.import(e)}}wrapProperties(t){return this.#de.properties=function(t,e){"string"==typeof t&&(t=document.getElementById(t));const s=Ot(t,{mode(e){e?t.setAttribute("mode",e):t.removeAttribute("mode")}});return t.oninput=t=>{let s,i,r,o=t.target;"checkbox"==o.type&&(r=o.checked,o.getAttribute("for")&&(o=o.nextElementSibling,r=r?o.value:""));const h=o.id||o.getAttribute("role");h&&([s,i]=h.split("-"),null==r&&(r=o.dataset.id||o.value),e&&e.update(i,r))},t.onclick=async t=>{const s=t.target;switch(s.name){case"center":e.centerImage();break;case"remove":e.remove();break;case"export":e.exportObject();break;case"detect":{const t=s.previousElementSibling,i=parseFloat(t.value);s.disabled=!0,await delayResolve(e.detectBody(i),2e3),s.disabled=!1}}},s}(t,this)}wrapObjects(t,e){return this.#de.objects=function(t,e,s){"string"==typeof t&&(t=document.getElementById(t));const i=t.querySelector(".list"),r=UX.List.createMixin(i);return t.onclick=t=>{const s=t.target;if("BUTTON"!=s.tagName){if(UX.List.isItem(s)){const t=s.dataset.id;e.select(t),r.selectItem(t)}}else{const t=s.closest("[data-id]");if(t){const i=t.dataset.id;switch(s.name){case"rm":e.remove(i),r.delete(i);break;case"up":e.move(i,1);break;case"down":e.move(i,-1);break;case"visible":e.update("visible","toggle",i);break;case"duplicate":e.copy(i);break;case"apply":e.applyMask(i)}}}},t.oninput=t=>{const s=t.target,i=s.closest("[data-id]");if(i){const t=i.dataset.id,r=s.innerText;e.update("name",r,t)}},r.add=function(e,i){const o=e.id;let h;if(s){if(h=r.addItemTemplate(s,e),"number"==typeof i){const t=r.area.childNodes[i];t&&dom.insertAfter(h,t)}}else h=document.createElement("span"),h.innerText=o,h.dataset.id=o,h.classList.add("item"),t.appendChild(h);return h},r.select=function(t){this.selectItem(t)},r}(t,this,e)}wrapProjects(t,e){return this.#de.projects=function(t,e,s){"string"==typeof t&&(t=document.getElementById(t));const i=t.querySelector(".list"),r=UX.List.createMixin(i);return t.onclick=t=>{const s=t.target;if("BUTTON"!=s.tagName){if(UX.List.isItem(s)){const t=s.dataset.id;r.selectItem(t),e.open(t)}}else switch(s.name){case"rm":{const t=s.closest("[data-id]");if(t){const s=t.dataset.id;e.delete(s)}}break;case"align":e.alignImages()}},r.add=function(e,i=!1){const o=e.id;let h;return s?h=r.addItemTemplate(s,e,i):(h=document.createElement("span"),h.innerText=o,h.dataset.id=o,h.classList.add("item"),t.appendChild(h)),h},r.select=function(t){this.selectItem(t)},r}(t,this,e)}wrapCanvas(t){return this.#de.canvas=function(t,e){"string"==typeof t&&(t=document.getElementById(t));const s=Ot(t);return t.oninput=t=>{let s,i,r,o=t.target;const h=o.id||o.getAttribute("role");h&&([s,i]=h.split("-"),null==r&&(r=o.value),e&&e.update(i,r,"canvas"))},s}(t,this),this.#Vt.properties=this.#de.canvas,this.#de.canvas}wrapTools(t){return this.#de.tools=function(t,e){return"string"==typeof t&&(t=document.getElementById(t)),t.onclick=t=>{const s=t.target;if("BUTTON"==s.tagName){const t=s.name;if(s.hasAttribute("selectable")){const t=s.parentElement.querySelectorAll("[selectable]");for(const e of t)e.disabled=!1;s.disabled=!0}switch(t){case"select":case"draw":case"edit":e.mode=t;break;default:e.add(t)}}},{mode(e){const s=t.querySelectorAll("[selectable]");for(const t of s)t.disabled=t.name==e}}}(t,this)}wrapStatus(t){return this.#de.status=function(t){const e={};"string"==typeof t&&(t=document.getElementById(t));const s=t.querySelectorAll("[name]");for(const t of s)e[t.name]=t;return Object.assign(e,{set(t,e){this[t]&&(this[t].value=e)},assign(t){for(const[e,s]of Object.entries(t))this.set(e,s)}}),e}(t)}wrapActions(t){return this.#de.actions=function(t,e){"string"==typeof t&&(t=document.getElementById(t));const s=t.querySelector('button[name="save"]').previousElementSibling,i=t.querySelector('input[name="zoom"]'),r=i.nextElementSibling,o=r.querySelectorAll(".dropdown-option");let h;i.addEventListener("focus",(()=>{r.style.display="block"})),document.addEventListener("click",(t=>{r.contains(t.target)||t.target===i||(r.style.display="none")})),o.forEach((t=>{t.addEventListener("click",(()=>{i.value=t.textContent,r.style.display="none",i.dispatchEvent(new Event("change",{bubbles:!0}))}))})),i.addEventListener("input",(()=>{o.forEach((t=>{t.style.display="block"}))}));const n={current:"select",mode(e){t.setAttribute("mode",e)},assign(t){for(const[e,s]of Object.entries(t))this.set(e,s)},set(e,s){if("zoom"===e)i.value=parseInt(100*s)+"%";else{const i=t.querySelector(`[name="${e}"]`);i&&(i.value=s)}}};return t.onclick=async t=>{const s=t.target;if("BUTTON"===s.tagName)switch(s.name){case"undo":e.undo();break;case"redo":e.redo();break;case"export":e.export();break;case"import":e.import();break;case"reset":e.reset();break;case"save":{const t=s.previousElementSibling.value||"test";s.disabled=!0,await delayResolve(e.save(t),2e3),s.disabled=!1}break;case"rmnode":e.removeNode();break;case"node":e.insertNode();break;case"center":e.centerView()}},t.onchange=t=>{const s=t.target,i=s.value;switch(s.name){case"height":e.height=parseInt(i);break;case"width":e.width=parseInt(i);break;case"fill":e.fill=i;break;case"stroke":e.stroke=i;break;case"strokeWidth":e.strokeWidth=parseInt(i);break;case"zoom":e.zoom=parseInt(i)/100}},t.oninput=t=>{const s=t.target;s.value,"zoom"===s.name&&(h||(h=setTimeout((()=>{h=null;const t=parseInt(i.value);console.log("Zoom change",t),e.zoom=t/100}),1200)))},e.on("open",(t=>s.value=t.detail)),n}(t,this)}wrapNotifications(t,e){return this.#de.notify=function(t,e){"string"==typeof t&&(t=document.getElementById(t));const s=UX.List.createMixin(t);return s.add=function(t,s){const i=this.addItemTemplate(e,t);i.classList.add({success:"w3-green",error:"w3-red"}[s]),setTimeout((()=>dom.removeElement(i)),3e3)},s}(t,e)}#be(t,e=!1){const{id:s,values:i}=this.#ae[t],r={},o=this.#Ht.find((t=>t.id==s));if(o){for(const[t,e]of Object.entries(i)){const{setter:s,getter:i}=Object.getProperty(o,t);i&&(r[t]=i.call(o)),s&&s.call(o,e),this.#de.properties.set(t,e)}this.draw(),e&&t==this.#ae.length-1&&this.#ae.push({id:s,values:r})}}#ye(t){let e,s;if(console.debug("## Select:",t),"string"==typeof t){if(this.#p&&t==this.#p.id)return!1;e=this.#Ht.find((e=>e.id==t))}else e=t;e&&(e.selected=!0,e.properties=this.#de.properties,s=Object.fromInstance(e));const i=this.#p!=e;return i&&(this.#p&&(this.#p.selected=!1),this.#p=e,this.#de.properties.mode(e?.type),this.#de.objects.select(e?.id),this.#xe("select",s)),i}#ue(t){const e=this.canvas;this.#Gt=[e.width/t.width,e.height/t.height],this.draw()}#ve(t=this.#C){t.closed||t.end(),this.#Ht.push(t),this.#C=null,this.#ye(t),this.#de.objects.add(t)}#ke(t,e){if(this.#ut){if(this.#p){this.#ae.splice(this.#le++,this.#ae.length);const t={id:this.#p.id,values:{x:this.#ut.x,y:this.#ut.y,width:this.#ut.width,height:this.#ut.height}};this.#ae.push(t)}return void(this.#ut=null)}let s;this.#p&&(this.#p.selected=!1);for(const i of[...this.#Ht].reverse())if(i.visible&&i.handleSelect(t,e)){s=i;break}this.select(s)}#Se(t,e){this.#ut=null;for(const s of this.#Ht)if(this.#ut=s.handleClick(t,e,"select")){this.#ut.x=s.x,this.#ut.y=s.y,this.#ut.width=s.width,this.#ut.height=s.height;break}}#Ce(t,e){if(!this.#ut)return;for(let s,i,r=1;r<this.#Ht.length;++r)if(i=this.#Ht[r],i!=this.#p&&(s=i.snap(t,e))){t=s[0],e=s[1];break}this.#ut.move(t,e),this.draw();const s=this.#p;if(s){const t={x:s.x,y:s.y,width:s.width,height:s.height,angle:s.angle};this.#de.properties.assign(t),this.#xe("update",t)}}#Te(t,e){}#Be(t,e){this.#C||(this.#C=new O),this.#C.mouseDown(t,e,this.#Qt),this.#C.closed&&this.#ve(),this.draw()}#Ie(t,e){this.#C&&(this.#C.mouseUp(t,e,this.#Qt),this.draw())}#Pe(t,e){this.#C&&(this.#C.mouseMove(t,e,this.#Qt),this.draw())}#je(t,e){this.#ut=null;for(const s of this.#he)if(this.#ut=s.handleSelect(t,e))return this.draw(),void this.#de.actions.mode("edit");this.#de.actions.mode("")}#De(t,e){this.#ut&&(this.#ut.move(t,e),this.draw())}#Ee(t,e){this.#ut&&this.#ut.control&&(this.#ut.selected?this.#ne.unshift(this.#ut):this.#ne=this.#ne.filter((t=>t!=this.#ut))),this.#ut=null}#_e(t,e){return[t*this.#Gt[0]/this.#se-this.#ie,e*this.#Gt[1]/this.#se-this.#re]}#pe(){const t=this.canvas;t.onclick=t=>{const[e,s]=this.#_e(t.offsetX,t.offsetY);switch(this.#Jt){case"select":this.#ke(e,s);break;case"draw":this.#Te(e,s);break;case"edit":this.#Ee(e,s)}},t.onmousemove=t=>{let[e,s]=this.#_e(t.offsetX,t.offsetY);switch(this.#de.status.assign({x:Math.round(e),y:Math.round(s)}),this.#Qt.Shift&&(Math.abs(e-this.#r)<Math.abs(s-this.#o)?e=this.#r:s=this.#o),this.#Jt){case"select":this.#Ce(e,s);break;case"draw":this.#Pe(e,s);break;case"edit":this.#De(e,s)}},t.onmousedown=t=>{const[e,s]=this.#_e(t.offsetX,t.offsetY);switch(this.#r=e,this.#o=s,this.#Jt){case"select":this.#Se(e,s);break;case"draw":this.#Be(e,s);break;case"edit":this.#je(e,s)}},t.onmouseup=t=>{const[e,s]=this.#_e(t.offsetX,t.offsetY);"draw"===this.#Jt&&this.#Ie(e,s)},t.onmouseenter=t=>{this.#te=!0},t.onmouseleave=t=>{this.#te=!1},t.onkeydown=t=>{const e=t.key;if("draw"==this.#Jt)switch(e){case"Enter":this.#C&&this.#ve();case"Escape":return this.#C=null,void this.draw();case"Backspace":return void(this.#C&&(this.#C.undo(),this.draw()))}if(this.#p&&e.startsWith("Arrow")){switch(e.substr(5)){case"Up":this.#p.y-=5;break;case"Down":this.#p.y+=5;break;case"Left":this.#p.x-=5;break;case"Right":this.#p.x+=5}this.draw()}else switch(e){case"s":this.mode="select";break;case"e":this.mode="edit";break;case"d":this.mode="draw";break;case"r":this.add("rect");break;case"b":this.add("bubble");break;case"t":this.add("text")}},window.onwheel=t=>{this.#te&&(this.#Qt.Control?(t.deltaY<0?this.#se+=.1:this.#se-=.1,this.#ge(),this.#de.actions.set("zoom",this.#se)):this.#Qt.Shift?t.deltaY<0?this.#ie-=30:this.#ie+=30:t.deltaY<0?this.#re-=30:this.#re+=30,this.draw())},window.onkeydown=t=>{const e=t.key;["Control","Shift"].includes(e)&&(this.#Qt[e]=!0)},window.onkeyup=t=>{const e=t.key;["Control","Shift"].includes(e)&&delete this.#Qt[e]}}#me(){new ResizeObserver((t=>this.#ue(t[0].contentRect))).observe(this.canvas)}#xe(t,e){this.dispatchEvent(new CustomEvent(t,{detail:e}))}async#fe(){const t=await this.#ee.latest("meme");console.debug("Projects loaded",t);for(const e of t)this.#de.projects&&this.#de.projects.add(e);this.#xe("projects",t)}#ge(t=!1){const e=this.canvas.width,s=this.canvas.height,i=e*this.#se,r=s*this.#se;(this.#se<=1||t)&&(this.#ie=(e-i)/2,this.#re=(s-r)/2),this.#de.status.set("zoom",this.#se.toFixed(2))}async#we(t,s,i){if(showSaveFilePicker){const e={types:[{description:"Image file",accept:{"image/*":[".png",".jpeg",".jpg",".svg"]},suggestedName:"meme.jpeg",startIn:"pictures"}]},s=await showSaveFilePicker(e);let i,[,r]=s.name.split(".");"jpg"==r&&(r="jpeg");const o="image/"+r,h=await s.createWritable();if("svg"==r){let t=`<svg width="${this.#Vt.width}" height="${this.#Vt.height}" xmlns="http://www.w3.org/2000/svg"><defs>`,e="";for(const s of this.#Ht)t+=s.toSVGFilter(),e+=s.toSVG();t+="</defs>"+e+"</svg>",i=t}else i=await new Promise((e=>t.toBlob(e,o)));await h.write(i),await h.close()}else{const t=e.toDataURL("image/"+i),r=document.createElement("a");r.download=s+"."+i,r.href=t,r.click()}}}function Lt(t){return new Promise(((e,s)=>{const i=new Image;i.src=t instanceof Blob?URL.createObjectURL(t):t,i.onload=()=>e(i),i.onerror=s}))}function Xt(t,e,s=t.canvas.height){const i=t.canvas.width,r=i/50,o=.01*i,h=s-o;t.save(),t.fillStyle="#888",t.textBaseline="middle",t.textAlign="left",t.font=`bold ${r}px monospace`,t.fillText(e,o,h),t.restore()}class Yt extends X{get name(){return"meme"}get version(){return 1}onUpgrade(t,e,s){0===s&&(Yt.addTable(t,"meme"),Yt.addIndex("meme","ts",e))}}})(),r.default})()));